---
title: "Статистическое моделирование стресс-тестирования операционного риска с использованием двух подходов: регрессионной модели и модели исторической симуляции на языке программирования R (версия 3.0)"
author: "Имир Османов"
date: "`r Sys.Date()`"
output:
  pdf_document:
    latex_engine: xelatex
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
    includes:
      in_header: preamble.tex
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
  word_document:
    toc: yes
    toc_depth: 3
    fig_caption: yes
geometry: a4paper, left=0.5in, right=0.5in, top=0.5in, bottom=0.5in
fontsize: 10pt
lang: ru
header-includes:
  - \usepackage{polyglossia}
  - \setdefaultlanguage{russian}
  - \setmainfont{Times New Roman}
  - \newfontfamily\cyrillicfonttt{Courier New}
  - \usepackage{booktabs}
  - \usepackage{xcolor}
  - \usepackage{longtable}
  - \usepackage{titling}
  - \usepackage{etoolbox}
  - \pretitle{\begin{center}\large}
  - \posttitle{\par\end{center}\vspace{1em}}
  - \preauthor{\begin{center}\large}
  - \postauthor{\par\end{center}\vspace{1em}}
  - \predate{\begin{center}\large}
  - \postdate{\par\end{center}\vspace{2em}\newpage}
---









# Введение

Стресс-тестирование потерь от операционного риска (прогнозирование) осуществляется с использованием двух подходов к моделированию:

Регрессионная модель – включает линейную регрессию и обобщённую аддитивную модель (GAM) для оценки суммы потерь (влияния/серьёзности), а также модель Пуассона для оценки частоты (количества) событий операционного риска.

Модель исторического моделирования – предполагает расчёт Value-at-Risk (VaR) по операционному риску с использованием симуляции Монте-Карло.

Все расчёты и моделирование выполнены на языке программирования R. Методология основана на адаптации стресс-тестирования, разработанного Федеральной резервной системой США в рамках закона Додда-Франка (https://www.federalreserve.gov/supervisionreg/dfa-stress-tests-2025.htm).

Исторические данные о потерях от операционного риска получены из пакета R OpVaR (в настоящее время архивирован). Поскольку валюта потерь не указана, предполагается, что суммы выражены в долларах США. Эти данные используются во всех расчётах в данном документе.

Статистика по банкам второго уровня Казахстана взята с сайта Национального банка Республики Казахстан (www.nationalbank.kz), а макроэкономические данные по Казахстану — из пакета AFR для R.

Проект предназначен исключительно для учебных целей и демонстрации навыков программирования на языке R и статистического моделирования. Он не предназначен для предоставления финансовых прогнозов, выводов или методологических рекомендаций.

Примечание: Данные о потерях от операционного риска, использованные в данном проекте, не отражают реальное состояние банковского сектора Казахстана и его подверженность операционным рискам.

# Краткое содержание
## Цель:
Цель данного анализа — применение статистических методов для стресс-тестирования операционного риска с использованием двух подходов к моделированию:

Регрессионная модель (макроэкономическая модель) – включает различные регрессионные техники, такие как множественная линейная регрессия, обобщённая аддитивная модель (GAM) и множественная регрессия Пуассона, для моделирования влияния макроэкономических факторов на потери от операционного риска.

Модель исторического моделирования – предполагает расчёт Value-at-Risk (VaR) по операционному риску с использованием симуляции Монте-Карло.

Исследование направлено на разработку методологии стресс-тестирования операционного риска с использованием автоматизации на языке программирования R для повышения эффективности и воспроизводимости анализа.

## Основные обнаружения:
Стресс-тестирование операционного риска проводилось с использованием следующих подходов:

Прогнозирование серьезности убытков (Severity): для прогнозирования величины потерь использовались множественная линейная регрессия (MLR) и обобщённая аддитивная модель (GAM).

Прогнозирование частоты событий (Frequency): для оценки частоты (количества) событий операционного риска применялась множественная регрессия Пуассона. 
В качестве критериев оценки использовались статистический порог R^2 = 0.35 (35%) и уровень значимости альфа = 0.1 (доверие 90%).

Оценка Value-at-Risk (VaR): для оценки Value-at-Risk по операционному риску использовалась симуляция Монте-Карло на уровнях доверия 95%, 99% и 99.9%.

**Оптимальная модель для прогнозирования серьезности убытков**

Оптимальная модель была выбрана из 1,330 возможных комбинаций независимых макроэкономических переменных на основе наивысшего значения R^2 (коэффициента детерминации) и статистических тестов. Наиболее эффективная модель для прогнозирования величины (серьезности) убытков от операционного риска была определена с использованием следующих независимых переменных из набора данных пакета "AFR":

GDD_Trn_R_y: Реальный валовой добавленный продукт для транспорта

GDD_Inf_R_y: Реальный валовой добавленный продукт для информации

Rincpop_q_y: Реальный средний месячный доход на душу населения

Зависимой переменной являлась доля общих убытков от операционного риска в активах банка "X", которые принимались за общие активы банковской системы.

**Частота потерь**

Для оценки частоты потерь была использована множественная регрессия Пуассона. Результаты показали, что множественная регрессия Пуассона обеспечила разумные предсказания, при этом множественная регрессия с отрицательным биномиальным распределением показала схожие результаты. В качестве статистического порога был установлен уровень R^2 на 0.35 (35%) и уровень значимости альфа на 0.1 (90% доверие).

Лучшая модель для прогнозирования частоты потерь была определена с использованием множественной регрессии Пуассона с следующими независимыми переменными:

- ruktzt: курс обмена RUB/KZT
- Rincpop_q_y: реальный средний месячный доход на душу населения
- GDD_R_y: реальный валовый добавленный продукт

Зависимой переменной была общая частота потерь операционного риска для банка "X". Псевдозначение R^2 для этой модели составило 0.48 (r2ML, r2CU), при этом все p-значения были ниже порога 0.1. Таким образом, нулевая гипотеза (H0) была отвергнута в пользу альтернативной гипотезы (Ha), что подтверждает корреляцию между частотой потерь операционного риска и макроэкономическими переменными.


**Анализ корреляции**

Во всех моделях была зафиксирована отрицательная корреляция между независимыми и зависимыми переменными.

**Прогнозируемые результаты**

**Множественная линейная регрессия (Тяжесть потерь)**

**Позитивный сценарий:**

- Наибольший убыток: KZT 46,228,220
- Наименьший убыток: KZT 36,771,242

**Негативный сценарий:**

- Наибольший убыток: KZT 54,684,134
- Наименьший убыток: KZT 52,068,502

**Обобщенная аддитивная модель (Тяжесть потерь)**

**Позитивный сценарий:**

- Наибольший убыток: KZT 27,999,022
- Наименьший убыток: KZT 25,739,693

**Негативный сценарий:**

- Наибольший убыток: KZT 63,592,518
- Наименьший убыток: KZT 61,240,187

**Множественная регрессия Пуассона (Частота потерь)**

**Позитивный сценарий:**

- Наибольшая частота: 3,101
- Наименьшая частота: 568

**Негативный сценарий:**

- Наибольшая частота: 162
- Наименьшая частота: 115

**Модель исторической симуляции**

**Вычисление стоимости под риском (VaR) операционного риска**
Стоимость под риском операционного риска (VaR) была вычислена с использованием распределения Пуассона для моделирования частоты (количества) событий операционного риска и распределений Вейбулла и логнормального распределения для моделирования тяжести (влияния) событий операционного риска. Эти распределения были выбраны на основе результатов статистической оценки.

**Ежемесячные ожидаемые потери (EL)**
Ожидаемые потери (EL), представляющие математическое ожидание, составили KZT 13,512,161 для среднего значения и KZT 12,173,884 для медианного значения. Эти значения оставались постоянными на всех уровнях доверия (75%, 95%, 99% и 99.9%).

**Ежемесячная стоимость под риском операционного риска (VaR)**
- На уровне доверия 95% ежемесячный VaR составил KZT 26,360,656, с непредвиденными потерями (UL) KZT 12,848,494 для среднего значения и KZT 14,186,771 для медианного значения.
- На уровне доверия 99% ежемесячный VaR увеличился до KZT 35,823,119, с непредвиденными потерями (UL) KZT 22,310,958 для среднего значения и KZT 23,649,235 для медианного значения.
- На уровне доверия 99.9% ежемесячный VaR составил KZT 52,619,586, с непредвиденными потерями (UL) KZT 39,107,424 для среднего значения и KZT 40,445,701 для медианного значения.

**Ежеквартальные ожидаемые потери (EL)**
Ожидаемые потери (EL) были масштабированы линейно во времени путем умножения ежемесячных EL на 3. В результате ежеквартальные EL составили KZT 40,536,484 для среднего значения и KZT 36,521,653 для медианного значения, оставаясь одинаковыми на всех уровнях доверия.

**Ежеквартальная стоимость под риском операционного риска (VaR)**
Ежеквартальный VaR был вычислен путем умножения ежемесячного VaR на квадратный корень из 3.

- На уровне доверия 95% ежеквартальный VaR составил KZT 45,657,995, с непредвиденными потерями (UL) KZT 5,121,511 для среднего значения и KZT 9,136,341 для медианного значения.
- На уровне доверия 99% ежеквартальный VaR увеличился до KZT 62,047,463, с непредвиденными потерями (UL) KZT 21,510,979 для среднего значения и KZT 25,525,810 для медианного значения.
- На уровне доверия 99.9% ежеквартальный VaR составил KZT 91,139,796, с непредвиденными потерями (UL) KZT 50,603,312 для среднего значения и KZT 54,618,143 для медианного значения.

**Оценки потерь операционного риска**
Окончательные оценки потерь операционного риска были получены как среднее значение прогнозов двух подходов моделирования: 1) Регрессионная модель и 2) Модель исторической симуляции, и следующие:


#### Среднее значение Множественной линейной регрессии (Тяжесть потерь) и Монте-Карло симуляции (уровни доверия 95% и 99.9%)

**Позитивный сценарий:**

- Наибольший убыток: KZT 45,943,965
- Наименьший убыток: KZT 41,214,107

**Негативный сценарий:**

- Наибольший убыток: KZT 72,911,965
- Наименьший убыток: KZT 71,604,149

#### Среднее значение Обобщенной аддитивной модели (Тяжесть потерь) и Монте-Карло симуляции (уровни доверия 95% и 99.9%)

**Позитивный сценарий:**

- Наибольший убыток: KZT 36,828,508
- Наименьший убыток: KZT 35,698,844

**Негативный сценарий:**

- Наибольший убыток: KZT 77,366,157
- Наименьший убыток: KZT 76,189,991

## Заключительные выводы

Результаты данного стресс-тестирования следует интерпретировать с осторожностью, так как некоторые предположения моделирования, такие как линейность и нормальность в регрессионных моделях, не были полностью выполнены. Тем не менее, несмотря на эти ограничения, результаты предоставляют значимые выводы о взаимосвязи между потерями операционного риска и макроэкономическими переменными, что способствует усилиям по оценке рисков и их смягчению.

## Методология:
Методология моделирования потерь операционного риска состоит из двух ключевых подходов:

- **Регрессионные модели** – включает Множественную линейную регрессию и нелинейные модели, такие как полиномиальная регрессия и Обобщенная аддитивная модель (GAM) для прогнозирования тяжести (влияния) потерь, а также Множественную регрессию Пуассона для оценки частоты (количества) событий операционного риска. Оптимальная регрессионная модель была выбрана из 1,330 возможных комбинаций независимых макроэкономических переменных на основе наивысшего значения R^2 (коэффициент детерминации) и статистической валидации. Также модель успешно прошла статистические тесты на мультиколлинеарность и стационарность.

- **Модель исторической симуляции** – Оценка стоимости под риском операционного риска (VaR) была проведена с использованием симуляции Монте-Карло.

Прогнозирование потерь операционного риска было выполнено с использованием коэффициентов, полученных из регрессионных моделей. Суммы потерь были выражены как пропорция от общих потерь операционного риска относительно общих активов, причем данные об общих активах были взяты из "Общих активов" всех банков второго уровня Казахстана. Данные о потерях и частотах операционного риска были получены из пакета R "OpVaR".

Эта методология основывается на методологии стресс-тестирования, предусмотренной Законом о реформе финансового регулирования Додда-Франка Федеральной резервной системой, который предполагает, что оценки потерь операционного риска должны быть получены как среднее значение проекций из двух подходов моделирования: линейной регрессионной модели и модели исторической симуляции. Регрессионная модель фиксирует чувствительность потерь операционного риска к колебаниям макроэкономических переменных, в то время как модель исторической симуляции учитывает вариации потерь в зависимости от различных типов событий операционного риска.

## Рекомендации:
Несмотря на трудности в нахождении прямой взаимосвзязи между финансовыми данными отдельной компании с национальными макроэкономическими переменными, рекомендуется провести дальнейшие исследования для изучения взаимосвязей между макроэкономическими факторами и конкретными категориями операционного риска. Регрессионные модели могут быть использованы для выявления потенциальных связей, особенно для следующих категорий операционного риска в рамках Базель II:

1. Внутреннее мошенничество

2. Внешнее мошенничество

3. Практики трудовой занятости и безопасность на рабочем месте

4. Клиенты, продукты и бизнес-практики

5. Исполнение, доставка и управление процессами

6. Сбои в бизнесе и системные сбои

7. Повреждение физических активов
(Примечание: повреждение физических активов, как ожидается, не покажет значимой связи с макроэкономическими переменными).

# Анализ зависимых и независимых (макроэкономических) переменных
## Импорт необходимых пакетов R:

```{r message=FALSE, warning=FALSE}
# Импорт необходимых пакетов R:
library(AFR)
library(tidyverse)
library(ggplot2)
library(readxl)
library(corrplot)
library(lubridate)
library(scales)
library(zoo)
library(combinat)
library(car)
library(lmtest)
library(tseries)
library(MASS)
library(dplyr)
library(ggfortify)
library(GGally)
library(glm2)
library(pscl)
library(MASS)
library(ggpubr)
library(mgcv)
library(knitr)
library(kableExtra)
library(extraDistr)
library(fitdistrplus)
library(nortest)
library(readr)
library(showtext)
library(sysfonts)
# Настройка шрифта на русском языке
font_add("Times New Roman", 
         regular = "C:/Windows/Fonts/times.ttf")
showtext_auto()
theme_set(theme_minimal(base_family = "Times New Roman"))
```

## Анализ зависимых переменных

### Статистика банковской отрасли

#### Загрузка статистики банковской отрасли

```{r warning=FALSE}
# Загрузка данных банковской статистики
banking_stats <- read_csv("C:/Users/user/Documents/Imir/My Data Analysis Projects/Data/bank_stats_2010_2023.csv",
                         show_col_types = FALSE)
# Преобразование в датафрейм
banking_stats <- as.data.frame(banking_stats)

# Просмотр первых и последних строк
head(banking_stats)
tail(banking_stats)

```
```{r}
# Проверка датафреймов  на типы данных и размер
summary(banking_stats)
str(banking_stats)
```
**Обнаружения:** Статистика банковской отрасли отражает значение общих активов банков второго уровня. Всего было зафиксировано 168 наблюдений за период с 1 января 2010 года по 1 декабря 2023 года.


```{r}
# Проверка на пропущенные значения
cat("\nПропущенные значения по столбцам:\n")
missing_values <- colSums(is.na(banking_stats))
print(missing_values)

# Проверка на дублирующиеся строки
cat("\nДублирующиеся строки:\n")
duplicated_rows <- banking_stats[duplicated(banking_stats), ]
if (nrow(duplicated_rows) > 0) {
  print(duplicated_rows)
} else {
  cat("Дублирующихся строк не найдено.\n")
}

```
**Обнаружения:** В датафрейме с банковской статистикой нет пропущенных или дублирующихся значений.

#### Предварительная обработка данных

```{r}
# Удаление столбца "File Name"
banking_stats <- banking_stats %>% dplyr::select(-`File Name`)
```

```{r}
# Переименование столбца "Sheet Name" в "Date"
banking_stats <- banking_stats %>% 
  rename(Date = `Sheet Name`)

# Проверка структуры данных
str(banking_stats)

```
```{r}
# Изменение типов данных столбцов "Date" и "Value"
banking_stats$Date <- as.Date(banking_stats$Date, format = "%d.%m.%Y")
banking_stats$Value <- as.numeric(banking_stats$Value)

# Проверка структуры данных
str(banking_stats)

```
```{r}
# Проверка датафрейма
head(banking_stats)
tail(banking_stats)


```
```{r}
# Фильтрация датафрейма для включения данных только за 3, 6, 9 и 12 месяцев 
# или 1-й, 2-й, 3-й и 4-й кварталы.
banking_stats$Date <- as.Date(banking_stats$Date)
banking_stats_filtered <- banking_stats %>% 
  filter(format(Date, "%m") %in% c("03", "06", "09", "12"))

```

```{r}
# Проверка датафрейма
str(banking_stats_filtered)
head(banking_stats_filtered)
tail(banking_stats_filtered)

```
**Обнаружения:** Столбец "Value" имеет тип данных "character" и требует корректировки.

```{r}
# Создание нового столбца для 'Value (Billion)'
# Преобразование столбца 'Value' в числовой тип
banking_stats_filtered$Value <- as.numeric(banking_stats_filtered$Value)

# Выполнение деления для создания столбца 'Value (Billion)'
banking_stats_filtered$`Value_billion` <- banking_stats_filtered$Value / 1000000000
```

```{r}
# Проверка датафрейма
str(banking_stats_filtered)
head(banking_stats_filtered)
```
#### Анализ статистики банковской отрасли

```{r}
# Анализ данных в датафрейме
glimpse(banking_stats_filtered)
summary(banking_stats_filtered)
```
**Обнаружения:** Минимальное значение в датафрейме составляет 11,75 млрд KZT, среднее значение — 24,07 млрд KZT, а максимальное значение — 49,17 млрд KZT.


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание линейного графика
ggplot(banking_stats_filtered, aes(x = Date, y = `Value_billion`)) +
  geom_line() + 
  geom_point() +  
  labs(
    x = 'Год',
    y = 'Всего активов (Миллиарды тенге)',
    title = 'Всего активов банковской системы'
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
**Обнаружения:** Общие активы банковской отрасли Казахстана демонстрируют стабильный и быстрый рост с течением времени, при этом не наблюдается значительных спадов.


### Убытки от операционных рисков

#### Загрузка данных по операционным рискам

#### Операционный риск тип 1


```{r}
# Загрузка необходимых файлов
# Потери от операционного риска типа 1
or_type1 <- read_excel("C:\\Users\\user\\Documents\\Imir\\My Data Analysis Projects\\Data\\file1.xlsx")
or_type1 <- as.data.frame(or_type1)
head(or_type1)
tail(or_type1)
```
#### Исследовательский анализ данных о потерях от операционного риска типа 1
```{r}
# Проверка на пропущенные значения
cat("\nОтсутствующие значения в каждом столбце:\n")
missing_values <- colSums(is.na(or_type1))
print(missing_values)

# Проверка на дублированные строки
cat("\nДублированные строки:\n")
duplicated_rows <- or_type1[duplicated(or_type1), ]
if (nrow(duplicated_rows) > 0) {
  print(duplicated_rows)
} else {
  cat("Дублированные строки не найдены.\n")
}
```
**Обнаружения:** В данных по Операционным рискам типа 1 нет пропущенных или дублированных значений.

```{r}
# Исследовательский анализ данных
summary(or_type1)
glimpse(or_type1)
str(or_type1)
```
**Обнаружения:** Датафрейм содержит 1 965 наблюдений для операционного риска типа 1, при этом все столбцы имеют соответствующие типы данных. Описательная статистика для набора данных следующая:

Минимальное значение: 5 USD

Среднее значение: 1 017 USD

Медиана: 760 USD

Максимальное значение: 6 382 USD.

#### Визуализация операционного риска типа 1

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения потерь операционного риска типа 1
ggplot(data = or_type1, mapping = aes(x = Loss)) +
  geom_histogram(binwidth = 50, 
                 fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Гистограмма операционного риска типа 1", 
       x = "Сумма убытка (доллар США)", y = "Частота") +
  theme_bw()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения потерь операционного риска типа 1
ggplot(data = or_type1, mapping = aes(x = Loss)) +
  geom_boxplot(fill = "blue", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот операционного риска типа 1", 
       x = "Сумма потерь (доллар США)") +
  theme_bw()

```
**Обнаружения:** Гистограмма и боксплот показывают наличие выбросов, что дополнительно подтверждается значительным различием между средним и медианой.

#### Предобработка данных для операционного риска типа 1


```{r}
# Извлечение выбросов из датафрейма
Quartile_1 <- quantile(or_type1$Loss, 0.25) 
Quartile_3 <- quantile(or_type1$Loss, 0.75) 
IQR <- Quartile_3 - Quartile_1                 
lower_bound <- Quartile_1 - 1.5 * IQR         
upper_bound <- Quartile_3 + 1.5 * IQR        

# Идентификация выбросов
outliers_loss_1 <- or_type1$Loss[or_type1$Loss < lower_bound | or_type1$Loss > upper_bound]

# Вывод выбросов
print("Выбросы (метод IQR):")
print(outliers_loss_1)

```
```{r}
# Фильтрация датафрейсв для исключения выбросов

or_type1_cleaned <- or_type1[or_type1$Loss >= lower_bound & 
                               or_type1$Loss <= upper_bound, ]

# Вывод очищенного датафрейма
print("Датафрейм после удаления выбросов:")
head(or_type1_cleaned)
str(or_type1_cleaned)
```
```{r}
# Исследовательский анализ данных
str(or_type1_cleaned)
summary(or_type1_cleaned)
```
**Обнаружения:** В датафрейме для операционного риска типа 1 содержится 1,892 наблюдения. Все столбцы имеют соответствующие типы данных. Описательная статистика следующая: минимальное значение — 5 USD, среднее — 911 USD, медиана — 716 USD, максимальное значение — 3,029 USD. Данные очищены от выбросов.


#### Визуализация операционного риска типа 1 после очистки от выбросов

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения потерь операционного риска типа 1

ggplot(data = or_type1_cleaned, mapping = aes(x = Loss)) +
  geom_histogram(binwidth = 50, 
                 fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Гистограмма ОР типа 1 после очистки от выбросов", 
       x = "Сумма убытка (доллар США)", y = "Частота") +
  theme_bw()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения потерь операционного риска типа 1
ggplot(data = or_type1_cleaned, mapping = aes(x = Loss)) +
  geom_boxplot(fill = "blue", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот ОР типа 1 после очистки от выбросов", 
       x = "Сумма убытка (доллар США)") +
  theme_bw()
```
**Обнаружения:** Гистограмма и боксплот свидетельствуют об отсутствии значительных выбросов, что дополнительно подтверждается минимальным различием между средним и медианой.


```{r}
# Извлечение 'Года' и 'Месяца' из столбца 'Дата'
or_type1_cleaned$Year <- year(or_type1_cleaned$Date)
or_type1_cleaned$Month <- month(or_type1_cleaned$Date)

# Группировка по 'Году' и 'Месяцу', суммирование столбца 'Потери'
or_loss_type1_monthly <- or_type1_cleaned %>%
  group_by(Year, Month) %>%
  summarise(Loss_1 = sum(Loss, na.rm = TRUE), .groups = "drop")
```

```{r}
# Вывод первых 5 строк
head(or_loss_type1_monthly)

# Вывод последних 5 строк
tail(or_loss_type1_monthly)

str(or_loss_type1_monthly)
```
```{r}
# Создание столбца 'Month_Group' на основе заданных интервалов месяцев 
# (3, 6, 9, 12 месяцев)
or_loss_type1_monthly$Month_Group <- case_when(
  or_loss_type1_monthly$Month %in% c(1, 2, 3) ~ "Q1",
  or_loss_type1_monthly$Month %in% c(4, 5, 6) ~ "Q2",
  or_loss_type1_monthly$Month %in% c(7, 8, 9) ~ "Q3",
  or_loss_type1_monthly$Month %in% c(10, 11, 12) ~ "Q4",
  TRUE ~ "Other"
)

# Группировка по 'Году' и 'Month_Group', суммирование столбца 'Loss_1'
grouped_by_month_type1 <- or_loss_type1_monthly %>%
  group_by(Year, Month_Group) %>%
  summarise(Total_Loss_1 = sum(Loss_1, na.rm = TRUE), .groups = "drop")
```

```{r}
# Проверка результатов
head(grouped_by_month_type1)
tail(grouped_by_month_type1)
```
```{r}
# Создание столбца 'Year-Quarter' в формате "YYYY-QX"
grouped_by_month_type1$Year_Quarter <- paste0(grouped_by_month_type1$Year, 
                                              "-Q", gsub("Q", "", 
                                                         grouped_by_month_type1$Month_Group))

# Проверка результатов
head(grouped_by_month_type1)

```
```{r}
# Удаление столбцов 'Year' и 'Month_Group' и 
# изменение порядка оставшихся столбцов
or_loss_type1_quarterly <- grouped_by_month_type1 %>% 
  dplyr::select(Year_Quarter, Total_Loss_1)
```

```{r}
# Проверка датафрейма
head(or_loss_type1_quarterly)
```

#### Операционный риск тип 2


```{r}
# Загрузка необходимых файлов
# Потери операционного риска типа 2
or_type2 <- read_excel("C:\\Users\\user\\Documents\\Imir\\My Data Analysis Projects\\Data\\file2.xlsx")
head(or_type2)
tail(or_type2)
```
#### Исследовательский анализ данных операционного риска типа 2

```{r}
# Проверка на пропущенные значения
cat("\nПропущенные значения в каждом столбце:\n")
missing_values <- colSums(is.na(or_type2))
print(missing_values)

# Проверка на дублированные строки
cat("\nДублированные строки:\n")
duplicated_rows <- or_type2[duplicated(or_type2), ]
if (nrow(duplicated_rows) > 0) {
  print(duplicated_rows)
} else {
  cat("Дублированные строки не найдены.\n")
}
```
**Обнаружения:** В операционном риске типа 2 нет отсутствующих или дублированных значений.


```{r}
# Исследовательский анализ данных
summary(or_type2)
glimpse(or_type2)
str(or_type2)
```
**Обнаружения:** Датафрейм для операционного риска типа 2 содержит 2,025 наблюдений. Все столбцы имеют соответствующие типы данных. Описательная статистика следующая: минимальное значение — 3 USD, среднее — 1,139 USD, медиана — 850 USD, максимальное значение — 6,213 USD.


#### Визуализация операционного риска типа 2

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения потерь операционного риска типа 2
ggplot(data = or_type2, mapping = aes(x = Loss)) +
  geom_histogram(binwidth = 50, fill = "red", 
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма операционного риска типа 2", 
       x = "Сумма убытка (доллар США)", y = "Частота") +
  theme_bw()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения потерь операционного риска типа 2
ggplot(data = or_type2, mapping = aes(x = Loss)) +
  geom_boxplot(fill = "red", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот операционного риска типа 2", 
       x = "Сумма убытка (доллар США)") +
  theme_bw()
```
**Обнаружения:** Гистограмма и боксплот указывают на наличие выбросов, что подтверждается значительным различием между средним и медианой.

#### Предобработка данных для операционного риска типа 2


```{r}
# Извлечение выбросов из датафрейма
Quartile_1 <- quantile(or_type2$Loss, 0.25) 
Quartile_3 <- quantile(or_type2$Loss, 0.75) 
IQR <- Quartile_3 - Quartile_1                 
lower_bound <- Quartile_1 - 1.5 * IQR       
upper_bound <- Quartile_3 + 1.5 * IQR         

# Идентификация выбросов
outliers_loss_2 <- or_type2$Loss[or_type2$Loss < lower_bound | or_type2$Loss > upper_bound]

# Вывод выбросов
print("Выбросы (метод IQR):")
print(outliers_loss_2)
```
```{r}
# Фильтрация датафрейма для исключения выбросов
or_type2_cleaned <- or_type2[or_type2$Loss >= lower_bound & 
                               or_type2$Loss <= upper_bound, ]

# Вывод очищенного датафрейма
print("Набор данных после удаления выбросов:")

head(or_type2_cleaned)
str(or_type2_cleaned)
```
```{r}
# Исследовательский анализ данных
str(or_type2_cleaned)
summary(or_type2_cleaned)
```
**Обнаружения:** Датафрейм для операционного риска типа 2 содержит 1,946 наблюдений. Все столбцы имеют соответствующие типы данных. Описательная статистика следующая:
Минимальное значение: 3 доллар США
Среднее: 1,016.5 доллар США
Медиана: 806 доллар США
Максимальное значение: 3,424 доллар США
Данные были очищены от выбросов.


#### Визуализация операционного риска типа 2 после очистки от выбросов

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения потерь операционного риска тип 2
ggplot(data = or_type2_cleaned, mapping = aes(x = Loss)) +
  geom_histogram(binwidth = 50, fill = "red", 
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма ОР типа 2 после очистки от выбросов", 
       x = "Сумма убытков (доллар США)", y = "Частота") +
  theme_bw()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения потерь операционного риска типа 2
ggplot(data = or_type2_cleaned, mapping = aes(x = Loss)) +
  geom_boxplot(fill = "red", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот ОР типа 2 после очистки от выбросов", 
       x = "Сумма убытков (доллар США)") +
  theme_bw()
```
**Обнаружения:** Гистограмма и боксплот свидетельствуют об отсутствии значительных выбросов, что подтверждается минимальным различием между средним и медианой.


```{r}
# Извлечение 'Года' и 'Месяца' из столбца 'Дата'
or_type2_cleaned$Year <- year(or_type2_cleaned$Date)
or_type2_cleaned$Month <- month(or_type2_cleaned$Date)

# Группировка по 'Году' и 'Месяцу', суммирование столбца 'Потери'
or_loss_type2_monthly <- or_type2_cleaned %>%
  group_by(Year, Month) %>%
  summarise(Loss_2 = sum(Loss, na.rm = TRUE), .groups = "drop")
```

```{r}
# Вывод первых 5 строк
head(or_loss_type2_monthly)

# Вывод последних 5 строк
tail(or_loss_type2_monthly)

str(or_loss_type2_monthly)
```
```{r}
# Создание столбца 'Month_Group' на основе заданных интервалов месяцев 
# (3, 6, 9, 12 месяцев)

or_loss_type2_monthly$Month_Group <- case_when(
  or_loss_type2_monthly$Month %in% c(1, 2, 3) ~ "Q1",
  or_loss_type2_monthly$Month %in% c(4, 5, 6) ~ "Q2",
  or_loss_type2_monthly$Month %in% c(7, 8, 9) ~ "Q3",
  or_loss_type2_monthly$Month %in% c(10, 11, 12) ~ "Q4",
  TRUE ~ "Other"
)

# Группировка по 'Году' и 'Month_Group', суммирование столбца 'Loss_1'
grouped_by_month_type2 <- or_loss_type2_monthly %>%
  group_by(Year, Month_Group) %>%
  summarise(Total_Loss_2 = sum(Loss_2, na.rm = TRUE), .groups = "drop")
```

```{r}
# Проверка результатов
head(grouped_by_month_type2)
tail(grouped_by_month_type2)
```
```{r}
# Создание столбца 'Year-Quarter' в формате "YYYY-QX"
grouped_by_month_type2$Year_Quarter <- paste0(grouped_by_month_type2$Year, 
                                              "-Q", gsub("Q", "", 
                                                         grouped_by_month_type2$Month_Group))

# Проверка результатов
head(grouped_by_month_type2)

```
```{r}
# Удаление столбцов 'Year' и 'Month_Group' и изменение порядка оставшихся столбцов
or_loss_type2_quarterly <- grouped_by_month_type2 %>% 
  dplyr::select(Year_Quarter, Total_Loss_2)
```

```{r}
# Проверка датафрейма
head(or_loss_type2_quarterly)
```


#### Операционный риск тип 3

```{r}
# Загрузка необходимых файлов
# Потери операционного риска типа 3
or_type3 <- read_excel("C:\\Users\\user\\Documents\\Imir\\My Data Analysis Projects\\Data\\file3.xlsx")
head(or_type3)
tail(or_type3)
```
#### Исследовательский анализ данных операционного риска типа 3

```{r}
# Проверка на пропущенные значения
cat("\nПропущенные значения в каждом столбце:\n")
missing_values <- colSums(is.na(or_type3))
print(missing_values)

# Проверка на дублированные строки
cat("\nДублированные строки:\n")
duplicated_rows <- or_type3[duplicated(or_type3), ]
if (nrow(duplicated_rows) > 0) {
  print(duplicated_rows)
} else {
  cat("Дублированные строки не найдены.\n")
}
```
**Обнаружения:** В операционном риске типа 3 нет отсутствующих и дублированных значений.


```{r}
# Исследовательский анализ данных
summary(or_type3)
glimpse(or_type3)
str(or_type3)
```
**Обнаружения:** Набор данных для операционного риска тип 3 содержит 1,995 наблюдений. Все столбцы имеют соответствующие типы данных. Описательная статистика следующая:
Минимальное значение: 48 долларов США
Среднее: 1,052 долларов США
Медиана: 788 долларов США
Максимальное значение: 12,092 долларов США.


#### Визуализация операционного риска типа 3

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения потерь операционного риска типа 3
ggplot(data = or_type3, mapping = aes(x = Loss)) +
  geom_histogram(binwidth = 50, fill = "green", 
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма операционного риска типа 3", 
       x = "Сумма убытков (доллар США)", y = "Частота") +
  theme_bw()
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения потерь операционного риска типа 3
ggplot(data = or_type3, mapping = aes(x = Loss)) +
  geom_boxplot(fill = "green", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот операционного риска типа 3", 
       x = "Сумма убытков (доллар США)") +
  theme_bw()
```
**Обнаружения:** Гистограмма и боксплот выявляют наличие выбросов, что подтверждается значительным различием между средним и медианой.


#### Предобработка данных для операционного риска типа 3

```{r}
# Извлечение выбросов из датафрейма
Quartile_1 <- quantile(or_type3$Loss, 0.25)
Quartile_3 <- quantile(or_type3$Loss, 0.75) 
IQR <- Quartile_3 - Quartile_1                
lower_bound <- Quartile_1 - 1.5 * IQR     
upper_bound <- Quartile_3 + 1.5 * IQR

# Идентификация выбросов
outliers_loss_3 <- or_type3$Loss[or_type3$Loss < lower_bound | or_type3$Loss > upper_bound]

# Вывод выбросов
print("Выбросы (метод IQR):")
print(outliers_loss_3)
```
```{r}
# Фильтрация датафрейма для исключения выбросов
or_type3_cleaned <- or_type3[or_type3$Loss >= lower_bound & 
                               or_type3$Loss <= upper_bound, ]

# Вывод очищенного датафрейма
print("Набор данных после удаления выбросов:")
head(or_type3_cleaned)
str(or_type3_cleaned)
```

```{r}
# Исследовательский анализ данных
str(or_type3_cleaned)
summary(or_type3_cleaned)
```

**Обнаружения:** Датафрейм для операционного риска типа 3 содержит 1,888 наблюдений. Все столбцы имеют соответствующие типы данных. Описательная статистика следующая:
Минимальное значение: 48 долларов США
Среднее: 889.2 долларов США
Медиана: 747 долларов США
Максимальное значение: 2,614 долларов США
Данные были очищены от выбросов.


#### Визуализация операционного риска тип 3 после очистки от выбросов

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения потерь операционного риска тип 3
ggplot(data = or_type3_cleaned, mapping = aes(x = Loss)) +
  geom_histogram(binwidth = 50, fill = "green", 
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма ОР тип 3 после очистки от выбросов", 
       x = "Сумма убытка (доллар США)", y = "Частота") +
  theme_bw()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения потерь операционного риска тип 3
ggplot(data = or_type3_cleaned, mapping = aes(x = Loss)) +
  geom_boxplot(fill = "green", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот ОР тип 3 после очистки от выбросов", 
       x = "Сумма убытка (доллар США)") +
  theme_bw()
```
**Обнаружения:** Гистограмма и боксплот свидетельствуют об отсутствии значительных выбросов, что дополнительно подтверждается минимальным различием между средним и медианой.


```{r}
# Извлечение 'Года' и 'Месяца' из столбца 'Дата'
or_type3_cleaned$Year <- year(or_type3_cleaned$Date)
or_type3_cleaned$Month <- month(or_type3_cleaned$Date)

# Группировка по 'Году' и 'Месяцу', суммирование столбца 'Потери'
or_loss_type3_monthly <- or_type3_cleaned %>%
  group_by(Year, Month) %>%
  summarise(Loss_3 = sum(Loss, na.rm = TRUE), .groups = "drop")
```

```{r}
# Вывод первых 5 строк
head(or_loss_type3_monthly)

# Вывод последних 5 строк
tail(or_loss_type3_monthly)

str(or_loss_type3_monthly)
```
```{r}
# Создание столбца 'Month_Group' на основе заданных интервалов месяцев 
# (3, 6, 9, 12 месяцев)
or_loss_type3_monthly$Month_Group <- case_when(
  or_loss_type3_monthly$Month %in% c(1, 2, 3) ~ "Q1",
  or_loss_type3_monthly$Month %in% c(4, 5, 6) ~ "Q2",
  or_loss_type3_monthly$Month %in% c(7, 8, 9) ~ "Q3",
  or_loss_type3_monthly$Month %in% c(10, 11, 12) ~ "Q4",
  TRUE ~ "Other"
)

# Группировка по 'Году' и 'Month_Group', суммирование столбца 'Loss_1'
grouped_by_month_type3 <- or_loss_type3_monthly %>%
  group_by(Year, Month_Group) %>%
  summarise(Total_Loss_3 = sum(Loss_3, na.rm = TRUE), .groups = "drop")
```

```{r}
# Проверка результатов
head(grouped_by_month_type3)
tail(grouped_by_month_type3)
```
```{r}
# Создание столбца 'Year-Quarter' в формате "YYYY-QX"
grouped_by_month_type3$Year_Quarter <- paste0(grouped_by_month_type3$Year, 
                                              "-Q", gsub("Q", "", 
                                                         grouped_by_month_type3$Month_Group))

# Проверка результатов
head(grouped_by_month_type3)

```
```{r}
# Удаление столбцов 'Year' и 'Month_Group' и изменение порядка оставшихся столбцов
or_loss_type3_quarterly <- grouped_by_month_type3 %>% 
  dplyr::select(Year_Quarter, Total_Loss_3)
```

```{r}
# Проверка датафрейма
head(or_loss_type3_quarterly)
```

#### Операционный риск тип 4

```{r}
# Загрузка необходимых файлов
# Потери операционного риска тип 4
or_type4 <- read_excel("C:\\Users\\user\\Documents\\Imir\\My Data Analysis Projects\\Data\\file4.xlsx")
head(or_type4)
tail(or_type4)
```
#### Исследовательский анализ данных операционного риска тип 4

```{r}
# Проверка на пропущенные значения
cat("\nПропущенные значения в каждом столбце:\n")
missing_values <- colSums(is.na(or_type4))
print(missing_values)

# Проверка на дублированные строки
cat("\nДублированные строки:\n")
duplicated_rows <- or_type4[duplicated(or_type4), ]
if (nrow(duplicated_rows) > 0) {
  print(duplicated_rows)
} else {
  cat("Дублированные строки не найдены.\n")
}

```
**Обнаружения:** В операционном риске тип 4 нет отсутствующих или дублированных значений.


```{r}
# Исследовательский анализ данных
summary(or_type4)
glimpse(or_type4)
str(or_type4)
```
**Обнаружения:** Датафрейм для операционного риска тип 4 содержит 1,941 наблюдений. Все столбцы имеют соответствующие типы данных. Описательная статистика следующая:
Минимальное значение: 201 доллар США
Среднее: 969.1 долларов США
Медиана: 717 долларов США
Максимальное значение: 6,215 долларов США.


#### Визуализация операционного риска тип 4

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения потерь операционного риска тип 4
ggplot(data = or_type4, mapping = aes(x = Loss)) +
  geom_histogram(binwidth = 50, fill = "skyblue", 
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма операционного риска тип 4", 
       x = "Сумма убытка (доллар США)", y = "Частота") +
  theme_bw()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения потерь операционного риска тип 4
ggplot(data = or_type4, mapping = aes(x = Loss)) +
  geom_boxplot(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Боксплот операционного риска тип 4", 
       x = "Сумма убытка (доллар США)") +
  theme_bw()
```
**Обнаружения:** Гистограмма и боксплот свидетельствуют о наличии выбросов, что подтверждается значительным различием между средним и медианой.

#### Предобработка данных для операционного риска тип 4


```{r}
# Извлечение выбросов из датафрейма
Quartile_1 <- quantile(or_type4$Loss, 0.25) 
Quartile_3 <- quantile(or_type4$Loss, 0.75) 
IQR <- Quartile_3 - Quartile_1                
lower_bound <- Quartile_1 - 1.5 * IQR         
upper_bound <- Quartile_3 + 1.5 * IQR     

# Идентификация выбросов
outliers_loss_4 <- or_type4$Loss[or_type4$Loss < lower_bound | or_type4$Loss > upper_bound]

# Вывод выбросов
print("Выбросы (метод IQR):")
print(outliers_loss_4)
```
```{r}
# Фильтрация датафрейма для исключения выбросов
or_type4_cleaned <- or_type4[or_type4$Loss >= lower_bound & 
                               or_type4$Loss <= upper_bound, ]

# Вывод очищенного датафрейма
print("Набор данных после удаления выбросов:")
head(or_type4_cleaned)
str(or_type4_cleaned)
```

```{r}
# Исследовательский анализ данных
str(or_type4_cleaned)
summary(or_type4_cleaned)
```
**Обнаружения:** Датафрейм для операционного риска тип 4 содержит 1,828 наблюдений. Все столбцы имеют соответствующие типы данных. Описательная статистика следующая:
Минимальное значение: 201 доллар США
Среднее: 829.5 долларов США
Медиана: 681 долларов США
Максимальное значение: 1,133.5 долларов США
Данные были очищены от выбросов.

#### Визуализация операционного риска тип 4 после удаления выбросов

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения потерь операционного риска тип 4
ggplot(data = or_type4_cleaned, mapping = aes(x = Loss)) +
  geom_histogram(binwidth = 50, fill = "skyblue", 
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма ОР тип 4 после удаления выбросов", 
       x = "Сумма убытка (доллар США)", y = "Частота") +
  theme_bw()
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения потерь операционного риска тип 4
ggplot(data = or_type4_cleaned, mapping = aes(x = Loss)) +
  geom_boxplot(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Боксплот ОР риска тип 4 после очистки от выбросов", 
       x = "Сумма убытка (доллар США)") +
  theme_bw()
```
**Обнаружения:** Гистограмма и боксплот указывают на отсутствие значительных выбросов, что дополнительно подтверждается минимальной разницей между средним значением и медианой.

```{r}
# # Извлечение 'Года' и 'Месяца' из столбца 'Дата'
or_type4_cleaned$Year <- year(or_type4_cleaned$Date)
or_type4_cleaned$Month <- month(or_type4_cleaned$Date)

# Группировка по 'Году' и 'Месяцу', суммирование столбца 'Убытки'
or_loss_type4_monthly <- or_type4_cleaned %>%
  group_by(Year, Month) %>%
  summarise(Loss_4 = sum(Loss, na.rm = TRUE), .groups = "drop")
```

```{r}
# Вывод первых 5 строк
head(or_loss_type4_monthly)

# Вывод последних 5 строк
tail(or_loss_type4_monthly)

str(or_loss_type4_monthly)
```

```{r}
# Создание столбца 'Month_Group' на основе указанных интервалов месяцев
# (3, 6, 9, 12 месяцев)
or_loss_type4_monthly$Month_Group <- case_when(
  or_loss_type4_monthly$Month %in% c(1, 2, 3) ~ "Q1",
  or_loss_type4_monthly$Month %in% c(4, 5, 6) ~ "Q2",
  or_loss_type4_monthly$Month %in% c(7, 8, 9) ~ "Q3",
  or_loss_type4_monthly$Month %in% c(10, 11, 12) ~ "Q4",
  TRUE ~ "Other"
)

# Группировка данных по годам ('Year') и месячным группам ('Month_Group') 
# с вычислением суммы по столбцу убытков ('Loss_1')
grouped_by_month_type4 <- or_loss_type4_monthly %>%
  group_by(Year, Month_Group) %>%
  summarise(Total_Loss_4 = sum(Loss_4, na.rm = TRUE), .groups = "drop")
```

```{r}
# Проверка результатов
head(grouped_by_month_type4)
tail(grouped_by_month_type4)
```

```{r}
# Создание столбца 'Year-Quarter' в формате "ГГГГ-QX" (год-квартал)
grouped_by_month_type4$Year_Quarter <- paste0(grouped_by_month_type4$Year, 
                                              "-Q", gsub("Q", "", 
                                                         grouped_by_month_type4$Month_Group))

# Проверка результатов
head(grouped_by_month_type4)

```
```{r}
# Удаление столбцов 'Year' и 'Month_Group' и переупорядочивание оставшихся столбцов
or_loss_type4_quarterly <- grouped_by_month_type4 %>% 
  dplyr::select(Year_Quarter, Total_Loss_4)
```

```{r}
# Проверка датафрейма
head(or_loss_type4_quarterly)
```

```{r}
# Фильтрация данных для создания объединенного датафрейма операционных рисковых потерь
or_type2_df <- or_loss_type2_quarterly %>% 
  dplyr:: select(Total_Loss_2)
head(or_type2_df)

or_type3_df <- or_loss_type3_quarterly %>% 
  dplyr:: select(Total_Loss_3)
head(or_type3_df)

or_type4_df <- or_loss_type4_quarterly %>% 
  dplyr:: select(Total_Loss_4)
head(or_type4_df)

```
```{r}
# Создание объединенного датафрейма убытков от операционных рисков
or_losses_total <- cbind(or_loss_type1_quarterly, or_type2_df, 
                         or_type3_df, or_type4_df)
or_losses_total$Total_or_losses <- or_losses_total$Total_Loss_1 + 
  or_losses_total$Total_Loss_2 + or_losses_total$Total_Loss_3 + 
  or_losses_total$Total_Loss_4
or_losses_total <- as.data.frame(or_losses_total)
head(or_losses_total)
tail(or_losses_total)
str(or_losses_total)


```
#### Визуализация совокупных убытков от операционных рисков

```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма общего объема операционных убытков
ggplot(data = or_losses_total, aes(x = Total_or_losses)) +
  geom_histogram(binwidth = 15000, 
                 fill = "yellow", color = "black", alpha = 0.7, aes(y = ..density..)) +
    labs(title = "Распределение общего объема убытков от ОР", 
       x = "Убытки от операционных рисков (сумма) в долларах США", y = "Частота") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_minimal()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот общего объема убытков от операционных рисков
ggplot(data = or_losses_total, mapping = aes(x = Total_or_losses)) +
  geom_boxplot(fill = "yellow", color = "black", alpha = 0.7) +
  labs(title = "Боксплот общего объема убытков от ОР", x = "Сумма убытков (доллар США)") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_bw()
```
**Обнаружения:** Распределение демонстрирует свойства нормального распределения, при этом отсутствуют разрывы в распределении совокупных операционных убытков.



## Анализ независимых переменных (макроэкономических показателей)

### Макроэкономические данные из пакета R "AFR"

```{r}
# Загрузка макроэкономического датасета из пакета "AFR"
head(macroKZ)
tail(macroKZ)
str(macroKZ)
```
**Обнаружения:** Датасет представляет собой временной ряд, состоящий из 57 строк и 60 столбцов макроэкономических показателей Казахстана за период с 1 квартала 2010 года по 1 квартал 2024 года. Все переменные выражены в квартальной частоте.
Согласно описанию проекта пакета "AFR" (https://CRAN.R-project.org/package=AFR), датасет включает следующие данные (50 макроэкономических и 10 финансовых параметров) за период 2010-2024 гг.:

**Основные экономические показатели:**
- real_gdp: Реальный ВВП
- GDD_Agr_R: Реальная валовая добавленная стоимость - Сельское хозяйство
- GDD_Min_R: Реальная валовая добавленная стоимость - Добыча полезных ископаемых
- GDD_Man_R: Реальная валовая добавленная стоимость - Обрабатывающая промышленность
- GDD_Elc_R: Реальная валовая добавленная стоимость - Электроэнергетика
- GDD_Con_R: Реальная валовая добавленная стоимость - Строительство

**Финансовые и ценовые показатели:**
- cpi: Инфляция (ИПЦ)
- usdkzt: Курс USD/KZT
- eurkzt: Курс EUR/KZT
- rurkzt: Курс RUB/KZT
- poil: Цена на нефть марки Brent

**Рынок недвижимости:**
- realest_resed_prim: Реальные цены на жильё на первичном рынке
- realest_resed_sec: Реальные цены на жильё на вторичном рынке
- realest_comm: Реальные цены на коммерческую недвижимость

**Финансовые рынки:**
- fed_fund_rate: Ставка федеральных фондов
- govsec_rate_kzt_3m: Доходность гос. ценных бумаг в KZT (3 мес.)
- govsec_rate_kzt_10y: Доходность гос. ценных бумаг в KZT (10 лет)

**Кредитные показатели:**
- rate_kzt_mort_0y_1y: Средневзвешенная ставка по ипотечным кредитам (<1 года)
- DR: Уровень дефолтов

**Примечание:** Полный перечень всех 60 показателей доступен в официальной документации пакета AFR. Данные представлены в квартальном измерении и могут быть использованы для анализа взаимосвязей между макроэкономической средой и операционными рисками.


#### Предварительная подготовка данных

```{r}
# Преобразование макроэкономического датасета в датафрейм
macrokz_df <- as.data.frame(macroKZ)
str(macrokz_df)
```
```{r}
# Проверка на наличие пропущенных значений
cat("\nКоличество пропущенных значений по столбцам:\n")
missing_values <- colSums(is.na(macrokz_df))
print(missing_values)

# Проверка на наличие дублирующихся строк
cat("\nДублирующиеся строки:\n")
duplicated_rows <- macrokz_df[duplicated(macrokz_df), ]
if (nrow(duplicated_rows) > 0) {
  print(duplicated_rows)
} else {
  cat("Дублирующиеся строки не обнаружены.\n")
}
```
**Обнаружения:** В макроэкономическом датафрейме отсутствуют пропущенные и дублирующиеся значения.

```{r}
# Добавление столбца с указанием временного периода
# Формирование последовательности кварталов с 1 квартала 2010 до 1 квартала 2024 года
time_period <- seq(from = as.Date("2010-04-01"), 
                   to = as.Date("2024-04-01"), 
                   by = "quarter")
macrokz_df$time_period <- time_period
str(macrokz_df)
```
**Обнаружения:** Датафрейм содержит нерелевантные макроэкономические переменные, которые следует исключить перед построением моделей.

##### Предварительная обработка данных

```{r}
# Фильтрация датафрейма и исключение нерелевантных переменных
macro_df_filtered <- macrokz_df %>% 
  dplyr:: select(-imp, -exp, -GDP_DEF, -realest_resed_prim, -realest_resed_sec, 
         -realest_comm, -index_stock_weighted, -ntrade_Agr, -ntrade_Min, 
         -ntrade_Man, -ntrade_Elc, -ntrade_Con, -ntrade_Trd, -ntrade_Trn, 
         -ntrade_Inf, -fed_fund_rate, -govsec_rate_kzt_3m, govsec_rate_kzt_1y, 
         -govsec_rate_kzt_7y, -govsec_rate_kzt_10y, -tonia_rate, 
         -rate_kzt_mort_0y_1y, -rate_kzt_mort_1y_iy, -rate_kzt_corp_0y_1y, 
         -rate_usd_corp_0y_1y, - rate_kzt_corp_1y_iy, -rate_usd_corp_1y_iy, 
         -rate_kzt_indv_0y_1y, -rate_kzt_indv_1y_iy, -realest_resed_prim_rus, 
         -realest_resed_sec_rus, -cred_portfolio, -coef_k1, -coef_k3, 
         -provisions, -percent_margin, -com_inc, -com_exp, -oper_inc, -oth_inc, -DR)
head(macro_df_filtered)
```

#### Преобразование показателей

Наблюдаемые квартальные колебания макроэкономических переменных обуславливают необходимость их агрегации в годовые значения с целью достижения согласованности данных и оптимизации моделирования.

```{r}
# Трансформация показателя реального ВВП
# Агрегация квартальных значений в годовые (суммирование по 4 кварталам)
macro_df_filtered$Yearly_GDP_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$real_gdp[i:(i + 3)])), 
  rep(NA, 3) 
)

# Расчет темпа роста как процентного отношения ВВП текущего года
# к ВВП предыдущего года
macro_df_filtered$real_gdp_y <- c(rep(NA, 4), 
                                  sapply(5:nrow(macro_df_filtered), 
                                         function(i) {
  previous_year_sum <- sum(macro_df_filtered$real_gdp[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$real_gdp[(i):(i + 3)])      
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости сельского хозяйства
# Расчет годового показателя ВДС сельского хозяйства (сумма за 4 квартала)
macro_df_filtered$Yearly_GDD_Agr_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Agr_R[i:(i + 3)])), 
  rep(NA, 3)  
)

# Расчет темпа роста как процентного отношения годовой ВДС сельского хозяйства текущего года 
# к ВДС сельского хозяйства предыдущего года
macro_df_filtered$GDD_Agr_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Agr_R[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$GDD_Agr_R[(i):(i + 3)])      
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости добывающей промышленности  
# Расчет годового показателя ВДС добывающей промышленности (сумма за 4 квартала)
macro_df_filtered$Yearly_GDD_Min_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Min_R[i:(i + 3)])), 
  rep(NA, 3)
)

# Расчет темпа роста как процентного отношения годовой ВДС добывающей промышленности текущего года
# к ВДС добывающей промышленности предыдущего года
macro_df_filtered$GDD_Min_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Min_R[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$GDD_Min_R[(i):(i + 3)])      
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости обрабатывающей промышленности
# Расчет годового показателя ВДС обрабатывающей промышленности (сумма за 4 квартала)
macro_df_filtered$Yearly_GDD_Man_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Man_R[i:(i + 3)])), 
  rep(NA, 3)  
)

# Расчет темпа роста как процентного отношения годовой ВДС обрабатывающей промышленности текущего года
# к ВДС обрабатывающей промышленности предыдущего года
macro_df_filtered$GDD_Man_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Man_R[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$GDD_Man_R[(i):(i + 3)])      
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3)) 
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости электроэнергетики
# Расчет годового показателя ВДС электроэнергетики (сумма за 4 квартала)
macro_df_filtered$Yearly_GDD_Elc_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Elc_R[i:(i + 3)])), 
  rep(NA, 3) 
)

# Расчет темпа роста как процентного отношения годовой ВДС электроэнергетики текущего года
# к ВДС электроэнергетики предыдущего года
macro_df_filtered$GDD_Elc_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Elc_R[(i - 4):(i - 1)])
  current_year_sum <- sum(macro_df_filtered$GDD_Elc_R[(i):(i + 3)])    
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3)) 
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости строительства
# Расчет годового показателя ВДС строительного сектора (сумма за 4 квартала)
macro_df_filtered$Yearly_GDD_Con_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Con_R[i:(i + 3)])), 
  rep(NA, 3)  # To match length with original data
)

# Расчет темпа роста как процента от реальной валовой добавленной стоимости 
# строительства текущего года по сравнению с реальной валовой добавленной 
# стоимостью строительства предыдущего года
macro_df_filtered$GDD_Con_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Con_R[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$GDD_Con_R[(i):(i + 3)])    
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3)) 
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости торговли
# Расчет годовой реальной валовой добавленной стоимости торговли
# сумма (сумма каждых 4 кварталов)
macro_df_filtered$Yearly_GDD_Trd_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Trd_R[i:(i + 3)])), 
  rep(NA, 3)
)

# Расчет темпа роста как процента от реальной валовой добавленной стоимости
# торговли текущего года по сравнению с реальной валовой добавленной
# стоимостью торговли предыдущего года
macro_df_filtered$GDD_Trd_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Trd_R[(i - 4):(i - 1)])
  current_year_sum <- sum(macro_df_filtered$GDD_Trd_R[(i):(i + 3)])    
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости транспорта
# Расчет годовой реальной валовой добавленной стоимости транспорта
# сумма (сумма каждых 4 кварталов)
macro_df_filtered$Yearly_GDD_Trn_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Trn_R[i:(i + 3)])), 
  rep(NA, 3)  
)

# Расчет темпа роста как процента от реальной валовой добавленной стоимости
# транспорта текущего года по сравнению с реальной валовой добавленной
# стоимостью транспорта предыдущего года
macro_df_filtered$GDD_Trn_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Trn_R[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$GDD_Trn_R[(i):(i + 3)])     
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3)) 
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости информации
# Расчет годовой реальной валовой добавленной стоимости информации
# сумма (сумма каждых 4 кварталов)
macro_df_filtered$Yearly_GDD_Inf_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Inf_R[i:(i + 3)])), 
  rep(NA, 3)  
)

# Расчет темпа роста как процента от реальной валовой добавленной стоимости
# информации текущего года по сравнению с реальной валовой добавленной
# стоимостью информации предыдущего года
macro_df_filtered$GDD_Inf_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Inf_R[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$GDD_Inf_R[(i):(i + 3)])      
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости недвижимости
# Расчет годовой реальной валовой добавленной стоимости недвижимости
# сумма (сумма каждых 4 кварталов)
macro_df_filtered$Yearly_GDD_Est_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_Est_R[i:(i + 3)])), 
  rep(NA, 3)
)

# Расчет темпа роста как процента от реальной валовой добавленной стоимости
# недвижимости текущего года по сравнению с реальной валовой добавленной
# стоимостью недвижимости предыдущего года
macro_df_filtered$GDD_Est_R_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_Est_R[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$GDD_Est_R[(i):(i + 3)])      
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  # Round to 3 decimal places
}))
```

```{r}
# Преобразование переменной реальной валовой добавленной стоимости
# Расчет годовой реальной валовой добавленной стоимости
# сумма (сумма каждых 4 кварталов)
macro_df_filtered$Yearly_GDD_R_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$GDD_R[i:(i + 3)])), 
  rep(NA, 3) 
)

# Расчет темпа роста как процента от реальной валовой добавленной стоимости
# текущего года по сравнению с реальной валовой добавленной
# стоимостью предыдущего года
macro_df_filtered$GDD_R_y <- c(rep(NA, 4), 
                               sapply(5:nrow(macro_df_filtered), 
                                      function(i) {
  previous_year_sum <- sum(macro_df_filtered$GDD_R[(i - 4):(i - 1)])
  current_year_sum <- sum(macro_df_filtered$GDD_R[(i):(i + 3)]) 
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3)) 
}))
```

```{r}
# Преобразование переменной реального среднемесячного дохода населения
# Расчет годового показателя реального среднемесячного дохода (сумма за 4 квартала)
macro_df_filtered$Yearly_Rincpop_q_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$Rincpop_q[i:(i + 3)])), 
  rep(NA, 3)
)


# Расчет темпа роста как процентного отношения реального среднемесячного дохода текущего года
# к реальному среднемесячному доходу предыдущего года
macro_df_filtered$Rincpop_q_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$Rincpop_q[(i - 4):(i - 1)])
  current_year_sum <- sum(macro_df_filtered$Rincpop_q[(i):(i + 3)])    
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  
}))
```

```{r}
# Преобразование переменной реальных среднемесячных расходов населения
# Расчет годового показателя реальных расходов (сумма за 4 квартала)
macro_df_filtered$Yearly_Rexppop_q_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$Rexppop_q[i:(i + 3)])), 
  rep(NA, 3)  
)

# Расчет темпа роста как процентного отношения реальных среднемесячных расходов текущего года
# к реальным среднемесячным расходам предыдущего года
macro_df_filtered$Rexppop_q_y <- c(rep(NA, 4), 
                                   sapply(5:nrow(macro_df_filtered), 
                                          function(i) {
  previous_year_sum <- sum(macro_df_filtered$Rexppop_q[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$Rexppop_q[(i):(i + 3)])    
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  
}))
```

```{r}
# Преобразование переменной реальной среднемесячной заработной платы
# Расчет годового показателя реальной зарплаты (сумма за 4 квартала)
macro_df_filtered$Yearly_Rwage_q_Sum <- c(
  sapply(1:(nrow(macro_df_filtered) - 3), 
         function(i) sum(macro_df_filtered$Rwage_q[i:(i + 3)])), 
  rep(NA, 3)  
)

# Расчет темпа роста как процентного отношения реальной среднемесячной зарплаты текущего года
# к реальной среднемесячной зарплате предыдущего года
macro_df_filtered$Rwage_q_y <- c(rep(NA, 4), 
                                 sapply(5:nrow(macro_df_filtered), 
                                        function(i) {
  previous_year_sum <- sum(macro_df_filtered$Rwage_q[(i - 4):(i - 1)]) 
  current_year_sum <- sum(macro_df_filtered$Rwage_q[(i):(i + 3)])     
  growth_rate <- (current_year_sum / previous_year_sum - 1) * 100
  return(round(growth_rate, 3))  
}))
```

```{r}
# Преобразование переменной инфляции
# Расчет квартального роста инфляции
macro_df_filtered$cpi_q <- c(NA, diff(macro_df_filtered$cpi) / 
                               head(macro_df_filtered$cpi, -1) * 100)

# Расчет годового роста инфляции
macro_df_filtered$cpi_y <- c(rep(NA, 4), 
                             sapply(5:nrow(macro_df_filtered), 
                                    function(i) {
  yearly_growth <- (macro_df_filtered$cpi[i] - macro_df_filtered$cpi[i - 4]) / 
    macro_df_filtered$cpi[i - 4] * 100
  return(round(yearly_growth, 2))  # Round to 2 decimal places
}))
```

```{r}
# Проверка датафрейма макроэкономических переменных
str(macro_df_filtered)
```
**Обнаружения:** Новые макроэкономические переменные были добавлены в датафрейм в результате преобразования квартальных данных в годовые значения, что позволило устранить тенденции (тренд) увеличения и уменьшения.


```{r}
# Фильтрация датафрейма макроэкономических данных для исключения не преобразованных переменных
macro_df_cleaned <- macro_df_filtered %>% 
  dplyr:: select(-real_gdp, -GDD_Agr_R, -GDD_Min_R, 
                 -GDD_Man_R, -GDD_Elc_R, 
                 -GDD_Con_R, -GDD_Trd_R, -GDD_Trn_R, 
                 -GDD_Inf_R, -GDD_Est_R, -GDD_R, 
                 -Rincpop_q, -Rexppop_q, -Rwage_q, 
                 -govsec_rate_kzt_1y, -Yearly_GDP_Sum,
                 -Yearly_GDD_Agr_R_Sum, -Yearly_GDD_Min_R_Sum, 
                 -Yearly_GDD_Man_R_Sum, -Yearly_GDD_Elc_R_Sum,
                 -Yearly_GDD_Con_R_Sum, -Yearly_GDD_Trd_R_Sum, 
                 -Yearly_GDD_Trn_R_Sum, -Yearly_GDD_Inf_R_Sum,
                 -Yearly_GDD_Est_R_Sum, -Yearly_GDD_R_Sum, 
                 -Yearly_Rincpop_q_Sum, -Yearly_Rexppop_q_Sum, 
                 -Yearly_Rwage_q_Sum)
```

```{r}
# Проверка очищенного датафрейма
str(macro_df_cleaned)
```
**Обнаружения:** В датафрейме макроэкономических данных содержатся 21 преобразованная переменная, и из этих 21 преобразованной переменной можно создать 1,330 возможных комбинаций макроэкономических переменных.

## Создание окончательного датафрейма для моделирования

### Обработка окончательного датафрейма для моделирования

#### Обработка общего датафрейма потерь операционного риска


```{r}
# Проверка датафрейма общих потерь операционного риска
str(or_losses_total)
```
**Обнаружения:** Данные в датафрейме общих потерь операционного риска охватывают период с Q1-2007 по Q4-2016, в то время как доступные макроэкономические переменные охватывают период с Q1-2010 по Q1-2024. Для согласования обоих наборов данных оба датафрейма — общих потерь операционного риска и макроэкономических переменных — будут усечены до периода с Q1-2011 по Q4-2016.


```{r}
# Преобразование 'Year_Quarter' в дату для сравнения
or_losses_total$Year_Quarter <- as.character(or_losses_total$Year_Quarter)

# Фильтрация данных с Q1-2016 и далее
or_losses_filtered <- or_losses_total %>%
  filter(Year_Quarter >= "2011-Q1")
```

```{r}
# Проверка отфильтрованных данных
head(or_losses_filtered)
tail(or_losses_filtered)
```
```{r}
# Преобразование квартала в дату (предполагая первый день каждого квартала)
# Извлечение года и квартала из Year_Quarter
or_losses_filtered$Year <- substr(or_losses_filtered$Year_Quarter, 1, 4)
or_losses_filtered$Quarter <- substr(or_losses_filtered$Year_Quarter, 6, 7)
or_losses_filtered$Date_2 <- as.Date(paste0(or_losses_filtered$Year, "-", 
                                            case_when(
                                              or_losses_filtered$Quarter == "Q1" ~ "01",
                                              or_losses_filtered$Quarter == "Q2" ~ "04",
                                              or_losses_filtered$Quarter == "Q3" ~ "07",
                                              or_losses_filtered$Quarter == "Q4" ~ "10"
                                            ), "-01"), format="%Y-%m-%d")

# Проверка результата
head(or_losses_filtered)
```
```{r}
# Определение курсов обмена KZT/USD для каждого года
usd_kzt_exchange_rates <- c(
  `2016` = 342.16,
  `2015` = 221.73,
  `2014` = 179.19,
  `2013` = 152.13,
  `2012` = 149.11,
  `2011` = 146.62,
  `2010` = 147.35
)

# Определение функции для конвертации убытков от операционного риска в KZT в зависимости от года
convert_to_kzt <- function(year, value) {
  exchange_rate <- usd_kzt_exchange_rates[as.character(year)]
  if (!is.null(exchange_rate)) {
    return(value * exchange_rate)
  } else {
    return(NA)
  }
}

# Применение конвертации для каждого соответствующего столбца
or_losses_filtered$Total_loss_1_KZT <- mapply(convert_to_kzt, 
                                              as.numeric(format(or_losses_filtered$Date_2, 
                                                                "%Y")), 
                                              or_losses_filtered$Total_Loss_1)

or_losses_filtered$Total_loss_2_KZT <- mapply(convert_to_kzt, 
                                              as.numeric(format(or_losses_filtered$Date_2, 
                                                                "%Y")), 
                                              or_losses_filtered$Total_Loss_2)

or_losses_filtered$Total_loss_3_KZT <- mapply(convert_to_kzt, 
                                              as.numeric(format(or_losses_filtered$Date_2, 
                                                                "%Y")), 
                                              or_losses_filtered$Total_Loss_3)

or_losses_filtered$Total_loss_4_KZT <- mapply(convert_to_kzt, 
                                              as.numeric(format(or_losses_filtered$Date_2, 
                                                                "%Y")), 
                                              or_losses_filtered$Total_Loss_4)

or_losses_filtered$Total_or_losses_KZT <- mapply(convert_to_kzt, 
                                                 as.numeric(format(or_losses_filtered$Date_2, 
                                                                   "%Y")), 
                                                 or_losses_filtered$Total_or_losses)

```

```{r}
# Проверка первых и последних нескольких строк обновленного датафрейма
head(or_losses_filtered)
tail(or_losses_filtered)
```
#### Обработка датафрейма банковской статистики

```{r}
# Преобразование столбца 'Date' в формат Date
banking_stats_filtered$Date <- as.Date(banking_stats_filtered$Date)

# Определение диапазона дат для фильтрации
start_date <- as.Date("2011-03-01")
end_date <- as.Date("2016-12-01")

# Фильтрация данных в пределах указанного диапазона
banking_stats_filtered_filtered <- banking_stats_filtered %>%
  filter(Date >= start_date & Date <= end_date)
```

```{r}
# Проверка первых и последних нескольких строк отфильтрованных данных
head(banking_stats_filtered_filtered)
tail(banking_stats_filtered_filtered)
```

```{r}
# Создание объединенного датафрейма банковской статистики
bank_x <- cbind(banking_stats_filtered_filtered, or_losses_filtered)
```

```{r}
# Проверка объединённого датафрейма
str(bank_x)
head(bank_x)
tail(bank_x)
```


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание графика сравнения для Общих активов и Общих убытков от операционного риска
bank_x$Date <- as.factor(bank_x$Date)

p <- ggplot(bank_x, aes(x = Date)) +
  geom_line(aes(y = Value / 1000000000, color = "Всего Активов"), 
            linewidth = 1, group = 1) +
  geom_point(aes(y = Value / 1000000000, color = "Всего Активов"), 
             size = 3) +
  geom_line(aes(y = (Total_or_losses_KZT / 1000) * scale_factor, 
                color = "Всего убытков"), linewidth = 1, group = 1) +
  geom_point(aes(y = (Total_or_losses_KZT / 1000) * scale_factor, 
                 color = "Всего убытков"), size = 3) +
  
  scale_color_manual(values = c("Всего Активов" = "blue", 
                                "Всего Убытков" = "red")) +
  scale_y_continuous(
    name = "Всего Активов (Миллиарды тенге)",  
    labels = comma,
    sec.axis = sec_axis(
      ~ . / scale_factor, 
      name = "Всего убытков (Тысячи тенге)", 
      labels = comma
    )
  ) +
  labs(
    title = "Сравнение всего активов с убытками от операционных рисков",
    x = "По годам",
    color = ""
  ) +
  theme_minimal() +
  theme(
    axis.title.y.left = element_text(color = "blue"),
    axis.text.y.left = element_text(color = "blue"),
    axis.title.y.right = element_text(color = "red"),
    axis.text.y.right = element_text(color = "red"),
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

scale_factor <- max(bank_x$Value / 1000000000) / 
  max(bank_x$Total_or_losses_KZT / 1000)

print(p)
```
**Обнаружения:** Несмотря на быстрые колебания убытков от операционного риска, в данных с 2015 года наблюдается восходящий тренд. Однако важно отметить, что данные об убытках от операционного риска получены из открытого пакета "OpVaR" для R и не являются специфичными для банковской системы Казахстана. Таким образом, они не отражают фактический уровень операционного риска в банках Казахстана.

#### Обработка данных
Данные об убытках от операционного риска выражены в миллионах тенге (KZT), в то время как данные по макроэкономическим переменным представлены в триллионах тенге (KZT). Если эти значения будут введены в регрессионную модель без приведения к сопоставимым единицам измерения, это приведет к некорректным расчетам. Чтобы решить эту проблему, зависимая переменная будет выражена как доля (часть) от общих убытков от операционного риска относительно общих активов банка "X" для линейной регрессионной модели.

```{r}
# Расчет доли (части) общих потерь операционного риска в общем объеме активов банка "X"
bank_x$OR_Loss_in_assets <- bank_x$Total_or_losses_KZT / bank_x$Value
bank_x$OR_Loss_1_in_assets <- bank_x$Total_loss_1_KZT / bank_x$Value
bank_x$OR_Loss_2_in_assets <- bank_x$Total_loss_2_KZT / bank_x$Value
bank_x$OR_Loss_3_in_assets <- bank_x$Total_loss_3_KZT / bank_x$Value
bank_x$OR_Loss_4_in_assets <- bank_x$Total_loss_4_KZT / bank_x$Value
```

```{r}
# Проверка датафрейма
head(bank_x)
```

```{r}
# Проверка датафрейма макроэкономических переменных
head(macro_df_cleaned)
tail(macro_df_cleaned)
```
```{r}
# Фильтрация макроэкономических данных для периода с 1 апреля 2011 года по 1 января 2017 года
macro_df_final <- macro_df_cleaned %>%
  filter(time_period >= as.Date("2011-04-01") & 
           time_period <= as.Date("2017-01-01")) %>% 
  dplyr:: select(time_period, everything())
```

```{r}
# Проверка данных макроэкономических переменных
head(macro_df_final)
tail(macro_df_final)
```
```{r}
# Создание объединённого датафрейма макроэкономических переменных и банковской статистики
model_data <- cbind(macro_df_final, bank_x)
str(model_data)
```
```{r}
# Проверка на пропущенные значения
cat("\nПропущенные значения по каждому столбцу:\n")
missing_values <- colSums(is.na(model_data))
print(missing_values)

# Проверка на дублированные строки
cat("\nДублированные строки:\n")
duplicated_rows <- model_data[duplicated(model_data), ]
if (nrow(duplicated_rows) > 0) {
  print(duplicated_rows)
} else {
  cat("Дублированных строк не найдено.\n")
}
```
**Обнаружения:** В датафрейме для моделирования нет пропущенных или дублированных значений.

### Промежуточный вывод
Зависимая и независимые переменные подготовлены для моделирования, не содержат пропущенных и дублированных значений. Все переменные имеют правильные форматы данных. Финальный датафрейм очищен от нерелевантных макроэкономических переменных.

# Модель Регрессии
## Конструирование модели Множественной линейной регрессии

Модель множественной линейной регрессии будет использоваться для стресс-тестирования операционного риска. В коде на языке R будет автоматически выбраны оптимальные параметры путём перебора 1,330 возможных комбинаций независимых переменных (регрессоров). Для обеспечения надёжности модели будут применяться статистические тесты на мультиколлинеарность, стационарность и статистическую значимость.

```{r}
# Создание датафрейма для моделирования
final_df <- as.data.frame(model_data)
```

### Применение модели множественной линейной регрессии

#### Формулировка гипотезы:
Нулевая гипотеза (H0): Макроэкономические переменные не связаны с операционными убытками.
Альтернативная гипотеза (Ha): Макроэкономические переменные связаны с операционными убытками.
Уровень значимости:
Alpha (α): Уровень значимости установлен на 0.1, что соответствует 90% доверительному интервалу.
Порог для коэффициента детерминации (R^2):
R^2 (Коэффициент детерминации): Для модели считается приемлемым пороговое значение R^2 на уровне 0.35 (35%), что означает, что модель должна объяснять хотя бы 35% вариации операционных убытков.

```{r warning=FALSE}
# Функция для проверки стационарности и значимости для Модели 1
check_stationarity_significance_model_1 <- function(X, y) {
  X <- as.data.frame(cbind(1, X))  
  colnames(X)[1] <- "(Intercept)"  
  model1 <- lm(y ~ ., data = X)  
  p_values <- summary(model1)$coefficients[, 4][-1]  
  adf_test <- adf.test(resid(model1)) 
  return(list(p_values = p_values, adf_test = adf_test))
}

# Функция для расчета Фактора Инфляции Дисперсии (VIF) для Модели 1
calculate_vif_model_1 <- function(X, y) {
  
  data <- as.data.frame(cbind(X, y = y))
  vif_data <- vif(lm(y ~ ., data = data))
  return(data.frame(feature = names(vif_data), 
                    VIF = vif_data))
}

# Функция для нахождения лучшей модели для Модели 1
# на основе комбинаций признаков
find_best_model_model_1 <- function(final_df) {

  excluded_columns <- c("time_period", "Year_Quarter", 
                        "Date", "Date_2", "Value",
                        "Total_Loss_1", "Total_Loss_2", 
                        "Total_Loss_3", "Total_Loss_4",
                        "OR_Loss_in_assets", "Value_billion", 
                        "Total_or_losses",
                        "Total_or_losses_KZT", "Total_loss_1_KZT", 
                        "Total_loss_2_KZT",
                        "Total_loss_3_KZT", "Total_loss_4_KZT", 
                        "OR_Loss_1_in_assets",
                        "OR_Loss_2_in_assets", "OR_Loss_3_in_assets", 
                        "OR_Loss_4_in_assets", "Year", "Quarter")
  X <- final_df[, !colnames(final_df) %in% excluded_columns]
  y <- final_df$OR_Loss_in_assets
  
  best_r2 <- -Inf
  best_model1 <- NULL
  best_features1 <- NULL
  valid_combinations <- 0 
  total_combinations <- choose(ncol(X), 3)
  combination_count <- 0
  
  # Генерация комбинаций из 3 независимых переменных
  combinations <- combn(names(X), 3, simplify = FALSE)
  
  # Инициализация списка для хранения допустимых комбинаций, прошедших тесты
  valid_combinations_list <- list()

  for (i in 1:length(combinations)) {
    combination_count <- combination_count + 1
    selected_features <- X[, combinations[[i]], drop = FALSE] 
    
    # Проверка стационарности и значимости для Модели 1
    test_result <- check_stationarity_significance_model_1(selected_features, 
                                                           y)
    p_values <- test_result$p_values
    adf_test <- test_result$adf_test
    
    # Пропуск комбинаций, не прошедших статистические тесты
    if (any(p_values > 0.1) || adf_test$p.value > 0.1) {
      next  # Skip this combination
    }
    
    # Проверка VIF для Модели 1
    vif_test <- calculate_vif_model_1(selected_features, y)
    if (max(vif_test$VIF) > 10) {
      next  # Skip this combination
    }

    # Построение модели для Модели 1
    selected_features <- as.data.frame(cbind(1, selected_features))  
    colnames(selected_features)[1] <- "(Intercept)"  
    model1 <- lm(y ~ ., data = selected_features)  
    r2 <- summary(model1)$r.squared
    
    # Проверка наилучшей модели
    if (r2 > best_r2) {
      best_r2 <- r2
      best_model1 <- model1
      best_features1 <- combinations[[i]]
    }
    
    # Добавление допустимой комбинации в список
    valid_combinations <- valid_combinations + 1
    valid_combinations_list[[valid_combinations]] <- list(
      combination = combinations[[i]],
      p_values = p_values,
      adf_p_value = adf_test$p.value,
      r2 = r2
    )
  }
  
  # Возвращение наилучшей модели, лучших признаков и допустимых комбинаций
  return(list(best_model1 = best_model1, 
              best_features1 = best_features1,
              best_r2 = best_r2,
              valid_combinations_list = valid_combinations_list,
              valid_combinations = valid_combinations,
              total_combinations = total_combinations))
}

# Нахождение наилучшей модели для модели 1
best_result_1 <- find_best_model_model_1(final_df)
best_model_1 <- best_result_1$best_model1
best_features_1 <- best_result_1$best_features1
valid_combinations_list <- best_result_1$valid_combinations_list
valid_combinations <- best_result_1$valid_combinations
total_combinations <- best_result_1$total_combinations

# Вывод результатов
cat("Общее количество комбинаций:", total_combinations, "\n")
cat("Количество допустимых комбинаций, прошедших статистические тесты:", 
    valid_combinations, "\n")

# Вывод каждой допустимой комбинации с её деталями
cat("Вывод допустимых комбинаций, прошедших статистические тесты:\n")
for (i in 1:length(valid_combinations_list)) {
  cat("Комбинация", i, ":", paste(valid_combinations_list[[i]]$combination, 
                                   collapse = ", "), "\n")
  cat("p-значения: ", paste(valid_combinations_list[[i]]$p_values, 
                          collapse = ", "), "\n")
  cat("p-значения теста ADF: ", valid_combinations_list[[i]]$adf_p_value, 
      "\n")
  cat("R^2: ", valid_combinations_list[[i]]$r2, "\n\n")
}

# Вывод лучшей модели и её характеристик
cat("Лучшие независимые переменные для Модели 1:", 
    paste(best_features_1, collapse = ", "), "\n")
cat("R^2 лучшей модели для Модели 1:", best_result_1$best_r2, 
    "\n")
print(summary(best_model_1))

```

Всего 4 комбинации прошли статистические тесты и были выбраны после итерации через 1 330 сгенерированных комбинаций макроэкономических переменных. Эти выбранные комбинации следующие:

Комбинация 1: poil (Цена на нефть марки Брент)
real_gdp_y (Реальный ВВП, преобразованный)
GDD_Elc_R_y (Реальная добавленная стоимость — Электричество, преобразованная)
R^2: 0.4314054.

Комбинация 2: poil (Цена на нефть марки Брент)
GDD_Elc_R_y (Реальная добавленная стоимость — Электричество, преобразованная)
GDD_R_y (Реальная добавленная стоимость, преобразованная)
R^2: 0.4305061.

Комбинация 3: GDD_Agr_R_y (Реальная добавленная стоимость — Сельское хозяйство, преобразованная)
GDD_Trn_R_y (Реальная добавленная стоимость — Транспорт, преобразованная)
GDD_Est_R_y (Реальная добавленная стоимость — Недвижимость, преобразованная)
R^2: 0.4162206.

Комбинация 4: GDD_Trn_R_y (Реальная добавленная стоимость — Транспорт, преобразованная)
GDD_Inf_R_y (Реальная добавленная стоимость — Информация, преобразованная)
Rincpop_q_y (Реальный средний ежемесячный доход населения, преобразованный)
R^2: 0.4426457.

Лучшая модель множественной линейной регрессии для прогнозирования величин (влияния/серьезности) потерь операционного риска включает следующие макроэкономические переменные с наибольшим R^2: GDD_Trn_R_y (Реальная добавленная стоимость — Транспорт)
GDD_Inf_R_y (Реальная добавленная стоимость — Информация)
Rincpop_q_y (Реальный средний ежемесячный доход населения).

R^2 (Коэффициент детерминации) для лучшей модели составляет 0.44, с откорректированным R^2 0.36. Значения p для переменных находятся ниже уровня значимости 0.1, что указывает на статистическую значимость.

Таким образом, нулевая гипотеза отвергается, а альтернативная гипотеза принимается, что подтверждает, что выбранные макроэкономические переменные существенно связаны с частотой (количеством) потерь операционного риска.


#### Проверка предположений моделирования для модели множественной линейной регрессии
#### Модель множественной линейной регрессии 1

```{r}
# Построение модели множественной линейной регрессии
mfl_model_or <- lm(OR_Loss_in_assets ~ GDD_Trn_R_y + 
                     GDD_Inf_R_y + Rincpop_q_y, 
                   data = model_data)
summary(mfl_model_or)
```
#### Создание матрицы корреляций

```{r}
kendall_corr <- model_data %>% 
  dplyr:: select(GDD_Trn_R_y, GDD_Inf_R_y, 
                 Rincpop_q_y, OR_Loss_in_assets)

# Вычисление матрицы корреляций по Кендаллу

kendall_corr1 <- cor(kendall_corr, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr1)
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляций по Кендаллу с помощью графика корреляций

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr1, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45,
         
)
```
**Обнаружения:** Анализ корреляции между независимыми и зависимыми переменными показывает умеренную отрицательную корреляцию. Это свидетельствует о противоположной связи между макроэкономическими переменными (независимыми переменными) и убытками от операционного риска (зависимой переменной), что указывает на то, что с увеличением некоторых макроэкономических показателей соответствующие убытки от операционного риска склонны уменьшаться, и наоборот. Этот вывод будет важен для интерпретации результатов модели и понимания динамики между макроэкономическими факторами и убытками от операционного риска.

#### Предположение линейности

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной

ggplot(data = model_data, aes(x = GDD_Trn_R_y, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
labs(title = "Диаграмма рассеяния: GDD_Trn_R_y и Убытки от ОР", 
     x = "GDD_Trn_R_y", y = "Убытки от операционного риска в активах") +
  theme_minimal()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной

ggplot(data = model_data, aes(x = GDD_Inf_R_y, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния: GDD_Inf_R_y и Убытки от ОР", 
     x = "GDD_Inf_R_y", y = "Убытки от операционного риска в активах") +

  theme_minimal()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной

ggplot(data = model_data, aes(x = Rincpop_q_y, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния: Rincpop_q_y и Убытки от ОР", 
     x = "Rincpop_q_y", y = "Убытки от операционного риска в активах") +

  theme_minimal()
```
**Обнаружения:** Трудно подтвердить наличие линейных взаимосвязей между независимыми и зависимой переменными. Предположение линейности предполагает, что связь между предикторами (макроэкономическими переменными) и откликом (убытками от операционного риска) является линейной. Если это предположение нарушается, модель может не уловить истинную зависимость, что приведёт к смещённым или неэффективным прогнозам. В контексте прогнозирования операционного риска, где взаимосвязи между макроэкономическими факторами и убытками, как правило, сложны, игнорирование нелинейных связей может привести к неточной оценке рисков. Стресс-тестирование на основе линейных моделей в таких случаях может привести к вводящим в заблуждение выводам о потенциальном воздействии или серьёзности убытков от операционного риска, что повлияет на принятие решений и стратегии управления рисками.

#### Предположение нормальности


```{r fig.align="center", fig.width=6, fig.height=4}
# Расчёт остатков модели

residuals <- resid(mfl_model_or)

# Создание сетки из 2 графиков (гистограмма и Q-Q график) в формате 1x2
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой числа интервалов и осей
hist(
  residuals,
  breaks = 5,  # Увеличение количества интервалов
  main = "Гистограмма остатков",
  xlab = "Значение остатка",
  col = "lightblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X для отключения научной нотации
axis(1, at = pretty(residuals), labels = format(pretty(residuals), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(residuals, main = "Нормальный Q-Q график")
qqline(residuals, col = "red")

# Возврат к стандартной разметке графиков
par(mfrow = c(1, 1))

```
**Обнаружения:** Гистограмма остатков показывает распределение, которое не кажется нормальным, с заметными промежутками в распределении остатков. Это наблюдение подтверждает, что предположение нормальности не выполняется для данной модели. Кроме того, Q-Q график не следует прямой линии, что ещё раз указывает на нарушение предположения нормальности.
Предположение нормальности имеет ключевое значение, особенно для статистических выводов, включая проверку гипотез и доверительные интервалы. Когда остатки не распределены нормально, точность p-значений и доверительных интервалов может быть нарушена. Если предположение нормальности нарушается, способность модели надёжно предсказывать операционные риски может быть затруднена, особенно в случаях, когда необходимо количественно оценивать неопределённость (например, при построении интервалов прогнозирования). Хотя модель всё ещё может давать полезные прогнозы, эти прогнозы следует рассматривать с большей осторожностью из-за нарушения предположения нормальности.


#### Предположение о постоянной дисперсии


```{r fig.align="center", fig.width=6, fig.height=4}
# Расчёт предсказанных значений и остатков
fitted_values <- fitted(mfl_model_or)
residuals <- resid(mfl_model_or)

# Создание диаграммы рассеяния предсказанных значений и остатков
plot(fitted_values, residuals, 
     xlab = "Предсказанные значения", 
     ylab = "Остатки", 
     main = "Предсказанные значения vs Остатки", 
     pch = 19, col = "blue")
abline(h = 0, col = "red", lty = 2)

```
**Обнаружения:** Предсказанные значения дисперсии, по-видимому, распределены одинаково, что подтверждает выполнение предположения о гомоскедастичности (постоянной дисперсии). Это положительный результат для модели, так как он указывает на то, что изменчивость остатков постоянна на всех уровнях предсказанных значений, что позволяет получить более надёжные оценки параметров и действительные статистические выводы.


#### Предположение об отсутствии мультиколлинеарности


```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения об отсутствии мультиколлинеарности
columns <- c('GDD_Trn_R_y', 'GDD_Inf_R_y', 
             'Rincpop_q_y', 'OR_Loss_in_assets')

# Создание парного графика для выбранных столбцов
ggpairs(model_data[, columns])


# Расчёт VIF для модели
vif_result <- vif(mfl_model_or)

# Преобразование результатов VIF в дата-фрейм
df_vif <- data.frame(VIF = vif_result)
df_vif

```
**Обнаружения:** Фактор инфляции дисперсии (VIF) меньше 5, что указывает на низкую или умеренную мультиколлинеарность, что находится в пределах допустимых уровней. Это говорит о том, что независимые переменные в модели не сильно коррелированы друг с другом, что гарантирует стабильность и надёжность оценок коэффициентов регрессии. В результате прогнозы модели с меньшей вероятностью будут искажены мультиколлинеарностью, и статистическая значимость отдельных переменных может быть интерпретирована с большей уверенностью.


#### Модель множественной линейной регрессии 2


```{r}
# Построение модели множественной линейной регрессии

mfl_model_or2 <- lm(OR_Loss_in_assets ~ poil + real_gdp_y 
                    + GDD_Elc_R_y, data = model_data)
summary(mfl_model_or2)
```
#### Создание матрицы корреляций


```{r}
kendall_corr2 <- model_data %>% 
  dplyr:: select(poil, real_gdp_y, GDD_Elc_R_y, OR_Loss_in_assets)

# Вычисление матрицы корреляций по Кендаллу

kendall_corr2 <- cor(kendall_corr2, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr2)
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляций по Кендаллу с помощью графика корреляций

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr2, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45,
         
)
```
**Обнаружения:** Анализ корреляции между независимыми и зависимыми переменными показывает умеренную отрицательную корреляцию. Это свидетельствует о противоположной связи между макроэкономическими переменными (независимыми переменными) и убытками от операционного риска (зависимой переменной). С увеличением определённых макроэкономических показателей соответствующие убытки от операционного риска, как правило, уменьшаются, и наоборот. Эта взаимосвязь может указывать на то, что улучшения в макроэкономике (такие как рост ВВП или снижение инфляции) связаны с меньшими убытками от рисков, что может быть связано с более благоприятными условиями ведения бизнеса и меньшими финансовыми трудностями. Понимание этой динамики будет ключевым для интерпретации результатов модели и принятия обоснованных решений на основе макроэкономических тенденций при стресс-тестировании операционного риска.


#### Предположение линейности


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = model_data, aes(x = poil, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния: poil и Убытки от ОР", 
       x = "poil", y = "Убытки от операционного риска в активах") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = model_data, aes(x = real_gdp_y, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния: real_gdp_y и Убытки от ОР", 
       x = "real_gdp_y", y = "Убытки от операционного риска в активах") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = model_data, aes(x = GDD_Elc_R_y, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния: GDD_Elc_R_y и Убытки от ОР", 
       x = "GDD_Elc_R_y", y = "Убытки от операционного риска в активах") +
  theme_minimal()

```
**Обнаружения:** Трудно подтвердить наличие линейных зависимостей между независимыми и зависимыми переменными. Предположение линейности предполагает, что связь между предсказателями (макроэкономическими переменными) и зависимой переменной (убытки от операционного риска) линейная. Однако, если это предположение нарушается, модель может не захватить истинную динамику, что приведет к смещенным или неэффективным прогнозам. В контексте прогнозирования операционного риска, где связи между макроэкономическими факторами и убытками от риска, скорее всего, сложные и нелинейные, игнорирование этих нелинейных динамик может привести к неточным оценкам рисков. Стресс-тестирование с использованием линейных моделей в таких случаях может привести к ложным выводам о влиянии или тяжести убытков от операционного риска, что может повлиять на принятие решений и стратегии управления рисками. Важно исследовать нелинейные подходы к моделированию, чтобы лучше учитывать эти взаимосвязи и повысить надёжность анализа стресс-тестирования.


#### Предположение нормальности


```{r fig.align="center", fig.width=6, fig.height=4}
# Расчёт остатков модели
residuals2 <- resid(mfl_model_or2)

# Создание сетки из 1x2 графиков (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настроенными интервалами и форматированием осей
hist(
  residuals2,
  breaks = 5,  # Увеличиваем количество интервалов
  main = "Гистограмма остатков",
  xlab = "Значение остатков",
  col = "lightblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси x для удаления научной нотации
axis(1, at = pretty(residuals2), labels = format(pretty(residuals2), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(residuals2, main = "Нормальный Q-Q график")
qqline(residuals2, col = "red")

# Сбросить макет графиков на стандартный
par(mfrow = c(1, 1))

```
**Обнаружения:** Гистограмма остатков показывает распределение, которое не выглядит нормально распределённым, но без заметных пробелов в распределении остатков. Это наблюдение подтверждает, что предположение нормальности не полностью выполнено для этой модели. Кроме того, Q-Q график не следует прямой линии, что дополнительно указывает на нарушение предположения нормальности.
Предположение нормальности является важным, особенно для статистического вывода, включая тестирование гипотез и построение доверительных интервалов. Когда остатки не имеют нормальное распределение, точность p-значений и доверительных интервалов может быть нарушена. Если это предположение нарушено, способность модели надёжно прогнозировать операционный риск может быть затруднена, особенно при оценке неопределённости, например, при построении предсказательных интервалов. Хотя модель всё ещё может давать ценные выводы и прогнозы, эти прогнозы должны интерпретироваться с осторожностью из-за нарушения предположения нормальности. Для улучшения надёжности модели можно рассмотреть альтернативные методы, такие как непараметрические модели или трансформация переменных, чтобы лучше соответствовать предположению нормальности.


#### Предположение о постоянной дисперсии


```{r fig.align="center", fig.width=6, fig.height=4}
# Расчёт предсказанных значений и остатков
fitted_values <- fitted(mfl_model_or2)
residuals2 <- resid(mfl_model_or2)

# Создание диаграммы рассеяния предсказанных значений и остатков
plot(fitted_values, residuals2, 
     xlab = "Предсказанные значения", 
     ylab = "Остатки", 
     main = "Предсказанные значения против остатков", 
     pch = 19, col = "blue")
abline(h = 0, col = "red", lty = 2)

```
**Обнаружения:** Предсказанные значения дисперсии кажутся одинаково распределёнными, что подтверждает выполнение предположения о гомоскедастичности (постоянной дисперсии). Это указывает на то, что разброс остатков остается постоянным на всех уровнях независимых переменных, что является желательной характеристикой для регрессионных моделей. В результате, модель, вероятно, будет давать надёжные оценки, и гетероскедастичность не представляет собой проблему в этом случае. Следовательно, предположение о гомоскедастичности выполняется, что улучшает надёжность предсказаний и выводов модели.


#### Предположение об отсутствии мультиколлинеарности


```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения об отсутствии мультиколлинеарности
columns2 <- c('poil', 'real_gdp_y', 
             'GDD_Elc_R_y', 'OR_Loss_in_assets')

# Создание матрицы рассеяния для выбранных столбцов
ggpairs(model_data[, columns2])


# Расчёт VIF для модели
vif_result2 <- vif(mfl_model_or2)

# Преобразование результатов VIF в дата-фрейм
df_vif2 <- data.frame(VIF = vif_result2)
df_vif2

```
**Обнаружения:** Анализ фактора инфляции дисперсии (VIF) показывает, что VIF для переменных poil и GDD_Elc_R_y составляет менее 5, что указывает на низкую или умеренную мультиколлинеарность, что находится в пределах допустимых норм. Однако для переменной real_gdp_y наблюдается высокая мультиколлинеарность, что предполагает её высокую корреляцию с одной или несколькими другими независимыми переменными. Это может повлиять на стабильность и интерпретируемость коэффициентов регрессии, так как мультиколлинеарность может увеличивать стандартные ошибки и затруднять определение индивидуального эффекта каждой переменной.


#### Модель множественной линейной регрессии 3


```{r}
# Построение множественной линейной регрессионной модели
mfl_model_or3 <- lm(OR_Loss_in_assets ~ poil + 
                      GDD_Elc_R_y + GDD_R_y, data = model_data)
summary(mfl_model_or3)

```
#### Создание матрицы корреляций


```{r}
kendall_corr3 <- model_data %>% 
  dplyr:: select(poil, GDD_Elc_R_y, GDD_R_y, OR_Loss_in_assets)

# Расчёт матрицы корреляций по методу Кендалла
kendall_corr3 <- cor(kendall_corr3, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr3)

```
```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляций Кендалла с помощью графика корреляции
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr3, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45,
)

```
**Обнаружения:** Умеренная отрицательная корреляция между независимыми переменными (макроэкономическими факторами) и зависимой переменной (убытками от операционного риска) указывает на обратную зависимость. Это означает, что когда определённые макроэкономические индикаторы растут, убытки от операционного риска, как правило, снижаются, и наоборот. Эта обратная зависимость может отражать то, как улучшение экономических условий или отдельных макроэкономических показателей (таких как рост ВВП, низкая инфляция или стабильные финансовые рынки) может снизить операционные риски, повышая стабильность финансовых учреждений.
Интерпретация этого результата важна для понимания динамики между макроэкономическими факторами и операционным риском, особенно при разработке предсказательных моделей. Это может означать, что в периоды экономического роста или стабильности операционные риски могут быть менее значительными, тогда как экономические спады или нестабильность могут увеличивать операционные риски. Это понимание будет крайне важным для принятия более обоснованных решений и стратегий, связанных с стресс-тестированием и управлением рисками.


#### Предположение о линейности


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = model_data, aes(x = poil, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния poil и Убытки от ОР", 
       x = "poil", y = "OR_Loss_in_assets") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = model_data, aes(x = GDD_Elc_R_y, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния GDD_Elc_R_y и Убытки от ОР", 
       x = "GDD_Elc_R_y", y = "OR_Loss_in_assets") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = model_data, aes(x = GDD_R_y, y = OR_Loss_in_assets)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния GDD_R_y и Убытки от ОР", 
       x = "GDD_R_y", y = "OR_Loss_in_assets") +
  theme_minimal()

```
**Обнаружения:** Сложности в подтверждении наличия линейных взаимосвязей между независимыми переменными (макроэкономическими факторами) и зависимой переменной (убытки от операционного риска) свидетельствуют о возможном нарушении предположения линейности. В линейной регрессии предполагается, что существует линейная зависимость между предсказателями и зависимой переменной. Если это предположение не выполняется, модель может давать смещенные или неэффективные прогнозы, что приведет к менее точным прогнозам.
В контексте прогнозирования операционного риска, где макроэкономические факторы могут взаимодействовать сложным образом, нелинейные отношения могут более точно отражать реальные динамики. Игнорирование этих возможных нелинейностей может привести к искажению взаимосвязи между экономическими условиями и рисковыми потерями. Это повлияет на надежность стресс-тестов и стратегии управления рисками, что может привести к ложным выводам о тяжести убытков от операционного риска при различных экономических условиях.
Для повышения точности модели может быть необходимо исследовать нелинейные модели или преобразовывать данные, чтобы обеспечить более точное отражение отношений и стресс-тестирование, которое будет точнее отображать картину рисковой экспозиции.

#### Предположение о нормальности

```{r fig.align="center", fig.width=6, fig.height=4}
# Рассчитываем остатки модели
residuals3 <- resid(mfl_model_or3)

# Создание сетки из 1 строки и 2 столбцов для графиков (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с измененными параметрами для бинов и форматирования оси
hist(
  residuals3,
  breaks = 5,  
  main = "Гистограмма остатков",
  xlab = "Значение остатков",
  col = "lightblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X для удаления научной нотации
axis(1, at = pretty(residuals3), labels = format(pretty(residuals3), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(residuals3, main = "Q-Q график нормальности")
qqline(residuals3, col = "red")

# Сброс настроек отображения графиков на стандартные
par(mfrow = c(1, 1))

```
**Обнаружения:** Гистограмма остатков, кажется, показывает распределение, которое выглядит нормально распределенным и не имеет заметных разрывов, что обычно поддерживает предположение о нормальности для модели. Однако Q-Q график не следует прямой линии, что в целом указывает на то, что предположение о нормальности не выполнено в полной мере.

Кажется, существует противоречие в обнаружениях: если Q-Q график не следует прямой линии, это предполагает, что остатки не распределены нормально, что обычно не поддерживает предположение о нормальности. Несоответствие между гистограммой и Q-Q графиком требует тщательного анализа. Хотя гистограммы полезны для визуализации общего распределения, Q-Q графики являются более надежным инструментом для оценки нормальности.

Учитывая, что Q-Q график не указывает на нормальность, скорее всего, остатки не соответствуют предположению о нормальности для этой модели.


#### Предположение о постоянной дисперсии

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление предсказанных значений и остатков
fitted_values3 <- fitted(mfl_model_or3)
residuals3 <- resid(mfl_model_or3)

# Построение диаграммы рассеяния предсказанных значений против остатков
plot(fitted_values3, residuals3, 
     xlab = "Предсказанные значения", 
     ylab = "Остатки", 
     main = "Предсказанные значения против остатков", 
     pch = 19, col = "blue")
abline(h = 0, col = "red", lty = 2)

```
**Обнаружения:** Распределение предсказанных значений дисперсии выглядит согласованным, что поддерживает предположение о гомоскедастичности (постоянной дисперсии) в модели. Это означает, что изменчивость остатков примерно одинакова на всех уровнях независимых переменных, что свидетельствует о том, что модель, вероятно, хорошо специфицирована с точки зрения предположения о равенстве дисперсий.
Предположение о гомоскедастичности имеет ключевое значение для надежных статистических выводов, таких как точные p-значения и доверительные интервалы. Поскольку это предположение выполнено, результаты модели, включая предсказания и тесты гипотез, скорее всего, будут более надежными и устойчивыми.


#### Предположение об отсутствии мультиколлинеарности


```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения об отсутствии мультиколлинеарности
columns3 <- c('poil', 'GDD_Elc_R_y', 
             'GDD_R_y', 'OR_Loss_in_assets')

# Создание пары графиков для выбранных столбцов
ggpairs(model_data[, columns3])

# Расчет VIF для модели
vif_result3 <- vif(mfl_model_or3)

# Преобразование результатов VIF в дата-фрейм
df_vif3 <- data.frame(VIF = vif_result3)
df_vif3

```
**Обнаружения:** Значения коэффициента инфляции дисперсии (VIF) показывают, что существует низкая или умеренная мультиколлинеарность между макроэкономическими переменными poil (Цена на нефть марки Brent) и GDD_Elc_R_y (Реальная валовая добавленная стоимость - Электричество), что находится в пределах приемлемых уровней. Однако GDD_R_y (Реальная валовая добавленная стоимость) демонстрирует высокую мультиколлинеарность, что может вызвать трудности в интерпретации модели и ее коэффициентов.

Высокая мультиколлинеарность между независимыми переменными может привести к увеличению стандартных ошибок и затруднить оценку индивидуального воздействия каждой переменной на зависимую переменную. Для решения этой проблемы возможным вариантом может быть удаление или комбинирование сильно скоррелированных предсказателей, либо использование таких методов, как Регрессия Риджа или Анализ главных компонент (PCA), чтобы смягчить последствия мультиколлинеарности при сохранении предсказательной точности.


#### Модель множественной линейной регрессии 4

```{r}
# Построение множественной линейной регрессионной модели
mfl_model_or4 <- lm(OR_Loss_in_assets ~ GDD_Agr_R_y + 
                      GDD_Trn_R_y + GDD_Est_R_y, data = model_data)

# Резюме модели
summary(mfl_model_or4)
```
#### Создание корреляционной матрицы

```{r}
kendall_corr4 <- model_data %>% 
  dplyr::select(GDD_Agr_R_y, GDD_Trn_R_y, GDD_Est_R_y, OR_Loss_in_assets)

# Вычисление корреляционной матрицы по методу Кендалла
kendall_corr4 <- cor(kendall_corr4, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr4)

```
```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация корреляционной матрицы Кендалла с помощью корреляционного графика
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr4, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)

```
**Обнаружения:** Анализ корреляции между независимыми и зависимыми переменными выявляет умеренную отрицательную корреляцию, что свидетельствует о противоположной зависимости между макроэкономическими переменными и убытками от операционного риска. В частности, с увеличением некоторых макроэкономических индикаторов (таких как ВВП, инфляция или цены на нефть) соответствующие убытки от операционного риска, как правило, уменьшаются, и наоборот.

Эта обратная зависимость является важным выводом для интерпретации результатов модели. Это указывает на то, что благоприятные макроэкономические условия, такие как более высокий экономический рост или низкая инфляция, могут быть связаны с меньшими убытками от операционного риска. Понимание этой динамики может быть ключевым для прогнозирования того, как изменения в макроэкономической среде могут повлиять на риск-профиль организации, а также для разработки стратегий по снижению этих рисков. Однако также важно дополнительно исследовать, сохраняется ли эта зависимость в различных экономических контекстах или в разные временные периоды.

#### Предположение о линейности

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = model_data, aes(x = GDD_Agr_R_y, y = OR_Loss_in_assets)) +
geom_point() +
stat_smooth(method = "lm", col = "red") +
labs(title = "Диаграмма рассеяния GDD_Agr_R_y и Убытки от ОР",
x = "GDD_Agr_R_y", y = "OR_Loss_in_assets") +
theme_minimal()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = model_data, aes(x = GDD_Trn_R_y, y = OR_Loss_in_assets)) +
geom_point() +
stat_smooth(method = "lm", col = "green") +
labs(title = "Диаграмма рассеяния GDD_Trn_R_y и Убытки от ОР",
x = "GDD_Trn_R_y", y = "OR_Loss_in_assets") +
theme_minimal()
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = model_data, aes(x = GDD_Est_R_y, y = OR_Loss_in_assets)) +
geom_point() +
stat_smooth(method = "lm", col = "blue") +
labs(title = "Диаграмма рассеяния GDD_Est_R_y и Убытки от ОР",
x = "GDD_Est_R_y", y = "OR_Loss_in_assets") +
theme_minimal()
```
**Обнаружения:** Сложность в подтверждении наличия линейных связей между независимыми переменными (макроэкономическими показателями) и зависимой переменной (потери от операционных рисков) указывает на то, что предположение о линейности может быть нарушено. Предположение о линейности требует, чтобы связь между предсказателями и переменной ответа была линейной, и если это предположение не выполняется, модель может не точно отражать истинную связь.

Учитывая, что отношения между макроэкономическими факторами и потерями от операционных рисков, вероятно, являются сложными и потенциально нелинейными, использование линейных моделей может привести к предвзятым или неэффективным прогнозам. В этом контексте стресс-тестирование с использованием линейных моделей может дать вводящие в заблуждение результаты о потенциальном воздействии или серьезности потерь от операционных рисков, что может негативно сказаться на принятии решений и стратегиях управления рисками.

Для решения этой проблемы можно рассмотреть альтернативные подходы к моделированию (например, нелинейные модели, методы машинного обучения), которые лучше улавливают сложность связей и обеспечивают более точную оценку рисков.

#### Предположение о нормальности

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление остатков модели
residuals4 <- resid(mfl_model_or4)

# Создание сетки графиков 1x2 (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настроенными интервалами и форматированием осей
hist(
residuals4,
breaks = 5,  
main = "Гистограмма остатков",
xlab = "Значение остатков",
col = "lightblue",
border = "black",
xaxt = "n"
)

# Настройка оси X для исключения научной нотации
axis(1, at = pretty(residuals4), labels = format(pretty(residuals4),
scientific = FALSE))

# Q-Q график остатков
qqnorm(residuals4, main = "Нормальный Q-Q график")
qqline(residuals4, col = "red")

# Сброс настроек компоновки графиков на значения по умолчанию
par(mfrow = c(1, 1))
```
**Обнаружения:** Гистограмма остатков показывает распределение, которое почти соответствует нормальному, без заметных пробелов в распределении остатков, что предполагает, что предположение о нормальности может быть в разумной степени выполнено. Однако Q-Q график, который должен следовать прямой линии для нормально распределённых данных, указывает на нарушение предположения о нормальности.

Это противоречие между гистограммой и Q-Q графиком говорит о том, что, хотя остатки на первый взгляд могут казаться почти нормальными, всё же существуют отклонения от нормальности, которые могут повлиять на статистические выводы, такие как p-значения и доверительные интервалы. Если предположение о нормальности нарушено, надёжность проверок гипотез и прогнозов может быть подорвана, особенно при построении предсказательных интервалов или оценке неопределённости в модели.

Важно тщательно учитывать последствия этого нарушения при интерпретации результатов модели и проявлять осторожность при принятии решений на основе этих прогнозов. Дополнительные диагностические проверки или альтернативные подходы к моделированию могут помочь смягчить эти проблемы.


#### Предположение о постоянной дисперсии

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление предсказанных значений и остатков
fitted_values4 <- fitted(mfl_model_or4)
residuals4 <- resid(mfl_model_or4)

# Построение графика остатков от предсказанных значений
plot(fitted_values4, residuals4, 
     xlab = "Предсказанные значения", 
     ylab = "Остатки", 
     main = "График остатков от предсказанных значений", 
     pch = 19, col = "blue")
abline(h = 0, col = "red", lty = 2)
```
**Обнаружения:** Исследование предсказанных значений дисперсии показывает, что их распределение не является однородным, что свидетельствует о неполном выполнении предположения о гомоскедастичности (постоянстве дисперсии). Другими словами, дисперсия остатков не остается постоянной на всех уровнях независимых переменных, что указывает на наличие гетероскедастичности.
Гетероскедастичность может привести к следующим проблемам:
Неэффективности оценок коэффициентов регрессии
Снижению надежности статистических тестов (например, проверки гипотез)
Смещению стандартных ошибок коэффициентов
Искажению доверительных интервалов (их необоснованному расширению или сужению)
Некорректной интерпретации p-значений.

#### Проверка допущения об отсутствии мультиколлинеарности

```{r fig.align="center", fig.width=6, fig.height=4}
# Выбираем колонки для анализа
columns4 <- c('GDD_Agr_R_y', 'GDD_Trn_R_y', 
             'GDD_Est_R_y', 'OR_Loss_in_assets')

# Создаем парный график для выбранных переменных
ggpairs(model_data[, columns4])

# Вычисляем коэффициент инфляции дисперсии (VIF) для модели
vif_result4 <- vif(mfl_model_or4)

# Преобразуем результаты VIF в таблицу данных
df_vif4 <- data.frame(VIF = vif_result4)
df_vif4
```
**Обнаружения:** Значение коэффициента инфляции дисперсии (VIF) менее 2, что указывает на низкую мультиколлинеарность между независимыми переменными, что вполне соответствует допустимым уровням. Это предполагает, что между предсказателями нет значительной избыточности, что позволяет модели оценивать эффекты каждой независимой переменной на зависимую переменную без проблем, связанных с мультиколлинеарностью.
Низкая мультиколлинеарность гарантирует, что коэффициенты, оцененные моделью регрессии, стабильны и надежны, что позволяет более точно интерпретировать взаимосвязи между предсказателями и зависимой переменной. Таким образом, дополнительных действий по устранению мультиколлинеарности в данной модели не требуется.

### Сравнительный анализ производительности моделей

```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели множественной регрессии 1
options(scipen = 999)
mse_mfl_model_or <- mean(mfl_model_or$residuals^2)
rmse_mfl_model_or <- sqrt(mse_mfl_model_or)
r_squared <- summary(mfl_model_or)$r.squared
adj_r_squared <- summary(mfl_model_or)$adj.r.squared
cat("Средняя квадратичная ошибка (MSE):", 
    mse_mfl_model_or, "\n")
cat("Корень из средней квадратичной ошибки (RMSE):", 
    rmse_mfl_model_or, "\n")
cat("R-квадрат (Коэффициент детерминации):", 
    r_squared, "\n")
cat("Скорректированный R-квадрат (Коэффициент детерминации):", 
    adj_r_squared, "\n")

```

```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели множественной регрессии 2
options(scipen = 999)
mse_mfl_model_or2 <- mean(mfl_model_or2$residuals^2)
rmse_mfl_model_or2 <- sqrt(mse_mfl_model_or2)
r_squared2 <- summary(mfl_model_or2)$r.squared
adj_r_squared2 <- summary(mfl_model_or2)$adj.r.squared
cat("Средняя квадратичная ошибка (MSE):", 
    mse_mfl_model_or2, "\n")
cat("Корень из средней квадратичной ошибки (RMSE):", 
    rmse_mfl_model_or2, "\n")
cat("R-квадрат (Коэффициент детерминации):", 
    r_squared2, "\n")
cat("Скорректированный R-квадрат (Коэффициент детерминации):", 
    adj_r_squared2, "\n")

```

```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели множественной регрессии 3
options(scipen = 999)
mse_mfl_model_or3 <- mean(mfl_model_or3$residuals^2)
rmse_mfl_model_or3 <- sqrt(mse_mfl_model_or3)
r_squared3 <- summary(mfl_model_or3)$r.squared
adj_r_squared3 <- summary(mfl_model_or3)$adj.r.squared
cat("Средняя квадратичная ошибка (MSE):", 
    mse_mfl_model_or3, "\n")
cat("Корень из средней квадратичной ошибки (RMSE):", 
    rmse_mfl_model_or3, "\n")
cat("R-квадрат (Коэффициент детерминации):", 
    r_squared3, "\n")
cat("Скорректированный R-квадрат (Коэффициент детерминации):", 
    adj_r_squared3, "\n")

```

```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели множественной регрессии 4
options(scipen = 999)
mse_mfl_model_or4 <- mean(mfl_model_or4$residuals^2)
rmse_mfl_model_or4 <- sqrt(mse_mfl_model_or4)
r_squared4 <- summary(mfl_model_or4)$r.squared
adj_r_squared4 <- summary(mfl_model_or4)$adj.r.squared
cat("Средняя квадратичная ошибка (MSE):", 
    mse_mfl_model_or4, "\n")
cat("Корень из средней квадратичной ошибки (RMSE):", 
    rmse_mfl_model_or4, "\n")
cat("R-квадрат (Коэффициент детерминации):", 
    r_squared4, "\n")
cat("Скорректированный R-квадрат (Коэффициент детерминации):", 
    adj_r_squared4, "\n")

```

```{r}
# Создание дата-фрейма с метриками производительности модели
mfl_model_results <- data.frame(
  Model = c("Модель линейной регрессии 1", "Модель линейной регрессии 2", 
            "Модель линейной регрессии 3", "Модель линейной регрессии 4"),
  MSE = c(0.0000001254494, 0.0000001279794, 0.0000001281818, 0.0000001313972),
  RMSE = c(0.0003541884, 0.0003577421, 0.0003580249, 0.0003624875),
  R_squared = c(0.4426, 0.4314, 0.4305, 0.4162),
  Adjusted_R_squared = c(0.3590, 0.3461, 0.3451, 0.3451)
)

kable(mfl_model_results, format = "markdown", digits = 10, 
      caption = "Метрики производительности линейной модели")

```

### Промежуточные выводы
Модель 1, которая включает макроэкономические переменные:

GDD_Trn_R_y (Реальная валовая добавленная стоимость - Транспорт)

GDD_Inf_R_y (Реальная валовая добавленная стоимость - Информация)

Rincpop_q_y (Реальный средний месячный доход на душу населения)

показала наилучшие результаты с наименьшей ошибкой предсказания (MSE: 0.0000001254494, RMSE: 0.0003541884), самым высоким R^2 (0.4426) и скорректированным R^2 (0.3590). Эти метрики свидетельствуют о том, что Модель 1 объясняет наибольшую дисперсию целевой переменной, что делает её наиболее эффективной для прогнозирования убытков по операционному риску среди протестированных моделей.

С другой стороны, Модель 4 показала наихудшие результаты с самой высокой MSE и RMSE, а также самым низким R^2, что указывает на её неэффективность в захвате взаимосвязи между макроэкономическими переменными и убытками по операционному риску.

Несмотря на хорошие результаты, Модель 1 не полностью соответствует ключевым предположениям регрессии, особенно линейности и нормальности. Учитывая нарушение этих предположений, будет проведено исследование нелинейных моделей для улучшения производительности и лучшего захвата скрытых сложностей взаимосвязи. Эти модели включают:

Множественная полиномиальная регрессия: для захвата более высоких порядков взаимосвязи между предсказателями и зависимой переменной.

Обобщённые аддитивные модели (GAM): для учета гибких, нелинейных взаимосвязей между переменными без жестких требований к линейности.

После реализации этих нелинейных подходов будет выбрана наиболее подходящая модель на основе её способности лучше удовлетворять предположения, снижать ошибку предсказания и улучшать прогнозирование сценариев.


## Конструирование модели множественной полиномиальной регрессии
Для дальнейшего улучшения производительности модели и проверки соответствия предположений моделирования будет применена множественная полиномиальная регрессия для лучшей комбинации макроэкономических переменных, выявленных в Модели 1:

GDD_Trn_R_y (Реальная валовая добавленная стоимость - Транспорт)

GDD_Inf_R_y (Реальная валовая добавленная стоимость - Информация)

Rincpop_q_y (Реальный средний месячный доход на душу населения).

Применение полиномиальных членов позволит нам захватить возможные нелинейные взаимосвязи между этими макроэкономическими переменными и убытками по операционному риску. Затем мы оценим производительность модели с точки зрения:

Точности предсказания (MSE, RMSE, R^2, скорректированный R^2)

Ключевых предположений регрессии (линейность, нормальность и гомоскедастичность)

Этот подход обеспечит более гибкую модель для лучшего объяснения взаимосвязи между макроэкономическими факторами и убытками по операционному риску и поможет определить, приводит ли нелинейная модель к лучшему соответствию данным. После оценки результатов мы сможем определить, улучшает ли полиномиальная регрессия предположения модели и её предсказательную способность.

### Применение модели множественной полиномиальной регрессии
#### Формулировка гипотез:
Нулевая гипотеза (H0): Макроэкономические переменные не связаны с убытками по операционному риску.
Альтернативная гипотеза (Ha): Макроэкономические переменные связаны с убытками по операционному риску.
Уровень значимости установлен на 0,1 (доверительный интервал 90%), а допустимый порог R^2 (коэффициент детерминации) установлен на 0,35 (35%).

#### Модель множественной полиномиальной регрессии с полиномиальной трансформацией второй степени

```{r}
# Построение модели множественной полиномиальной регрессии
poly_model_or <- lm(OR_Loss_in_assets ~ poly(GDD_Trn_R_y, 2) + 
                                        poly(GDD_Inf_R_y, 2) + 
                                        poly(Rincpop_q_y, 2), 
                     data = model_data)

summary(poly_model_or)

```
**Обнаружения:** Константный коэффициент в модели полиномиальной регрессии оказался высоко значимым с p-значением менее 0.001, что указывает на важность этого термина для предсказания убытков от операционного риска. Нулевая гипотеза (H0) отклоняется, и принимается альтернативная гипотеза (Ha). Однако полиномиальные термины для независимых переменных (GDD_Trn_R_y, GDD_Inf_R_y и Rincpop_q_y) не являются статистически значимыми, поскольку их p-значения превышают 0.1. Это означает, что добавление полиномиальных термов для этих переменных не улучшает производительность модели, и модель может быть излишне сложной для данных. Множественный R^2 равное 0.449 указывает на то, что модель объясняет около 44.9% дисперсии убытков от операционного риска (OR_Loss_in_assets), что является достаточно хорошей подгонкой, хотя и не идеальной. Скорректированное R^2, равное 0.2546, значительно ниже, чем R^2, что предполагает возможность переобучения модели. Это означает, что хотя модель хорошо подгоняется к данным, она может плохо обобщаться на новые данные из-за включения ненужных предсказателей.

#### Визуализация Полинимиальной регрессии второй степени
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = GDD_Trn_R_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. GDD_Trn_R_y")

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = GDD_Inf_R_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. GDD_Inf_R_y")
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = Rincpop_q_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. Rincpop_q_y")

```
**Обнаружения:** Полиномиальная регрессия второй степени была применена к данным, и полученная сглаженная кривая захватывает некоторые потенциальные нелинейные зависимости. Однако кривая кажется относительно плоской, с легким изгибом, что указывает на то, что нелинейная зависимость между независимыми и зависимыми переменными минимальна. 

Несмотря на захват некоторых нелинейностей, полиномиальная регрессия не демонстрирует сильной нелинейной связи между переменными, что говорит о том, что полином второй степени может быть не лучшей моделью для этих переменных.

Учитывая, что модель показывает только легкий изгиб, вероятно, для более точного описания более сложных зависимостей может потребоваться полином более высокого порядка. Альтернативно, можно исследовать другие нелинейные модели, такие как Обобщенные Аддитивные Модели (GAM), для лучшего представления потенциальных нелинейных динамик в данных.


#### Множественная полиномиальная регрессия с преобразованием полинома третьей степени

```{r}
# Построение модели множественной полиномиальной регрессии
poly_model_or2 <- lm(OR_Loss_in_assets ~ poly(GDD_Trn_R_y, 3) + 
                                        poly(GDD_Inf_R_y, 3) + 
                                        poly(Rincpop_q_y, 3), 
                     data = model_data)

summary(poly_model_or2)
```
**Обнаружения:** Перехват в полиномиальной регрессии имеет высокую статистическую значимость, с p-значением менее 0.001 и оценкой 0.0019989, что указывает на его важную роль в объяснении зависимой переменной. Нулевая гипотеза (H0) отклоняется, а альтернативная гипотеза (Ha) принимается. Однако полиномиальные элементы для GDD_Trn_R_y, GDD_Inf_R_y и Rincpop_q_y статистически незначимы (все p-значения > 0.1). Это говорит о том, что добавление полиномиальных членов более высокой степени для этих переменных не значительно улучшает прогностическую способность модели. Значение Множественного R^2 составляет 0.5622, что означает, что модель объясняет примерно 56.2% дисперсии зависимой переменной (OR_Loss_in_assets), что указывает на неплохое соответствие. Однако скорректированное значение R^2 равно 0.2807, что значительно ниже значения R^2. Эта разница указывает на возможное переобучение модели, когда она хорошо подгоняется под тренировочные данные, но может не обобщаться эффективно на новые данные. Большой разрыв между R^2 и скорректированным R^2 говорит о том, что производительность модели, вероятно, завышена из-за включения слишком большого количества предсказателей.

#### Визуализация регрессии полинома третьей степени
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = GDD_Trn_R_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. GDD_Trn_R_y")

```
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = GDD_Inf_R_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. GDD_Inf_R_y")
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = Rincpop_q_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. Rincpop_q_y")
```
**Обнаружения:** Кривая регрессии полинома третьей степени была применена к данным, пытаясь захватить потенциальные нелинейные зависимости между независимыми переменными и зависимой переменной. Однако кривая кажется относительно плоской, с легким изгибом, что предполагает слабую нелинейную связь между переменными. Отсутствие выраженного изгиба в полиноме третьей степени указывает на то, что эта модель может не эффективно захватывать значимые нелинейные зависимости в данных. Хотя модель и пытается подогнать более сложную зависимость, она, возможно, не даст значительных улучшений по сравнению с полиномами более низкой степени. Это наблюдение подтверждает идею, что полином третьей степени может быть не оптимальным выбором для моделирования зависимости между макроэкономическими переменными и потерями от операционного риска. Дальнейшие исследования с полиномами более высокой степени или альтернативными нелинейными моделями (например, Обобщенными Аддитивными Моделями (GAM)) будут рассмотрены для лучшего захвата сложных зависимостей, если таковые существуют.

#### Множественная полиномиальная регрессия с преобразованием полинома шестой степени

```{r}
# Построение модели множественной полиномиальной регрессии
poly_model_or3 <- lm(OR_Loss_in_assets ~ poly(GDD_Trn_R_y, 6) + 
                                        poly(GDD_Inf_R_y, 6) + 
                                        poly(Rincpop_q_y, 6), 
                     data = model_data)

summary(poly_model_or3)
```
**Обнаружения:** Значимость перехвата: Перехват является статистически значимым (p-значение < 0.001), что говорит о том, что базовый уровень потерь от операционного риска (OR_Loss_in_assets) имеет статистическое значение в модели.
Нулевая гипотеза (H0) отклоняется, а альтернативная гипотеза (Ha) принимается.
Полиномиальные элементы: Полиномиальные элементы для GDD_Trn_R_y, GDD_Inf_R_y и Rincpop_q_y статистически незначимы (все p-значения > 0.1). Это означает, что добавление полиномиальных членов более высокой степени не существенно улучшает прогностическую способность модели, и эти элементы не добавляют значимой информации в модель.
Множественный R^2 составляет 0.8669, что означает, что модель объясняет примерно 86.7% дисперсии OR_Loss_in_assets, что является хорошим соответствием.
Однако скорректированное значение R^2 равно 0.2656, что значительно ниже значения R^2, что вызывает беспокойство по поводу переобучения модели.

#### Визуализация регрессии полинома шестой степени
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = GDD_Trn_R_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 6), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. GDD_Trn_R_y")
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = GDD_Inf_R_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 6), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. GDD_Inf_R_y")
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графика рассеяния для полиномиальной регрессии
ggplot(data = model_data, aes(x = Rincpop_q_y, y = OR_Loss_in_assets)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 6), se = TRUE) +
    labs(title = "Полиномиальная регрессия: OR_Loss_in_assets vs. Rincpop_q_y")
```
**Обнаружения:** Применение полинома шестой степени: Модель регрессии полинома шестой степени применяется к данным с плавной кривой, которая захватывает сложные закономерности. Однако кривая демонстрирует значительные колебания, что предполагает, что модель сильно чувствительна к незначительным изменениям в данных.
Риск переобучения: Сложность, введенная полиномом шестой степени, может приводить к переобучению. Модель, вероятно, захватывает шум или случайные колебания в данных, а не только основную зависимость, что приводит к плохой обобщаемости при применении к новым данным.
Сложность модели и прогностическая способность: Хотя полином шестой степени хорошо подгоняет данные, степень сложности может быть чрезмерной.


## Конструирование множественной обобщенной аддитивной модели (GAM)

### Применение множественной обобщенной аддитивной модели (Generalized Additive Model (GAM))

#### Формулировка гипотез:
Нулевая гипотеза (H0): Макроэкономические переменные не связаны с потерями от операционного риска.
Альтернативная гипотеза (Ha): Макроэкономические переменные связаны с потерями от операционного риска.
Уровень значимости α установлен на 0.1 (доверительный интервал 90%), а пороговое значение R² (коэффициент детерминации) установлено на 0.35 (35%).

```{r}
# Построение множественной обобщенной аддитивной модели (GAM)
gam_model_or <- gam(OR_Loss_in_assets ~ s(GDD_Trn_R_y) + 
                      s(GDD_Inf_R_y) + s(Rincpop_q_y), data = model_data)
summary(gam_model_or)
```
**Обнаружения:** Перехват в регрессии обобщенной аддитивной модели (GAM) имеет высокую статистическую значимость, с p-значением менее 0.001 и оценкой 0.0019989, что указывает на его важную роль в объяснении зависимой переменной.
Нулевая гипотеза (H0) отклоняется, а альтернативная гипотеза (Ha) принимается.
Подгонка модели: Обобщенная аддитивная модель (GAM) объясняет около 35.9% дисперсии целевой переменной (потери от операционного риска) на основе скорректированного значения R^2. Это указывает на разумное соответствие модели, с лучшим объяснением дисперсии по сравнению с некоторыми предыдущими моделями. Значение объясненной девиантности (Deviance Explained) 44.3% дополнительно подтверждает, что модель учитывает значительную долю необъясненной вариативности в данных.
Нелинейные эффекты: Плавные члены для GDD_Trn_R_y (реальный валовой добавленный продукт - транспорт) и Rincpop_q_y (реальный среднедушевой месячный доход населения) показывают значительные нелинейные зависимости с потерями от операционного риска, подчеркивая, что эти переменные влияют на целевую переменную нелинейным образом. Способность модели GAM захватывать эти нелинейности предоставляет преимущество перед более простыми линейными моделями.

#### Плавность и переобучение
```{r fig.align="center", fig.width=6, fig.height=4}
# Построение графиков гладких членов модели
par(mfrow = c(1, 3))
plot(gam_model_or, shade = TRUE, seWithMean = TRUE, 
     main = "GAM Smooth Terms")
```
**Обнаружения:** GDD_Trn_R_y (Реальный валовой добавленный продукт - Транспорт, преобразованный):
Гладкая нелинейная зависимость от потерь от операционного риска (OR_Loss_in_assets) указывает на убывающее трендовое поведение при определенных значениях GDD_Trn_R_y. Это предполагает, что по мере роста вклада транспортного сектора в экономику потери от операционного риска имеют тенденцию снижаться, по крайней мере, в рамках определенных диапазонов GDD_Trn_R_y.
GDD_Inf_R_y (Реальный валовой добавленный продукт - Информация, преобразованный):
Зависимость здесь более сложная, с небольшими колебаниями в разных значениях. Увеличивающийся тренд потерь от операционного риска с ростом значений GDD_Inf_R_y предполагает, что расширение информационного сектора может быть связано с увеличением операционных рисков на определенных уровнях.
Rincpop_q_y (Реальный среднедушевой месячный доход населения, преобразованный):
График показывает значительный нелинейный эффект, при котором потери от операционного риска уменьшаются с ростом уровня дохода. Это предполагает, что на более высоких уровнях дохода связанные операционные риски могут снижаться, что, возможно, отражает лучшую экономическую стабильность или меньшую восприимчивость к операционным сбоям в более состоятельных группах населения.

#### Допущение нормальности

```{r fig.align="center", fig.width=6, fig.height=4}
# Расчет остатков модели
residuals_gam <- resid(gam_model_or)

# Создание сетки 1x2 для графиков (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой количества корзин и формата осей
hist(
  residuals_gam,
  breaks = 5,  # Увеличить количество корзин
  main = "Гистограмма остатков",
  xlab = "Значение остатков",
  col = "lightgreen",
  border = "black",
  xaxt = "n"
)

# Настройка оси x для удаления научной нотации
axis(1, at = pretty(residuals_gam), labels = format(pretty(residuals_gam), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(residuals_gam, main = "Q-Q график нормальности")
qqline(residuals_gam, col = "red")

# Сбросить макет графиков на стандартный
par(mfrow = c(1, 1))

```
**Обнаружения:** Подобно модели множественной регрессии, модель обобщенного аддитивного (GAM) демонстрирует заметный разрыв в распределении остатков, что предполагает, что остатки не следуют нормальному распределению.
Q-Q график не совпадает с прямой линией, что подтверждает вывод о нарушении предположения о нормальности в данной модели.
Предположение о нормальности имеет важное значение, особенно при проведении статистического вывода (например, тестирования гипотез и построения доверительных интервалов).
Когда остатки отклоняются от нормальности, p-значения и доверительные интервалы могут стать ненадежными, что приведет к возможной неправильной интерпретации значимости модели. Прогностическая точность модели, особенно в случаях, связанных с оценкой неопределенности (таких как интервалы предсказания), может быть нарушена.



#### Предположение о постоянной дисперсии


```{r fig.align="center", fig.width=6, fig.height=4}
# Расчет предсказанных значений и остатков
fitted_gam <- fitted(gam_model_or)
residuals_gam <- resid(gam_model_or)

# Создание диаграммы рассеяния предсказанных значений против остатков
plot(fitted_gam, residuals_gam, 
     xlab = "Предсказанные значения", 
     ylab = "Остатки", 
     main = "Предсказанные значения против остатков", 
     pch = 19, col = "blue")
abline(h = 0, col = "red", lty = 2)

```
**Обнаружения:** Распределение дисперсии предсказанных значений является стабильным, что подтверждает выполнение предположения о гомоскедастичности (постоянной дисперсии). Остатки случайным образом распределены без явных закономерностей, что дополнительно подтверждает корректность предположения о гомоскедастичности.


#### Независимость остатков (Автокорреляция)


```{r}
# Применение теста Дурбина-Уотсона для проверки наличия автокорреляции в остатках модели регрессии
dwtest(gam_model_or)

```
**Обнаружения:** Тест Дурбина-Уотсона на автокорреляцию в остатках модели обобщенной аддитивной модели (Generalized Additive Model) (GAM) дал статистику теста DW = 2.4683 с p-значением 0.7032. Статистика DW, близкая к 2, свидетельствует об отсутствии значимой автокорреляции в остатках. P-значение 0.7032, которое значительно выше типичного уровня значимости 0.05, указывает на то, что мы не можем отклонить нулевую гипотезу об отсутствии автокорреляции. Следовательно, мы заключаем, что в остатках нет значимой автокорреляции, и предположение о независимости остатков выполнено. Это предполагает, что модель подходит для надежных предсказаний без опасений относительно влияния автокорреляции на результаты.


### Сравнительный анализ производительности моделей

```{r}
# Проверка Среднеквадратичной Ошибки (MSE) и Корня Среднеквадратичной Ошибки (RMSE)
# для Модели Множественной Полиномиальной Регрессии 1
options(scipen = 999)
mse_poly_model_or <- mean(poly_model_or$residuals^2)
rmse_poly_model_or <- sqrt(mse_poly_model_or)
r_squared5 <- summary(poly_model_or)$r.squared
adj_r_squared5 <- summary(poly_model_or)$adj.r.squared
cat("Среднеквадратичная Ошибка (MSE):", 
    mse_poly_model_or, "\n")
cat("Корень Среднеквадратичной Ошибки (RMSE):", 
    rmse_poly_model_or, "\n")
cat("R квадрат (Коэффициент Детеминации):", 
    r_squared5, "\n")
cat("Скорректированный R квадрат (Коэффициент Детеминации):", 
    adj_r_squared5, "\n")

```

```{r}
# Проверка Среднеквадратичной Ошибки (MSE) и Корня Среднеквадратичной Ошибки (RMSE) 
# для Модели Множественной Полиномиальной Регрессии 2
options(scipen = 999)
mse_poly_model_or2 <- mean(poly_model_or2$residuals^2)
rmse_poly_model_or2 <- sqrt(mse_poly_model_or2)
r_squared6 <- summary(poly_model_or2)$r.squared
adj_r_squared6 <- summary(poly_model_or2)$adj.r.squared
cat("Среднеквадратичная Ошибка (MSE):", 
    mse_poly_model_or2, "\n")
cat("Корень Среднеквадратичной Ошибки (RMSE):", 
    rmse_poly_model_or2, "\n")
cat("R квадрат (Коэффициент Детеминации):", 
    r_squared6, "\n")
cat("Скорректированный R квадрат (Коэффициент Детеминации):", 
    adj_r_squared6, "\n")

```

```{r}
# Проверка Среднеквадратичной Ошибки (MSE) и Корня Среднеквадратичной Ошибки (RMSE) 
# для Модели Множественной Полиномиальной Регрессии 3
options(scipen = 999)
mse_poly_model_or3 <- mean(poly_model_or3$residuals^2)
rmse_poly_model_or3 <- sqrt(mse_poly_model_or3)
r_squared7 <- summary(poly_model_or3)$r.squared
adj_r_squared7 <- summary(poly_model_or3)$adj.r.squared
cat("Среднеквадратичная Ошибка (MSE):", 
    mse_poly_model_or3, "\n")
cat("Корень Среднеквадратичной Ошибки (RMSE):", 
    rmse_poly_model_or3, "\n")
cat("R квадрат (Коэффициент Детеминации):", 
    r_squared7, "\n")
cat("Скорректированный R квадрат (Коэффициент Детеминации):", 
    adj_r_squared7, "\n")

```

```{r}
# Проверка Среднеквадратичной Ошибки (MSE) и Корня Среднеквадратичной Ошибки (RMSE) 
# для Модели Множественного Обобщённого Аддитивного Моделирования (GAM)
options(scipen = 999)
mse_gam_model_or <- mean(gam_model_or$residuals^2)
rmse_gam_model_or <- sqrt(mse_gam_model_or)
deviance_explained <- summary(gam_model_or)$dev.explained
adj_r_squared8 <- (summary(gam_model_or)$r.sq)
cat("Среднеквадратичная Ошибка (MSE):", 
    mse_gam_model_or, "\n")
cat("Корень Среднеквадратичной Ошибки (RMSE):", 
    rmse_gam_model_or, "\n")
cat("Скорректированный R квадрат (Коэффициент Детеминации):", 
    adj_r_squared8, "\n")

```

```{r}
# Создание таблицы с метриками производительности моделей
total_model_results_or <- data.frame(
  Model = c("Множественная регрессионная модель 1", "Множественная регрессионная модель 2", 
            "Множественная регрессионная модель 3", "Множественная регрессионная модель 4", 
            "Множественная полиномиальная модель 1", "Множественная полиномиальная модель 2", 
            "Множественная полиномиальная модель 3", "Обобщённая аддитивная модель (GAM)"),
  MSE = c(0.0000001254494, 0.0000001279794, 0.0000001281818, 
          0.0000001313972, 0.0000000692838, 0.00000009855074, 
          0.00000002995745, 0.00000002995745),
  RMSE = c(0.0003541884, 0.0003577421, 0.0003580249, 0.0003624875, 
           0.0002632182, 0.0003139279, 0.0001730822, 0.0003541881),
  R_squared = c(0.4426, 0.4314, 0.4305, 0.4162, 0.6921818, 
                0.5621529, 0.8669032, 0.4426469),
  Adjusted_R_squared = c(0.3590, 0.3461, 0.3451, 0.3451, 0.1150226,
                         0.2806797, 0.3877549, 0.3590417)
)

kable(total_model_results_or, format = "markdown", digits = 10, 
      caption = "Метрики производительности линейных и нелинейных моделей - Сравнение")

```

### Промежуточные выводы
При сравнении различных моделей для следующих макроэкономических переменных: GDD_Trn_R_y (Реальная валовая добавленная стоимость — Транспорт), GDD_Inf_R_y (Реальная валовая добавленная стоимость — Информация), Rincpop_q_y (Среднемесячный доход на душу населения), были получены следующие ключевые показатели:

Метрики производительности модели:

MSE (Среднеквадратичная ошибка) и RMSE (Квадратный корень из среднеквадратичной ошибки): Меньшие значения указывают на лучшую производительность модели. Множественная полиномиальная модель 3 и обобщённая аддитивная модель (GAM) показывают самые низкие значения MSE и RMSE, что указывает на лучшую предсказательную точность с точки зрения ошибки.

R-квадрат: Более высокое значение R-квадрата указывает на лучшее соответствие модели. Множественная полиномиальная модель 3 достигает самого высокого R-квадрата (0.8669), в то время как GAM имеет значительно более низкое значение (0.4426).

Скорректированный R-квадрат: Эта метрика учитывает количество предсказателей, предлагая более надёжную меру для сравнения моделей с различной сложностью. Множественная полиномиальная модель 3 имеет самый высокий скорректированный R-квадрат (0.3878), что указывает на лучший баланс между сложностью модели и её соответствием по сравнению с Множественными полиномиальными моделями 1 и 2, которые имеют более низкие значения скорректированного R-квадрата.

Выбор лучшей модели:

Множественная полиномиальная модель 3 является лучшей по предсказательной точности, с наименьшими значениями MSE, самым высоким R-квадратом и сильным скорректированным R-квадратом. Однако статистическая значимость её переменных превышает альфа = 0.1, что вызывает сомнения относительно надёжности предсказателей модели.

С другой стороны, обобщённая аддитивная модель (GAM) демонстрирует более стабильные результаты, с скорректированным R-квадратом выше 0.35 (35%), хотя она уступает полиномиальным моделям по R-квадрату и скорректированному R-квадрату. Стоит отметить, что статистическая значимость переменных в модели GAM ниже α = 0.1, что делает её более статистически надёжной, чем полиномиальные модели.

**Заключение:** С учетом как статистической значимости, так и производительности моделей, обобщённая аддитивная модель (GAM) представляется оптимальным выбором. Она предлагает сбалансированное соотношение между предсказательной силой, ошибочными метриками и интерпретируемостью модели, обеспечивая надёжные предсказания при сохранении статистической значимости.

## Конструирование модели с множественной моделью Пуассона
### Предобработка данных по частоте операционных рисков (по числу)
#### Операционный риск тип 1
```{r}
# Группировка операционного риска Тип 1 по месяцам
or_type1_bymonths <- or_type1 %>% 
  mutate(YearMonth = format(Date, "%Y-%m")) %>%
  group_by(YearMonth) %>% 
  summarise(Frequency_Monthly = n())
print(or_type1_bymonths)
or_type1_bymonths <- as.data.frame(or_type1_bymonths)
head(or_type1_bymonths)

```
```{r}
# Группировка и форматирование как "YYYY-MM-DD" 
# для последнего дня квартала
or_type1_byquarters <- or_type1_bymonths %>%
  mutate(
    Date = ym(YearMonth),                               
    Year = year(Date),                                
    Quarter = quarter(Date),                            
    EndOfQuarter = case_when(                            
      Quarter == 1 ~ make_date(Year, 3, 31),
      Quarter == 2 ~ make_date(Year, 6, 30),
      Quarter == 3 ~ make_date(Year, 9, 30),
      Quarter == 4 ~ make_date(Year, 12, 31)
    )
  ) %>%
  group_by(EndOfQuarter) %>%
  summarize(Frequency_Quarterly = sum(Frequency_Monthly), 
            .groups = "drop")

```

```{r}
# Проверка данных
print(or_type1_byquarters)
head(or_type1_byquarters)
tail(or_type1_byquarters)

```

#### Операционный риск тип 2

```{r}
# Группировка операционного риска Тип 2 по месяцам
or_type2_bymonths <- or_type2 %>% 
  mutate(YearMonth = format(Date, "%Y-%m")) %>%
  group_by(YearMonth) %>% 
  summarise(Frequency_Monthly = n())
print(or_type2_bymonths)
or_type2_bymonths <- as.data.frame(or_type2_bymonths)
head(or_type2_bymonths)
```
```{r}
# Группировка и форматирование как "YYYY-MM-DD" 
# для последнего дня квартала
or_type2_byquarters <- or_type2_bymonths %>%
  mutate(
    Date = ym(YearMonth),                               
    Year = year(Date),                                  
    Quarter = quarter(Date),                             
    EndOfQuarter = case_when(                           
      Quarter == 1 ~ make_date(Year, 3, 31),
      Quarter == 2 ~ make_date(Year, 6, 30),
      Quarter == 3 ~ make_date(Year, 9, 30),
      Quarter == 4 ~ make_date(Year, 12, 31)
    )
  ) %>%
  group_by(EndOfQuarter) %>%
  summarize(Frequency_Quarterly = sum(Frequency_Monthly), 
            .groups = "drop")
or_type2_byquarters <- or_type2_byquarters %>% 
  dplyr:: select(-EndOfQuarter)
```

```{r}
# Проверка данных
print(or_type2_byquarters)
head(or_type2_byquarters)
tail(or_type2_byquarters)
```
#### Операционный риск тип 3

```{r}
# Группировка операционного риска Тип 3 по месяцам
or_type3_bymonths <- or_type3 %>% 
  mutate(YearMonth = format(Date, "%Y-%m")) %>%
  group_by(YearMonth) %>% 
  summarise(Frequency_Monthly = n())
print(or_type3_bymonths)
or_type3_bymonths <- as.data.frame(or_type3_bymonths)
head(or_type3_bymonths)
```
```{r}
# Группировка и форматирование как "YYYY-MM-DD" 
# для последнего дня квартала
or_type3_byquarters <- or_type3_bymonths %>%
  mutate(
    Date = ym(YearMonth),                                
    Year = year(Date),                                  
    Quarter = quarter(Date),                             
    EndOfQuarter = case_when(                            
      Quarter == 1 ~ make_date(Year, 3, 31),
      Quarter == 2 ~ make_date(Year, 6, 30),
      Quarter == 3 ~ make_date(Year, 9, 30),
      Quarter == 4 ~ make_date(Year, 12, 31)
    )
  ) %>%
  group_by(EndOfQuarter) %>%
  summarize(Frequency_Quarterly = sum(Frequency_Monthly), 
            .groups = "drop")

or_type3_byquarters <- or_type3_byquarters %>% 
  dplyr:: select(-EndOfQuarter)
```

```{r}
# Проверка данных
print(or_type3_byquarters)
head(or_type3_byquarters)
tail(or_type3_byquarters)
```
#### Операционный риск тип 4

```{r}
# Группировка операционного риска Тип 4 по месяцам
or_type4_bymonths <- or_type4 %>% 
  mutate(YearMonth = format(Date, "%Y-%m")) %>%
  group_by(YearMonth) %>% 
  summarise(Frequency_Monthly = n())
print(or_type4_bymonths)
or_type4_bymonths <- as.data.frame(or_type4_bymonths)
head(or_type4_bymonths)
```

```{r}
# Группировка и форматирование как "YYYY-MM-DD" 
# для последнего дня квартала
or_type4_byquarters <- or_type4_bymonths %>%
  mutate(
    Date = ym(YearMonth),                                
    Year = year(Date),                                   
    Quarter = quarter(Date),                           
    EndOfQuarter = case_when(                          
      Quarter == 1 ~ make_date(Year, 3, 31),
      Quarter == 2 ~ make_date(Year, 6, 30),
      Quarter == 3 ~ make_date(Year, 9, 30),
      Quarter == 4 ~ make_date(Year, 12, 31)
    )
  ) %>%
  group_by(EndOfQuarter) %>%
  summarize(Frequency_Quarterly = sum(Frequency_Monthly), .groups = "drop")

or_type4_byquarters <- or_type4_byquarters %>% 
  dplyr:: select(-EndOfQuarter)
```

```{r}
# Проверка данных
print(or_type4_byquarters)
head(or_type4_byquarters)
tail(or_type4_byquarters)
```

#### Создание объединенной таблицы частот операционного риска (в числах)

```{r}
# Создание объединенной таблицы частот операционного риска (в числах)
freq_or_losses <- cbind(or_type1_byquarters, or_type2_byquarters, 
                        or_type3_byquarters, or_type4_byquarters)
colnames(freq_or_losses) <- make.unique(colnames(freq_or_losses))
str(freq_or_losses)
```
```{r}
# Создание столбца "Total_freq" и расчет общих частот для всех типов операционного риска
freq_or_losses$Total_freq <- freq_or_losses$Frequency_Quarterly + 
  freq_or_losses$Frequency_Quarterly.1 + 
  freq_or_losses$Frequency_Quarterly.2 + 
  freq_or_losses$Frequency_Quarterly.3
str(freq_or_losses)
```
```{r}
# Фильтрация данных для периода с 1 квартала 2011 года по 4 квартал 2016 года
freq_or_losses_filtered <- freq_or_losses %>%
  filter(EndOfQuarter >= as.Date("2011-03-31") & 
           EndOfQuarter <= as.Date("2016-12-31"))
head(freq_or_losses_filtered)
tail(freq_or_losses_filtered)

freq_model_data <- cbind(model_data, freq_or_losses_filtered)
```
### Построение модели множественной регрессии Пуассона

Модель множественной регрессии Пуассона является эффективным методом для стресс-тестирования операционного риска, особенно когда зависимая переменная представляет собой данные о подсчете или ставки, так как предполагается распределение Пуассона. Важно оценить мультиколлинеарность среди регрессоров (например, с помощью коэффициента инфляции дисперсии, VIF) и проверить стационарность (для временных рядов), чтобы избежать искаженных результатов. С помощью статистических тестов на значимость и итеративного поиска комбинаций независимых переменных, модель может быть настроена для выявления основных факторов операционного риска.

```{r}
# Создание датафрейма для моделирования
freq_final_df <-as.data.frame(freq_model_data)
```
#### Формулировка гипотез:
Нулевая гипотеза (H0): Макроэкономические переменные не имеют связи с убытками от операционного риска. Альтернативная гипотеза (Ha): Макроэкономические переменные имеют связь с убытками от операционного риска. Устанавливаем уровень значимости alpha = 0.1 (доверительный интервал 90%). Устанавливаем приемлемое значение Pseudo R^2 (Коэффициент детерминации) = 0.35 (35%).


```{r warning=FALSE}
# Функция для проверки стационарности и значимости модели 2
check_stationarity_significance_model_2 <- function(X, y) {
  X <- as.data.frame(cbind(1, X))  
  colnames(X)[1] <- "(Intercept)"  
  model2 <- glm(y ~ ., data = X, family = poisson()) 
  p_values <- summary(model2)$coefficients[, 4][-1] 
  adf_test <- adf.test(resid(model2)) 
  return(list(p_values = p_values, adf_test = adf_test))
}

# Функция для вычисления фактора инфляции дисперсии (VIF) для модели 2
calculate_vif_model_2 <- function(X, y) {
  
  data <- as.data.frame(cbind(X, y = y))
  vif_data <- vif(glm(y ~ ., data = data, family = poisson()))
  return(data.frame(feature = names(vif_data), VIF = vif_data))
}

# Функция для поиска лучшей модели 2 на основе комбинаций признаков
find_best_model_model_2 <- function(freq_final_df) {
  
  excluded_columns <- c("time_period", "Year_Quarter", 
                        "Date", "Date_2", "Value",
                        "Total_Loss_1", "Total_Loss_2", 
                        "Total_Loss_3", "Total_Loss_4",
                        "OR_Loss_in_assets", "Value_billion", 
                        "Total_or_losses",
                        "Total_or_losses_KZT", "Total_loss_1_KZT", 
                        "Total_loss_2_KZT",
                        "Total_loss_3_KZT", "Total_loss_4_KZT", 
                        "OR_Loss_1_in_assets",
                        "OR_Loss_2_in_assets", "OR_Loss_3_in_assets", 
                        "OR_Loss_4_in_assets", 
                        "Year", "EndOfQuarter", "Quarter", 
                        "Frequency_Quarterly", 
                        "Frequency_Quarterly.1", "Frequency_Quarterly.2",
                        "Frequency_Quarterly.3", "Total_freq")
  X <- freq_final_df[, !colnames(freq_final_df) %in% excluded_columns]
  y <- freq_final_df$Total_freq
  
  best_deviance <- Inf  
  best_model2 <- NULL
  best_features2 <- NULL
  total_combinations <- choose(ncol(X), 3)  
  combination_count <- 0
  
  # Генерация комбинаций из 3 независимых переменных
  combinations <- combn(names(X), 3, simplify = FALSE)
  
  # Инициализация списка для хранения допустимых комбинаций, которые прошли тесты

  valid_combinations_list <- list()

  for (i in 1:length(combinations)) {
    combination_count <- combination_count + 1
    selected_features <- X[, combinations[[i]], drop = FALSE]  
    
    # Проверка стационарности и значимости для Модели 2

    test_result <- check_stationarity_significance_model_2(selected_features, y)
    p_values <- test_result$p_values
    adf_test <- test_result$adf_test
    
    # Пропуск комбинаций, которые не проходят статистические тесты
    if (any(p_values > 0.1) || adf_test$p.value > 0.1) {
      next  
    }
    
    # Проверка VIF для Модели 2
    vif_test <- calculate_vif_model_2(selected_features, y)
    if (max(vif_test$VIF) > 10) {
      next  
    }
    
    # Построение модели пуассоновской регрессии для Модели 2
    selected_features <- as.data.frame(cbind(1, selected_features))  
    colnames(selected_features)[1] <- "(Intercept)" 
    model2 <- glm(y ~ ., data = selected_features, family = poisson())
    deviance <- model2$deviance
    
    # Проверка, является ли эта модель оптимальной (с наименьшей девиацией)
    if (deviance < best_deviance) {
      best_deviance <- deviance
      best_model2 <- model2
      best_features2 <- combinations[[i]]
    }
    
    # Добавление допустимой комбинации в список
    valid_combinations_list[[length(valid_combinations_list) + 1]] <- list(
      combination = combinations[[i]],
      p_values = p_values,
      adf_p_value = adf_test$p.value,
      deviance = deviance
    )
  }
  
  # Возврат лучшей модели, оптимальных признаков и допустимых комбинаций
  return(list(best_model2 = best_model2, 
              best_features2 = best_features2,
              best_deviance = best_deviance,
              valid_combinations_list = valid_combinations_list,
              valid_combinations = length(valid_combinations_list),
              total_combinations = total_combinations))
}

# Поиск оптимальной модели для Модели 2
best_result_2 <- find_best_model_model_2(freq_final_df)
best_model_2 <- best_result_2$best_model2
best_features_2 <- best_result_2$best_features2
valid_combinations_list <- best_result_2$valid_combinations_list
valid_combinations <- best_result_2$valid_combinations
total_combinations <- best_result_2$total_combinations

# Вывод результатов
cat("Общее количество комбинаций:", total_combinations, "\n")
cat("Количество допустимых комбинаций, прошедших статистические тесты:", 
    valid_combinations, "\n")

# Вывод каждой допустимой комбинации с деталями
cat("Допустимые комбинации, прошедшие статистические тесты:\n")
for (i in 1:length(valid_combinations_list)) {
  cat("Комбинация", i, ":", paste(valid_combinations_list[[i]]$combination, 
                                   collapse = ", "), 
      "\n")
  cat("p-значения: ", paste(valid_combinations_list[[i]]$p_values, 
                          collapse = ", "), 
      "\n")
  cat("p-значение теста ADF: ", valid_combinations_list[[i]]$adf_p_value, 
      "\n")
  cat("Девиация: ", valid_combinations_list[[i]]$deviance, 
      "\n\n")
}

# Вывод лучшей модели и признаков
cat("Лучшие независимые переменные для Модели 2:", 
    paste(best_features_2, collapse = ", "), "\n")
cat("Девиация лучшей модели для Модели 2:", 
    best_result_2$best_deviance, "\n")
print(summary(best_model_2))

```
**Обнаружения:** После генерации 1 330 различных комбинаций макроэкономических переменных, 11 комбинаций модели множественной пуассоновской регрессии успешно прошли статистические тесты и были отобраны. Эти модели представлены ниже:

**Комбинация 1:**
Переменные: Курс USD/KZT, Реальный ВВП (трансформированный), Реальный валовой добавленный стоимость - Электроэнергетика (трансформированный)  
Девиация: 21.11691

**Комбинация 2:**
Переменные: Курс USD/KZT, Реальный валовой добавленный стоимость - Электроэнергетика (трансформированный), Реальный валовой добавленный стоимость - Торговля (трансформированный)  
Девиация: 21.29723

**Комбинация 3:**
Переменные: Курс USD/KZT, Реальный валовой добавленный стоимость - Электроэнергетика (трансформированный), Реальный валовой добавленный стоимость - Информация (трансформированный)  
Девиация: 19.97724

**Комбинация 4:**
Переменные: Курс USD/KZT, Реальный валовой добавленный стоимость - Электроэнергетика (трансформированный), Реальный валовой добавленный стоимость (трансформированный)  
Девиация: 21.29074

**Комбинация 5:**
Переменные: Курс EUR/KZT, Реальный валовой добавленный стоимость - Электроэнергетика (трансформированный), Реальный валовой добавленный стоимость - Информация (трансформированный)  
Девиация: 19.70323

**Комбинация 6:**
Переменные: Курс RUB/KZT, Реальный валовой добавленный стоимость (трансформированный), Реальные среднемесячные доходы населения  
Девиация: 15.71598

**Комбинация 7:**
Переменные: Курс RUB/KZT, Реальные среднемесячные доходы населения (трансформированный), Реальные среднемесячные расходы населения (трансформированный)  
Девиация: 15.50418

**Комбинация 8:**
Переменные: Цена на Brent, Реальный валовой добавленный стоимость - Электроэнергетика (трансформированный), Реальный валовой добавленный стоимость - Торговля (трансформированный)  
Девиация: 21.95006

**Комбинация 9:**
Переменные: Цена на Brent, Реальный валовой добавленный стоимость - Торговля (трансформированный), Реальные среднемесячные расходы населения (трансформированный)  
Девиация: 22.39317

**Комбинация 10:**
Переменные: Инфляция (ИПЦ), Реальный валовой добавленный стоимость - Электроэнергетика (трансформированный), Реальный валовой добавленный стоимость - Информация (трансформированный)  
Девиация: 19.96472

**Комбинация 11:**
Переменные: Инфляция (ИПЦ), Реальный валовой добавленный стоимость - Информация (трансформированный), Реальные среднемесячные расходы населения (трансформированный)  
Девиация: 21.32715

**Выбор оптимальной модели:**
Оптимальная модель множественной пуассоновской регрессии для прогнозирования масштабов (воздействия/тяжести) операционных рисков - Комбинация 7, имеющая наименьшую девиацию (15.50418) и наибольший R^2. Отобранные переменные:
- Курс RUB/KZT
- Реальные среднемесячные доходы населения (трансформированные)
- Реальные среднемесячные расходы населения (трансформированные)
Все p-значения ниже порогового уровня (0.1), что подтверждает статистическую значимость этих переменных.

**Заключение:**
Поскольку нулевая гипотеза отвергается, а альтернативная принимается, результаты свидетельствуют о значительном влиянии макроэкономических переменных на частоту (количество) операционных рисков. Выбранная модель обеспечивает наиболее надежные и достоверные прогнозы на основе статистических показателей.

#### Проверка предположений модели множественной пуассоновской регрессии 

#### Модель множественной регрессии Пуассона 1

```{r}
# Построение модели множественной пуассоновской регрессии
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка модели пуассоновской регрессии
mf_poiss_model <- glm(y ~ rurkzt + Rincpop_q_y + Rexppop_q_y, 
                      data = X, family = poisson())

# Вычисление псевдо-R-квадрат значений
pseudo_r2_values <- pR2(mf_poiss_model)

# Вывод результатов
summary(mf_poiss_model)
pseudo_r2_values

```
**Обнаружения:** Значение R^2 Макфаддена = 0.0767 указывает, что модель объясняет примерно 7.67% дисперсии по сравнению с нулевой моделью. Хотя это свидетельствует о некотором улучшении соответствия модели, также выявляет потенциальные направления для дальнейшего совершенствования. В отличие от этого, показатели r²ML (псевдо-R^2 максимального правдоподобия) = 0.4754 и r²CU (псевдо-R^2 Крэгга-Улера/Нагелькерке) = 0.4755 дают более оптимистичную оценку, предполагая, что около 47.5% вариации частоты операционных рисков объясняется выбранными макроэкономическими переменными. Эти последние метрики свидетельствуют о более благоприятном общем соответствии модели.

#### Создание матрицы корреляций

```{r}
kendall_corr5 <- freq_final_df %>% 
  dplyr::select(rurkzt, Rincpop_q_y, Rexppop_q_y, Total_freq)

# Вычисление корреляционной матрицы Кендалла
kendall_corr5 <- cor(kendall_corr5, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr5)
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация корреляционной матрицы Кендалла
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr5, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black",
         tl.col = "black", tl.srt = 45,
         title = "Матрица корреляции Кендалла",
         mar = c(0,0,1,0)
)
```
**Результаты:** Независимые и зависимые переменные демонстрируют умеренные отрицательные корреляции, что подразумевает: при росте некоторых макроэкономических показателей частота или тяжесть операционных убытков имеет тенденцию к снижению, или наоборот. Хотя корреляция недостаточно сильна для установления прямой причинно-следственной связи, она указывает на умеренную обратную зависимость. Данный результат может потребовать дополнительного исследования и усовершенствования модели для достижения более точных прогнозов.

#### Проверка предположения о линейности

```{r fig.align="center", fig.width=6, fig.height=4}
# Построение диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = Rincpop_q_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния: Rincpop_q_y против Total_freq", 
       x = "Rincpop_q_y", y = "Total_freq") +
  theme_minimal()
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = rurkzt, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния: rurkzt против Total_freq", 
       x = "rurkzt", 
       y = "Total_freq") +
  theme_minimal()
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Построение диаграммы рассеяния для независимой и зависимой переменных
ggplot(data = freq_final_df, aes(x = Rexppop_q_y, y = Total_freq)) +
  geom_point(alpha = 0.6, color = "navy") +  # Полупрозрачные точки
  stat_smooth(method = "lm", col = "blue", se = TRUE, fill = "lightblue") +  # С доверительным интервалом
  labs(title = "Зависимость частоты убытков от расходов населения",
       subtitle = "Диаграмма рассеяния с линией регрессии",
       x = "Квартальные расходы населения (Rexppop_q_y)", 
       y = "Общая частота убытков (Total_freq)",
       caption = "Данные: freq_final_df") +
  theme_minimal()
```

**Обнаружения:** Установить наличие линейных зависимостей между независимыми и зависимыми переменными представляется затруднительным. Предположение о линейности подразумевает прямую пропорциональную зависимость между предикторами (макроэкономическими переменными) и откликом (операционными убытками). Нарушение этого предположения может привести к тому, что модель упустит более сложные нелинейные взаимосвязи, что потенциально приведет к смещенным или неэффективным прогнозам. 

Для прогнозирования операционных рисков, где макроэкономические факторы могут сложным образом взаимодействовать с убытками, игнорирование нелинейных зависимостей может привести к неточным оценкам. Стресс-тестирование, основанное на линейной модели в таких случаях, может дать искаженные выводы о потенциальном воздействии и масштабах операционных убытков. Для повышения точности прогнозирования может потребоваться дополнительное исследование нелинейных моделей или преобразование признаков.

#### Проверка предположения о независимости

```{r}
# Проверка автокорреляции с помощью теста Дарбина-Уотсона (требуется пакет car)
dwtest(mf_poiss_model)
```
**Обнаружения:** Статистика Дарбина-Уотсона (DW) составляет 1.9546, что близко к 2, указывая на отсутствие значимой автокорреляции в остатках модели. p-значение 0.304 дополнительно подтверждает этот вывод, так как предоставляет недостаточно свидетельств в пользу наличия автокорреляции. Это свидетельствует о временной независимости остатков, подтверждая выполнение предположения об отсутствии автокорреляции, что является важным условием для обеспечения надежности прогнозов модели.

#### Проверка предположения о распределении Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона:
# График остатков от предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model$fitted.values,
                         residuals = residuals(mf_poiss_model)),
       aes(x = fitted, y = residuals)) +
  geom_point(alpha = 0.6, color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.8) +
  labs(title = "Проверка распределения: остатки vs предсказанные значения",
       subtitle = "Анализ соответствия модели пуассоновской регрессии",
       x = "Предсказанные значения",
       y = "Пирсоновские остатки",
       caption = paste("Модель:", deparse(formula(mf_poiss_model)))) +
  theme_minimal()
```
**Обнаружения:** Остатки случайным образом распределены вокруг горизонтальной линии на уровне 0 на графике остатков, что предполагает, что предположения модели, вероятно, выполнены, и модель хорошо подходит. Отсутствие явных закономерностей в остатках является сильным индикатором хорошо подобранной модели, что дополнительно подтверждает ее пригодность для стресс-тестирования убытков операционного риска.

#### Предположение об избыточной дисперсии


```{r}
# Проверка на избыточную дисперсию: Сравнение остаточной девианции
# с количеством степеней свободы
deviance <- mf_poiss_model$deviance
df <- mf_poiss_model$df.residual
dispersion <- deviance / df
dispersion

```
**Обнаружения:** Статистика дисперсии составляет примерно 1, что указывает на то, что дисперсия остатков соответствует предположениям модели Пуассона. Это предполагает, что модель хорошо подходит для данных, и что предположения относительно распределения зависимой переменной (частоты убытков операционного риска) выполнены. Это имеет решающее значение для обеспечения надежности результатов стресс-тестирования.

#### Предположение о мультиколлинеарностим

```{r}
# Проверка на мультиколлинеарность: Фактор инфляции дисперсии (VIF)
vif(mf_poiss_model)

```
**Обнаружения:** Значения VIF варьируются от 1 до 8, что свидетельствует о наличии умеренной мультиколлинеарности. Хотя существует некоторая корреляция между независимыми переменными, её уровень недостаточно высок, чтобы существенно повлиять на надежность или интерпретацию модели регрессии. Тем не менее, рекомендуется отслеживать мультиколлинеарность в будущих моделях или предсказаниях, чтобы убедиться, что она не вводит значительные искажения или нестабильность.

#### Предположение о нормальности. Качество подгонки с использованием остатков Пирсона


```{r fig.align="center", fig.width=6, fig.height=4}
# Расчет остатков модели
pearson_residuals <- residuals(mf_poiss_model, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки 1x2 для графиков (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настроенными интервалами и форматированием оси
hist(
  pearson_residuals,
  breaks = 5,  # Увеличиваем количество интервалов
  main = "Гистограмма остатков",
  xlab = "Значение остатка",
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X для удаления научной нотации
axis(1, at = pretty(residuals), 
     labels = format(pretty(residuals), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Сбросить настройки макета графиков на стандартные
par(mfrow = c(1, 1))

```
**Обнаружения:** Гистограмма остатков модели выглядит как нормально распределенная, что подтверждает выполнение предположения о нормальности для этой модели. Более того, на Q-Q графике остатки близки к прямой линии, что еще раз подтверждает корректность предположения о нормальности. Это указывает на то, что остатки не имеют значительных отклонений от нормальности, что повышает надежность статистических выводов, таких как проверка гипотез и доверительные интервалы.

#### Модель множественной регрессии Пуассона 2


```{r}
# Построение модели множественной Поассоновской регрессии
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка модели Поассоновской регрессии
mf_poiss_model2 <- glm(y ~ usdkzt + real_gdp_y + GDD_Elc_R_y, 
                       data = X, family = poisson())

# Вычисление значений псевдо R-квадрата
pseudo_r2_values2 <- pR2(mf_poiss_model2)

# Вывод результатов
summary(mf_poiss_model2)
pseudo_r2_values2


```
**Обнаружения:** McFadden's R^2 = 0.0489 предполагает, что модель объясняет около 4.89% дисперсии по сравнению с нулевой моделью, что указывает на небольшое улучшение подгонки, но оставляет место для дальнейшего совершенствования. Однако r^2ML (Максимально правдоподобное псевдо-R^2) = 0.337 и r^2CU (Псевдо-R^2 по Креггу-Улеру/Нагелькерке) = 0.337 предлагают более многообещающую перспективу, показывая, что примерно 33.7% вариации частоты потерь операционного риска могут быть объяснены выбранными макроэкономическими переменными. Эти метрики предполагают, что модель предоставляет более подходящую подгонку в целом.

#### Создание корреляционной матрицы


```{r}
kendall_corr6 <- freq_final_df %>% 
  dplyr:: select(usdkzt, real_gdp_y, GDD_Elc_R_y, Total_freq)

# Вычисление корреляционной матрицы по методу Кендалла
kendall_corr6 <- cor(kendall_corr6, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr6)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляции Кендалла с использованием графика корреляции
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr6, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)
```
**Обнаружения:** Независимые и зависимые переменные показывают умеренную отрицательную корреляцию между real_gdp_y и GDD_Elc_R_y, что свидетельствует о том, что с увеличением этих макроэкономических переменных частота или тяжесть потерь операционного риска, как правило, снижается. Напротив, наблюдается положительная корреляция с usdkzt, что указывает на то, что с ростом обменного курса USD/KZT частота или тяжесть потерь операционного риска склонны увеличиваться. Хотя корреляции недостаточно сильны для установления прямой причинно-следственной связи, они подчеркивают умеренную обратную зависимость, которая может потребовать дальнейшего исследования или корректировки модели для улучшения предсказательной точности.

#### Предположение о линейности

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = usdkzt, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния usdkzt против Total_freq", 
       x = "usdkzt", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = real_gdp_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния real_gdp_y против Total_freq", 
       x = "real_gdp_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Elc_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния GDD_Elc_R_y против Total_freq", 
       x = "GDD_Elc_R_y", y = "Total_freq") +
  theme_minimal()

```

**Обнаружения:** Подтвердить наличие линейных зависимостей между независимыми и зависимыми переменными сложно. Предположение о линейности предполагает простую, пропорциональную зависимость между предсказателями (макроэкономическими переменными) и ответной переменной (убытки от операционного риска). Если это предположение нарушено, модель может не уловить более сложные, нелинейные зависимости, что может привести к смещенным или неэффективным предсказаниям. В контексте прогнозирования операционного риска, где макроэкономические факторы могут взаимодействовать с рисковыми потерями сложными способами, игнорирование нелинейных зависимостей может привести к неточным предсказаниям. Стресс-тестирование на основе линейной модели в таких сценариях может привести к ошибочным выводам о потенциальном влиянии и тяжести убытков от операционного риска. Возможно, потребуется дальнейшее исследование нелинейных моделей или преобразований признаков для улучшения точности предсказаний.


#### Предположение независимости

```{r}
# Использование теста Дёрбина-Уотсона (требуется пакет car)
dwtest(mf_poiss_model2)

```
**Обнаружения:** Статистика Дёрбина-Уотсона (DW) равна 2.5634, что близко к 2, что указывает на отсутствие значимой автокорреляции в остатках модели. P-значение 0.775 дополнительно поддерживает этот вывод, так как оно не предоставляет веских доказательств в пользу наличия автокорреляции. Это говорит о том, что остатки не коррелированы во времени, что подтверждает предположение об отсутствии автокорреляции. Это важно для обеспечения надежности и точности предсказаний модели.

#### Предположение о распределении Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона: 
# Построение графика остатков против предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model2$fitted.values, 
                         residuals = residuals(mf_poiss_model2)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки против предсказанных значений", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()

```
**Обнаружения:** Остатки случайным образом распределены вокруг горизонтальной линии на уровне 0 на графике остатков, что предполагает, что предположения модели, вероятно, выполнены, и модель хорошо подходит для данных. Отсутствие явного паттерна в остатках дополнительно подтверждает идею о хорошо подобранной модели. Это усиливает обоснованность модели и подтверждает её пригодность для стресс-тестирования убытков от операционного риска.


#### Предположение о перевыборке

```{r}
# Проверка на перевыборку: Сравнение девиантности остатков 
# с количеством степеней свободы
deviance <- mf_poiss_model2$deviance
df <- mf_poiss_model2$df.residual
dispersion <- deviance / df
dispersion
```
**Обнаружения:** Статистика дисперсии составляет примерно 1, что указывает на то, что дисперсия остатков соответствует предположениям модели Пуассона. Это предполагает, что модель хорошо подходит для данных, и предположения о распределении зависимой переменной (частота убытков от операционного риска) выполнены. Эта согласованность важна для обеспечения надежности и точности результатов стресс-тестирования.


#### Предположение мультиколлинеарности

```{r}
# Проверка на мультиколлинеарность: коэффициент инфляции дисперсии (VIF)
vif(mf_poiss_model2)

```
**Обнаружения:** Значения VIF варьируются от 2 до 7, что указывает на умеренную мультиколлинеарность. Хотя между независимыми переменными существует некоторая корреляция, значения остаются в пределах приемлемых границ, что позволяет сделать вывод, что мультиколлинеарность не является достаточно сильной, чтобы существенно повлиять на надежность или интерпретацию модели регрессии. Тем не менее, важно продолжать мониторинг возможных проблем с мультиколлинеарностью при будущем моделировании или прогнозах.

#### Предположение о нормальности. Оценка качества подбора модели с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Расчет остатков модели
pearson_residuals <- residuals(mf_poiss_model2, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки 1x2 для графиков (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой количества интервалов и форматирования осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличение количества интервалов
  main = "Гистограмма остатков",
  xlab = "Значение остатка",
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X для удаления научной нотации
axis(1, at = pretty(residuals), 
     labels = format(pretty(residuals), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Сброс настроек макета графиков к стандартным
par(mfrow = c(1, 1))

```
**Обнаружения:** Гистограмма остатков, похоже, следует нормальному распределению, что подтверждает выполнение предположения о нормальности для этой модели. Кроме того, остатки на Q-Q графике хорошо выровнены вдоль прямой линии, что дополнительно поддерживает предположение о нормальности. Это указывает на то, что остатки модели не отклоняются значительно от нормального распределения, что повышает надежность статистических выводов, включая проверку гипотез и построение доверительных интервалов.


#### Модель множественной регрессии Пуассона 3


```{r}
# Создание модели множественной регрессии Пуассона
X <- freq_final_df
y <- freq_final_df$Total_freq

# Применение модели регрессии Пуассона
mf_poiss_model3 <- glm(y ~ usdkzt + GDD_Elc_R_y + GDD_Trd_R_y, 
                      data = X, family = poisson())

# Расчет значений псевдо R-квадрат
pseudo_r2_values3 <- pR2(mf_poiss_model3)

# Вывод результатов
summary(mf_poiss_model3)
pseudo_r2_values3

```
**Обнаружения:** Значение McFadden's R^2 = 0.048 указывает, что модель объясняет около 4,8% дисперсии по сравнению с нулевой моделью, что свидетельствует о некотором улучшении соответствия, но также указывает на необходимость дальнейших улучшений. В то же время значения r^2ML (псевдо-R^2 максимального правдоподобия) = 0.332 и r^2CU (псевдо-R^2 Cragg-Uhler/Nagelkerke) = 0.332 дают более благоприятную оценку, показывая, что примерно 33,2% вариации в частоте убытков по операционному риску объясняются выбранными макроэкономическими переменными. Эти показатели свидетельствуют о более хорошем общем соответствии модели.

#### Создание матрицы корреляций

```{r}
kendall_corr7 <- freq_final_df %>% 
  dplyr:: select(usdkzt, GDD_Elc_R_y, GDD_Trd_R_y, Total_freq)

# Расчёт матрицы корреляций Кендалла
kendall_corr7 <- cor(kendall_corr7, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr7)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляций Кендалла с помощью корреляционного графика
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr7, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)

```
**Обнаружения:** Независимые и зависимые переменные показывают умеренные отрицательные корреляции для GDD_Trd_R_y и GDD_Elc_R_y, а также положительную корреляцию с usdkzt. Это предполагает, что с увеличением определенных макроэкономических переменных частота или серьезность потерь от операционного риска, как правило, снижается, и наоборот. Хотя корреляция недостаточно сильна, чтобы установить прямую причинно-следственную связь, она указывает на умеренную обратную зависимость, что может потребовать дальнейшего исследования или доработки модели для улучшения точности предсказаний.

#### Предположение о линейности


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = usdkzt, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния usdkzt vs. Total_freq", 
       x = "usdkzt", y = "Total_freq") +
  theme_minimal()
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Elc_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния GDD_Elc_R_y vs. Total_freq", 
       x = "GDD_Elc_R_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Trd_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния GDD_Trd_R_y vs. Total_freq", 
       x = "GDD_Trd_R_y", y = "Total_freq") +
  theme_minimal()

```

**Обнаружения:** Подтвердить наличие линейных зависимостей между независимыми и зависимыми переменными сложно. Предположение о линейности предполагает прямую, пропорциональную зависимость между предсказателями (макроэкономическими переменными) и зависимой переменной (убытки от операционного риска). Если это предположение нарушается, модель может не уловить более сложные, нелинейные зависимости, что приведет к искаженным или неэффективным прогнозам. В контексте прогнозирования операционного риска, где макроэкономические факторы могут взаимодействовать сложным образом с убытками, игнорирование нелинейных зависимостей может привести к неточным оценкам. Стресс-тестирование на основе линейной модели в таких условиях может привести к ошибочным выводам о потенциальном воздействии и тяжести убытков от операционного риска. Для повышения точности прогнозов может потребоваться дальнейшее исследование нелинейных моделей или преобразований признаков.

#### Предположение о независимости

```{r}
# Использование теста Дурбина-Уотсона (требуется пакет car)
dwtest(mf_poiss_model3)

```
**Обнаружения:** Статистика Дурбина-Уотсона (DW) составляет 2.5936, что близко к 2, что указывает на отсутствие значимой автокорреляции в остатках модели. Значение p = 0.7953 дополнительно поддерживает этот вывод, так как оно не предоставляет достаточных доказательств в пользу наличия автокорреляции. Это свидетельствует о том, что остатки не коррелированы во времени, и предположение об отсутствии автокорреляции выполняется, что важно для обеспечения надежности и точности предсказаний модели.

#### Предположение о распределении Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона: 
# Построение графика остатков против предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model3$fitted.values, 
                         residuals = residuals(mf_poiss_model3)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки против предсказанных значений", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()
```
**Обнаружения:** Остатки случайным образом распределены вокруг горизонтальной линии на уровне 0, что свидетельствует о выполнении предположений модели и ее хорошей адекватности данным. Отсутствие явных паттернов в распределении остатков является важным индикатором правильно специфицированной модели. Это подтверждает валидность модели и обосновывает ее применимость для стресс-тестирования операционных убытков.

#### Проверка предположения о сверхдисперсии

```{r}
# Проверка сверхдисперсии: Сравнение остаточной девиансии 
# со степенями свободы
deviance <- mf_poiss_model3$deviance
df <- mf_poiss_model3$df.residual
dispersion <- deviance / df
dispersion
```
**Результаты:** 
Статистика дисперсии близка к 1 (значение = `r round(dispersion, 3)`), что указывает на соответствие дисперсии остатков предположениям модели Пуассона. Это свидетельствует о том, что:
1. Модель адекватно описывает данные
2. Распределение зависимой переменной (частоты операционных убытков) соответствует пуассоновскому
3. Результаты стресс-тестирования можно считать надежными

#### Проверка предположения об отсутствии мультиколлинеарности

```{r}
# Проверка мультиколлинеарности: анализ фактора инфляции дисперсии (VIF)
vif_results <- vif(mf_poiss_model3)
print(vif_results)

```
**Обнаружения:**
Значения VIF варьируются от 1 до 4, что указывает на умеренную мультиколлинеарность. Хотя между независимыми переменными наблюдается некоторая корреляция, значения остаются в пределах допустимых порогов (VIF < 5), что позволяет сделать следующие выводы:

1. Надежность модели не вызывает серьезных опасений
2. Интерпретация коэффициентов остается валидной
3. Для улучшения модели можно рассмотреть:
   - Исключение наименее значимых предикторов
   - Объединение коррелированных переменных
   - Использование методов уменьшения размерности

#### Проверка предположения о нормальности. Анализ адекватности модели с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Расчет остатков модели
pearson_residuals <- residuals(mf_poiss_model3, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки 1x2 для графиков (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой количества интервалов и форматирования осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличение количества интервалов
  main = "Гистограмма остатков",
  xlab = "Значение остатка",
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X для удаления научной нотации
axis(1, at = pretty(residuals), 
     labels = format(pretty(residuals), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Сброс настроек макета графиков к стандартным
par(mfrow = c(1, 1))
```
**Обнаружения:** Гистограмма остатков кажется примерно нормально распределенной, что подтверждает выполнение предположения нормальности для этой модели. Кроме того, остатки на графике Q-Q близко выровнены вдоль прямой линии, что является дополнительным доказательством корректности предположения о нормальности. Это говорит о том, что остатки модели не сильно отклоняются от нормального распределения, поддерживая устойчивость статистических выводов, таких как тестирование гипотез и доверительные интервалы.

#### Модель множественной регрессии Пуассона 4

```{r}
# Построение модели множественной регрессии Пуассона
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка модели регрессии Пуассона
mf_poiss_model4 <- glm(y ~ usdkzt + GDD_Elc_R_y + GDD_Inf_R_y, 
                       data = X, family = poisson())

# Вычисление псевдо R-квадрат значений
pseudo_r2_values4 <- pR2(mf_poiss_model4)

# Вывод результатов
summary(mf_poiss_model4)
pseudo_r2_values4

```
**Обнаружения:** McFadden's R^2 = 0.0545 указывает, что модель объясняет примерно 5,5% дисперсии по сравнению с нулевой моделью, что свидетельствует о некотором улучшении подгоночной способности модели, но также подчеркивает возможность дальнейшего усовершенствования. В то же время, значения r^2ML (псевдо-R^2 максимального правдоподобия) = 0.368 и r^2CU (псевдо-R^2 Крэгга-Улера/Нагелькерке) = 0.368 дают более благоприятную оценку, предполагая, что примерно 33,7% вариации частоты убытков от операционного риска может быть объяснено выбранными макроэкономическими переменными. Эти метрики свидетельствуют о более сильной общей подгоночной способности модели.

#### Создание матрицы корреляции

```{r}
kendall_corr8 <- freq_final_df %>% 
  dplyr::select(usdkzt, GDD_Elc_R_y, GDD_Inf_R_y, Total_freq)

# Вычисление матрицы корреляции Кендалла
kendall_corr8 <- cor(kendall_corr8, method = "kendall", 
                     use = "complete.obs")
print(kendall_corr8)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляций Кендалла с помощью корреляционного графика
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr8, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)

```
**Обнаружения:** Независимые и зависимые переменные показывают умеренную отрицательную корреляцию для GDD_Elc_R_y и GDD_Inf_R_y, а также положительную корреляцию с usdkzt. Это предполагает, что с увеличением некоторых макроэкономических переменных частота или тяжесть убытков по операционным рискам имеет тенденцию к снижению и наоборот. Хотя корреляция недостаточно сильна, чтобы предполагать прямую причинно-следственную связь, она указывает на умеренную обратную зависимость. Это требует дальнейшего исследования и возможных уточнений модели для улучшения точности прогнозирования.

#### Предположение о линейности


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание точечной диаграммы для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = usdkzt, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Точечная диаграмма usdkzt vs. Total_freq", 
       x = "usdkzt", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание точечной диаграммы для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Elc_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Точечная диаграмма GDD_Elc_R_y vs. Total_freq", 
       x = "GDD_Elc_R_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание точечной диаграммы для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Inf_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Точечная диаграмма GDD_Inf_R_y vs. Total_freq", 
       x = "GDD_Inf_R_y", y = "Total_freq") +
  theme_minimal()

```

**Обнаружения:** Предположение о линейности, которое предполагает прямую пропорциональную зависимость между независимыми переменными (макроэкономическими факторами) и зависимой переменной (потери от операционного риска), трудно подтвердить. Если это предположение нарушается, модель может не уловить более сложные, нелинейные зависимости, что приведет к смещенным или неэффективным предсказаниям. Учитывая возможную сложность взаимодействий между макроэкономическими факторами и рисковыми потерями, использование только линейной модели может привести к ложным выводам. Поэтому рекомендуется дальнейшее исследование нелинейных моделей или преобразований признаков для улучшения точности предсказаний и обеспечения более надежной оценки потерь от операционного риска.


#### Предположение о независимости

```{r}
# Проверка автокорреляции с помощью теста Дарбина-Уотсона (требуется пакет car)
dwtest(mf_poiss_model4)
```
**Обнаружения:** 
Статистика Дарбина-Уотсона (DW) составляет 2.5248, что близко к 2, что свидетельствует об отсутствии значимой автокорреляции в остатках модели. P-значение 0.7472 дополнительно подтверждает этот вывод, так как не предоставляет достаточных оснований предполагать наличие автокорреляции. Это означает, что:

1. Остатки не коррелированы во времени
2. Предположение об отсутствии автокорреляции выполняется
3. Прогнозы модели можно считать надежными

#### Проверка предположения о распределении Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона: 
# Построение графика остатков против предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model4$fitted.values, 
                         residuals = residuals(mf_poiss_model4)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки против предсказанных значений", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()
```
**Обнаружения:** Остатки случайным образом разбросаны вокруг горизонтальной линии на уровне 0 на графике остатков, что предполагает, что предположения модели, вероятно, выполнены. Отсутствие явного шаблона в остатках является важным индикатором хорошо подогнанной модели. Это подтверждает валидность модели и ее пригодность для стресс-тестирования операционных рисков убытков, поскольку показывает, что модель эффективно улавливает взаимосвязь между предикторами и зависимой переменной.

#### Предположение о сверхдисперсии

```{r}
# Проверка на сверхдисперсию: Сравнение остаточной девиации
# со степенями свободы 
deviance <- mf_poiss_model4$deviance
df <- mf_poiss_model4$df.residual
dispersion <- deviance / df
dispersion
```
**Обнаружения:** Статистика дисперсии, примерно равная 1, указывает на то, что дисперсия остатков соответствует предположениям модели Пуассона. Это говорит о том, что модель хорошо подходит для данных и что предположения относительно распределения зависимой переменной (частота убытков от операционных рисков) выполнены. Это соответствие пуассоновскому распределению имеет решающее значение для обеспечения надежности и точности результатов стресс-тестирования, что подтверждает достоверность предсказаний модели.


#### Предположение о мультиколлинеарности

```{r}
# Проверка на мультиколлинеарность: Фактор инфляции дисперсии (VIF)
vif(mf_poiss_model4)
```
**Обнаружения:** Значения фактора инфляции дисперсии (VIF), находящиеся в диапазоне от 1 до 4, указывают на умеренную мультиколлинеарность, что предполагает наличие некоторой корреляции между независимыми переменными, но она не является достаточно сильной, чтобы существенно повлиять на надежность или интерпретацию регрессионной модели. Тем не менее, важно продолжать отслеживать эти корреляции в будущих моделированиях и предсказаниях, поскольку даже умеренная мультиколлинеарность иногда может повлиять на стабильность коэффициентов регрессии или привести к переобучению. Для уточнения модели может потребоваться дополнительный анализ или возможные корректировки.

#### Предположение о нормальности. Оценка качества подгонки с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление остатков модели
pearson_residuals <- residuals(mf_poiss_model4, type = "pearson")

qqnorm(pearson_residuals)

qqline(pearson_residuals)

# Создание сетки графиков 1x2 (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настроенными интервалами и форматированием осей
hist(

pearson_residuals,

breaks = 5,  # Увеличение количества интервалов

main = "Гистограмма остатков",

xlab = "Значение остатков",

col = "skyblue",

border = "black",

xaxt = "n"

)

# Настройка оси X для удаления научной нотации
axis(1, at = pretty(residuals),

labels = format(pretty(residuals),

scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Нормальный Q-Q график")

qqline(pearson_residuals, col = "red")

# Сброс настроек компоновки графиков на значения по умолчанию
par(mfrow = c(1, 1))
```
**Обнаружения:** Гистограмма остатков имеет нормальное распределение, однако остатки на Q-Q графике не образуют прямую линию, что подтверждает, что предположение о нормальности для данной модели не выполняется. Это указывает на то, что остатки отклоняются от нормального распределения, что имеет решающее значение для обеспечения валидности статистических выводов, таких как проверка гипотез и доверительные интервалы.


#### Модель множественной регрессии Пуассона 5 

```{r}
# Построение модели множественной пуассоновской регрессии
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка модели пуассоновской регрессии
mf_poiss_model5 <- glm(y ~ usdkzt + GDD_Elc_R_y + GDD_R_y, 
                      data = X, family = poisson())

# Вычисление псевдо-R-квадратов
pseudo_r2_values5 <- pR2(mf_poiss_model5)

# Вывод результатов
summary(mf_poiss_model5)
pseudo_r2_values5

```
**Обнаружения:** Значение R^2 МакФаддена, равное 0.048, указывает на то, что модель объясняет лишь около 4.8% дисперсии, демонстрируя некоторое улучшение по сравнению с нулевой моделью, но также свидетельствуя о значительном потенциале для дальнейшего усовершенствования. Тем не менее, показатели r²ML (псевдо-R^2 на основе максимального правдоподобия), равный 0.332, и r²CU (псевдо-R^2 Крэгга-Улера/Нагелкерке), также равный 0.332, показывают более благоприятную картину, объясняя около 33.2% вариации в частоте операционных убытков. Эти последние метрики подразумевают лучшее общее соответствие модели, указывая на то, что выбранные макроэкономические переменные объясняют значительную долю изменчивости зависимой переменной.

#### Создание матрицы корреляции


```{r}
kendall_corr9 <- freq_final_df %>% 
  dplyr::select(usdkzt, GDD_Elc_R_y, GDD_R_y, Total_freq)

# Вычисление корреляционной матрицы Кендалла
kendall_corr9 <- cor(kendall_corr9, method = "kendall", 
                     use = "complete.obs")
print(kendall_corr9)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация корреляционной матрицы Кендалла с помощью графика корреляции
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr9, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)

```
**Обнаружения:** Независимые и зависимая переменные демонстрируют умеренно отрицательные корреляции для таких переменных, как GDD_Elc_R_y и GDD_R_y, что указывает на то, что с ростом этих макроэкономических факторов частота или серьёзность потерь от операционного риска имеет тенденцию к снижению. С другой стороны, наблюдается положительная корреляция с переменной usdkzt, что предполагает: по мере роста значения usdkzt частота или серьёзность потерь от операционного риска может увеличиваться. Хотя эти корреляции недостаточно сильны, чтобы делать выводы о прямой причинно-следственной связи, обнаруженные обратные зависимости требуют дальнейшего изучения. Уточнение модели и исследование потенциальных скрытых факторов могут способствовать повышению точности прогнозирования.

#### Предположение линейности


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = usdkzt, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния: usdkzt против Total_freq", 
       x = "usdkzt", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Elc_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния: GDD_Elc_R_y против Total_freq", 
       x = "GDD_Elc_R_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния: GDD_R_y против Total_freq", 
       x = "GDD_R_y", y = "Total_freq") +
  theme_minimal()

```

**Обнаружения:** Подтвердить наличие линейных зависимостей между независимыми и зависимой переменными в данной модели затруднительно. Предположение линейности подразумевает прямую, пропорциональную связь между предикторами (макроэкономическими переменными) и откликом (потери по операционному риску). Если это предположение не выполняется, модель может не уловить более сложные, нелинейные зависимости, что приведёт к смещённым или неэффективным прогнозам. Учитывая сложность прогнозирования операционного риска, в котором макроэкономические факторы могут взаимодействовать с потерями по риску сложным образом, игнорирование нелинейностей может привести к ошибочным выводам. Полагаться исключительно на линейную модель при стресс-тестировании может дать вводящие в заблуждение представления о возможных последствиях и масштабах потерь от операционного риска. Необходимо дальнейшее изучение нелинейных моделей, преобразование признаков или исследование взаимодействий между переменными для повышения точности прогнозирования и обеспечения более надёжной оценки.


#### Предположение независимости

```{r}
# Использование теста Дёрбина-Уотсона
dwtest(mf_poiss_model5)
```
**Обнаружения:** Статистика Дёрбина-Уотсона (DW) равна 2.5736, что близко к 2, что указывает на отсутствие значимой автокорреляции в остатках модели. P-значение 0.7847 подтверждает этот вывод, так как оно не предоставляет достаточных оснований для предположения о наличии автокорреляции. Это предполагает, что остатки не коррелированы во времени, и гипотеза об отсутствии автокорреляции подтверждается, что имеет решающее значение для обеспечения надежности и точности предсказаний модели при стресс-тестировании убытков от операционного риска.

#### Гипотеза о распределении Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона:
# График остатков против предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model5$fitted.values, 
                         residuals = residuals(mf_poiss_model5)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки против предсказанных значений (Проверка распределения Пуассона)", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()

```
**Обнаружения:** Остатки случайным образом распределены вокруг горизонтальной линии на уровне 0 на графике остатков, что предполагает, что предположения модели, вероятно, выполнены и модель хорошо подогнана. Отсутствие явных паттернов в остатках является важным индикатором хорошо подогнанной модели. Это укрепляет уверенность в действительности модели и ее пригодности для точного стресс-тестирования потерь по операционным рискам.

#### Предположение об избыточной дисперсии


```{r}
# Проверка на избыточную дисперсию: Сравнение остаточной девиации 
# с количеством степеней свободы
deviance <- mf_poiss_model5$deviance
df <- mf_poiss_model5$df.residual
dispersion <- deviance / df
dispersion

```
**Обнаружения:** Статистика дисперсии, близкая к 1, указывает на то, что дисперсия остатков соответствует предположениям модели Пуассона. Это означает, что модель подходит для данных, и что предположения относительно распределения зависимой переменной (частоты убытков операционного риска) выполнены. Эта согласованность имеет решающее значение для обеспечения надежности и точности результатов стресс-тестирования.



#### Предположение о многоколлинеарности

```{r}
# Проверка многоколлинеарности: Фактор инфляции вариации (VIF)
vif(mf_poiss_model5)

```
**Обнаружения:** Значения VIF, варьирующиеся от 2 до 6, указывают на умеренную мультиколлинеарность между независимыми переменными. Хотя этот уровень мультиколлинеарности не является настолько серьезным, чтобы поставить под сомнение надежность или интерпретацию модели регрессии, важно отслеживать ситуацию. Если мультиколлинеарность увеличится в будущих итерациях, это может повлиять на стабильность модели и значимость отдельных предикторов. Может быть полезно исследовать такие методы, как отбор переменных или регуляризация, если мультиколлинеарность станет более значимой проблемой.

#### Допущение нормальности. Качество подбора с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление остатков модели
pearson_residuals <- residuals(mf_poiss_model5, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки графиков 1x2 (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой бинов и осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличение количества бинов
  main = "Гистограмма остатков",
  xlab = "Значение остатка", 
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X без научной нотации
axis(1, at = pretty(pearson_residuals),
     labels = format(pretty(pearson_residuals),
     scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Восстановление стандартных настроек графиков
par(mfrow = c(1, 1))
```
**Обнаружения:** Гистограмма остатков и Q-Q график оба указывают на то, что остатки примерно распределены нормально. Это подтверждает, что предположение о нормальности выполнено для модели. В результате остатки модели не показывают значительных отклонений от нормального распределения, что важно для валидности статистических выводов, таких как проверка гипотез и построение доверительных интервалов. Это дает дополнительную поддержку надежности модели и ее соответствию для прогнозирования и выводов в контексте стресс-тестирования убытков операционного риска.

#### Модель множественной регрессии Пуассона 6

```{r}
# Построение множественной модели регрессии Пуассона
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка модели регрессии Пуассона
mf_poiss_model6 <- glm(y ~ eurkzt + GDD_Elc_R_y + GDD_Inf_R_y,
data = X, family = poisson())

# Вычисление значений псевдо R-квадрата
pseudo_r2_values6 <- pR2(mf_poiss_model6)

# Печать результатов
summary(mf_poiss_model6)
pseudo_r2_values6

```
**Обнаружения:** McFadden's R^2 = 0.056 указывает, что модель объясняет около 5.6% дисперсии по сравнению с нулевой моделью, что свидетельствует о скромном улучшении подгонки модели, но также подчеркивает возможность дальнейшего совершенствования. Однако значения r^2ML (максимально правдоподобный псевдо R^2) = 0.375 и r^2CU (Cragg-Uhler/Nagelkerke псевдо R^2) = 0.375 дают более обнадеживающие результаты, указывая на то, что около 37.5% вариации в частоте убытков от операционного риска объясняется выбранными макроэкономическими переменными. Эти более высокие значения псевдо R^2 свидетельствуют о том, что модель дает гораздо лучшую подгонку в целом и что макроэкономические переменные имеют значительное влияние на прогнозирование убытков от операционного риска.

#### Создание матрицы корреляций

```{r}
kendall_corr10 <- freq_final_df %>% 
  dplyr::select(eurkzt, GDD_Elc_R_y, GDD_Inf_R_y, Total_freq)

# Вычисление матрицы корреляций Кендалла
kendall_corr10 <- cor(kendall_corr10, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr10)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляций Кендалла с помощью графика корреляций
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr10, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)

```
**Обнаружения:** Независимые и зависимые переменные показывают умеренные отрицательные корреляции между GDD_Elc_R_y и GDD_Inf_R_y с потерями операционного риска, в то время как наблюдается положительная корреляция с eurkzt. Это предполагает, что по мере увеличения некоторых макроэкономических факторов (таких как GDD_Elc_R_y и GDD_Inf_R_y) частота или тяжесть потерь операционного риска склонны уменьшаться, в то время как для eurkzt может наблюдаться обратная зависимость. Хотя корреляция недостаточно сильна для установления прямой причинно-следственной связи, она указывает на умеренную обратную зависимость. Это может быть областью, требующей дальнейшего изучения или уточнения в модели для улучшения предсказательной точности и лучшего понимания динамики между этими переменными и потерями операционного риска.

#### Предположение о линейности

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание разброса для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = eurkzt, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Разброс eurkzt против Total_freq", 
       x = "eurkzt", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание разброса для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Elc_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Разброс GDD_Elc_R_y против Total_freq", 
       x = "GDD_Elc_R_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание разброса для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Inf_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Разброс GDD_Inf_R_y против Total_freq", 
       x = "GDD_Inf_R_y", y = "Total_freq") +
  theme_minimal()

```

**Обнаружения:** Предположение линейности, которое предполагает прямую пропорциональную зависимость между макроэкономическими переменными и убытками от операционного риска, кажется трудно подтверждаемым. Если это предположение нарушается, модель может не учитывать более сложные, нелинейные зависимости, что может привести к смещенным или неэффективным предсказаниям. В контексте прогнозирования операционного риска, где макроэкономические факторы могут взаимодействовать с убытками от риска сложными способами, игнорирование нелинейных динамик может привести к неточным оценкам рисков. Стресс-тестирование с линейной моделью в таких условиях может привести к ложным результатам относительно воздействия и серьезности убытков от операционного риска. Исследование нелинейных моделей или применение трансформаций признаков может повысить точность предсказаний и предоставить более надежные выводы для стресс-тестирования и прогнозирования.

#### Предположение независимости

```{r}
# Использование теста Дурбина-Уотсона
dwtest(mf_poiss_model6)

```
**Обнаружения:** Статистика Дурбина-Уотсона (DW) равна 2.5196, что близко к 2, что указывает на отсутствие значимой автокорреляции в остатках. P-значение 0.745 дополнительно подтверждает этот вывод, поскольку оно предоставляет недостаточно доказательств для утверждения о наличии автокорреляции. Это означает, что остатки не коррелируют во времени, что подтверждает выполнение предположения об отсутствии автокорреляции. Это критически важно для обеспечения надежности предсказаний модели и правильности выполнения её предположений.

#### Предположение распределения Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона:
# График остатков против предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model6$fitted.values, 
                         residuals = residuals(mf_poiss_model6)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки против предсказанных значений", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()

```
**Обнаружения:** Остатки случайным образом распределены вокруг горизонтальной линии на уровне 0 на графике остатков, что предполагает, что предположения модели, вероятно, выполнены. Это случайное распределение без явных закономерностей указывает на хорошее соответствие модели данным. Это подтверждает действительность модели и её пригодность для стресс-тестирования убытков от операционного риска, поскольку нет свидетельств ошибочной спецификации модели или скрытых проблем.

#### Предположение о перенасыщении

```{r}
# Проверка на перенасыщение: Сравнение девиации остатков
# с числом степеней свободы
deviance <- mf_poiss_model6$deviance 
df <- mf_poiss_model6$df.residual 
dispersion <- deviance / df 
dispersion
```
**Обнаружения:** Статистика дисперсии, равная примерно 1, указывает на то, что дисперсия остатков соответствует предположениям модели Пуассона. Это подтверждает, что модель подходит для данных, и предположения относительно распределения зависимой переменной (частоты убытков от операционного риска) выполнены. Такая согласованность гарантирует надежность результатов стресс-тестирования, поддерживая валидность прогнозов модели.

#### Предположение о многоколлинеарности

```{r}
# Проверка на многоколлинеарность: Фактор инфляции дисперсии (VIF)
vif(mf_poiss_model6)
```
**Обнаружения:** Значения VIF, колеблющиеся от 1 до 4, указывают на умеренную многоколлинеарность, что означает, что хотя существует некоторая корреляция между независимыми переменными, она не настолько сильна, чтобы существенно повлиять на надежность или интерпретацию регрессионной модели. Такой уровень многоколлинеарности обычно считается приемлемым, однако рекомендуется следить за возможными проблемами в будущих моделях или предсказаниях. Обеспечение того, чтобы многоколлинеарность не усиливалась в более сложных моделях, поможет поддерживать устойчивость и точность модели.

##### Допущение нормальности. Оценка качества подбора с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление остатков модели
pearson_residuals <- residuals(mf_poiss_model6, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки графиков 1x2 (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой бинов и формата осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличиваем количество бинов
  main = "Гистограмма остатков",
  xlab = "Значение остатка",
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X для отображения чисел без научной нотации
axis(1, at = pretty(residuals), 
     labels = format(pretty(residuals), 
     scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Возврат к стандартному формату графиков
par(mfrow = c(1, 1))
```
**Обнаружения:** Гистограмма остатков показывает нормальное распределение, однако точки на Q-Q графике не образуют прямую линию, что подтверждает неполное соответствие предположению о нормальности для данной модели. Это указывает на наличие отклонений в остатках модели, что ставит под сомнение общую валидность и точность прогнозов и выводов модели.

#### Модель множественной регрессии Пуассона 7

```{r}
# Построение множественной пуассоновской регрессионной модели
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка пуассоновской регрессионной модели
mf_poiss_model7 <- glm(y ~ rurkzt + GDD_R_y + Rincpop_q_y, 
                      data = X, family = poisson())

# Вычисление псевдо R-квадрат значений
pseudo_r2_values7 <- pR2(mf_poiss_model7)

# Вывод результатов
summary(mf_poiss_model7)
pseudo_r2_values7
```
**Обнаружения:** Значение R^2 МакФаддена 0.0756 указывает, что модель объясняет лишь 7.6% дисперсии по сравнению с нулевой моделью, демонстрируя некоторое улучшение, но оставляя потенциал для дальнейшей доработки. Однако значения r^2ML (псевдо-R^2 максимального правдоподобия) и r^2CU (псевдо-R^2 Крэгга-Улера/Нагелькерке) на уровне 0.47 свидетельствуют, что около 47% вариации операционных убытков объясняется включенными в модель макроэкономическими переменными. Эти метрики указывают на более существенную объясняющую способность выбранных переменных для понимания частоты операционных убытков, хотя для повышения прогнозной точности возможны дальнейшие улучшения.

#### Создание корреляционной матрицы

```{r}
# Выбор переменных для корреляционного анализа
kendall_corr11 <- freq_final_df %>% 
  dplyr::select(rurkzt, GDD_R_y, Rincpop_q_y, Total_freq)

# Вычисление корреляционной матрицы Кендалла
kendall_corr11 <- cor(kendall_corr11, method = "kendall", 
                    use = "complete.obs")

# Вывод корреляционной матрицы
print(kendall_corr11)
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация корреляционной матрицы Кендалла
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                         "#77AADD", "#4477AA"))
corrplot(kendall_corr11, method = "color", col = col(200),
        type = "upper", order = "hclust",
        addCoef.col = "black",
        tl.col = "black", tl.srt = 45)          
```
**Обнаружения:** Наблюдаемые умеренные отрицательные корреляции между независимыми и зависимой переменной указывают, что при росте определенных макроэкономических показателей частота или тяжесть операционных убытков имеет тенденцию к снижению, и наоборот. Хотя корреляция недостаточно сильна для подтверждения прямой причинно-следственной связи, эта обратная взаимосвязь заслуживает дальнейшего изучения. Усовершенствование модели может помочь прояснить характер этих взаимосвязей и потенциально повысить точность прогнозирования операционных убытков.

#### Проверка линейности зависимости

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграмм рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = rurkzt, y = Total_freq)) +
  geom_point() +
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния: rurkzt vs. Total_freq",
       x = "rurkzt", y = "Total_freq") +
  theme_minimal()
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Построение диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_R_y, y = Total_freq)) +
  geom_point() +
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния: GDD_R_y и Total_freq",
       x = "GDD_R_y", y = "Total_freq") +
  theme_minimal()
```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = Rincpop_q_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния: Rincpop_q_y vs. Total_freq", 
       x = "Rincpop_q_y", y = "Total_freq") +
  theme_minimal()
```
**Обнаружения:** Трудности с подтверждением наличия линейных зависимостей между независимыми и зависимой переменными указывают на возможное нарушение предположения о линейности. Это предположение подразумевает пропорциональную связь между предикторами (макроэкономическими переменными) и откликом (операционными убытками). При его нарушении модель может не улавливать сложные нелинейные взаимосвязи, что приводит к смещенным или неэффективным прогнозам. Для прогнозирования операционных рисков, где макроэкономические факторы могут нелинейно взаимодействовать с убытками, использование исключительно линейных моделей может давать неточные результаты. Для повышения точности прогнозов и более эффективного стресс-тестирования операционных убытков стоит рассмотреть нелинейные модели или преобразования признаков, чтобы лучше отразить эти сложные взаимосвязи.

#### Предположение о независимости

```{r}
# Проведение теста Дарбина-Уотсона
dwtest(mf_poiss_model7)
```
**Обнаружения:** Статистика Дарбина-Уотсона (DW) 2.1286, близкая к 2, указывает на отсутствие значимой автокорреляции в остатках модели. P-значение 0.4345 дополнительно подтверждает этот вывод, демонстрируя недостаточность оснований предполагать наличие автокорреляции. Это означает независимость остатков во времени и соответствие модели предположению об отсутствии автокорреляции. Полученный результат важен, поскольку подтверждает надежность прогнозов модели и отсутствие систематических ошибок, связанных с автокорреляцией остатков.

#### Проверка соответствия распределению Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона:
# График остатков от предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model7$fitted.values, 
                        residuals = residuals(mf_poiss_model7)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки vs. Предсказанные значения (Проверка распределения Пуассона)", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()
```
**Обнаружения:** Распределение остатков случайным образом вокруг горизонтальной линии на уровне 0 на графике остатков позволяет предположить, что предположения модели выполняются. Это указывает на хорошее соответствие модели данным и отсутствие явных закономерностей в остатках, что является ключевым признаком адекватно подобранной модели. Такое случайное распределение свидетельствует, что модель корректно отражает базовые взаимосвязи без переобучения или систематических ошибок, подтверждая обоснованность и применимость модели для стресс-тестирования операционных убытков.

#### Проверка предположения о сверхдисперсии

```{r}
# Проверка сверхдисперсии: Сравнение остаточной девиации
# со степенями свободы
deviance <- mf_poiss_model7$deviance
df <- mf_poiss_model7$df.residual
dispersion <- deviance / df
dispersion
```
**Обнаружения:** Значение статистики дисперсии 0.7858, которое меньше 1, указывает на недостаточную дисперсию (underdispersion) в модели. Это может свидетельствовать о переобучении модели и аличии избыточного количества нулевых значений в данных.
Недостаточная дисперсия возникает, когда дисперсия остатков меньше ожидаемой для нпредполагаемого распределения (в данном случае - распределения Пуассона). Это может означать, что модель не полностью учитывает важные особенности данных, что требует: 
Дополнительного анализа на предмет переобучения
Рассмотрения модификаций модели для учета:
избытка нулей (zero-inflation)
других особенностей распределения данных

#### Проверка на мультиколлинеарность

```{r}
# Проверка мультиколлинеарности: фактор инфляции дисперсии (VIF)
vif(mf_poiss_model7)
```
**Обнаружения:** Значения VIF в диапазоне от 1 до 4 указывают на умеренную мультиколлинеарность между независимыми переменными. Этот уровень корреляции между предикторами не является настолько значительным, чтобы существенно повлиять на надежность или интерпретацию регрессионной модели. Тем не менее, важно сохранять бдительность в отношении потенциальных проблем, которые могут возникнуть из-за мультиколлинеарности при будущем моделировании или прогнозировании. При необходимости дополнительные корректировки, такие как отбор признаков, регуляризация или преобразования, могут помочь смягчить ее влияние на производительность модели. Значения VIF находятся в пределах от 1 до 4, что свидетельствует об умеренной мультиколлинеарности. Хотя между независимыми переменными существует некоторая корреляция, показатели остаются на приемлемом уровне, а значит, мультиколлинеарность не является настолько серьезной, чтобы существенно повлиять на надежность или интерпретацию регрессионной модели. Однако по-прежнему важно отслеживать и учитывать потенциальные проблемы при дальнейшем моделировании или прогнозировании.

#### Проверка предположения о нормальности. Проверка соответствия модели с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление остатков модели
pearson_residuals <- residuals(mf_poiss_model7, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки графиков 1x2 (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой бинов и формата осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличение количества бинов
  main = "Гистограмма остатков",
  xlab = "Значение остатка", 
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X для отображения без научной нотации
axis(1, at = pretty(residuals),
     labels = format(pretty(residuals),
     scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Сброс настроек расположения графиков
par(mfrow = c(1, 1))
```
**Обнаружения:** Гистограмма остатков демонстрирует нормальное распределение, что подтверждает выполнение предположения о нормальности для данной модели. Кроме того, Q-Q график отображает прямую линию, что дополнительно подтверждает нормальное распределение остатков. Это соответствие указывает на то, что остатки модели не имеют значительных отклонений от нормального распределения, что крайне важно для обеспечения надежности статистических выводов, включая проверку гипотез и доверительные интервалы. Таким образом, модель удовлетворяет предположению о нормальности, что подтверждает её пригодность для стресс-тестирования операционных убытков.

#### Модель множественной регрессии Пуассона 8

```{r}
# Построение множественной пуассоновской регрессионной модели
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка пуассоновской регрессионной модели
mf_poiss_model8 <- glm(y ~ poil + GDD_Elc_R_y + GDD_Trd_R_y, 
                      data = X, family = poisson())

# Вычисление псевдо-R-квадрат значений
pseudo_r2_values8 <- pR2(mf_poiss_model8)

# Вывод результатов
summary(mf_poiss_model8)
pseudo_r2_values8

```
**Обнаружения:** R^2 МакФаддена 0.0448 указывает, что модель объясняет только около 4.5% дисперсии по сравнению с нулевой моделью, что подразумевает ограниченную объясняющую способность и потенциал для улучшения. Однако r²ML (псевдо-R² максимального правдоподобия) 0.3138 и r^2CU (псевдо-R^2 Крэгга-Улера/Нагелькерке) 0.3137 значительно выше, указывая, что примерно 31.4% вариации операционных убытков объясняется выбранными макроэкономическими переменными. Эти значения псевдо-R^2 предполагают более сильное соответствие модели, хотя дальнейшие уточнения и корректировки могут потребоваться для повышения точности прогнозирования.

#### Создание корреляционной матрицы

```{r}
# Создание корреляционной матрицы
kendall_corr12 <- freq_final_df %>% 
  dplyr::select(poil, GDD_Elc_R_y, GDD_Trd_R_y, Total_freq)

# Расчёт корреляционной матрицы по методу Кендалла
kendall_corr12 <- cor(kendall_corr12, method = "kendall", 
                      use = "complete.obs")
print(kendall_corr12)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация корреляционной матрицы Кендалла с помощью графика корреляций
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr12, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45,
)

```
**Обнаружения:** Умеренные отрицательные корреляции между независимыми и зависимой переменными указывают на обратную зависимость, при которой увеличение некоторых макроэкономических переменных связано со снижением частоты или тяжести операционных убытков. Хотя сила корреляции недостаточна для установления чёткой причинно-следственной связи, такая обратная зависимость заслуживает дальнейшего изучения. Уточнение модели или включение дополнительных переменных может помочь прояснить характер этих взаимосвязей и повысить точность прогнозирования операционных убытков.

#### Предположение линейности

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = poil, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния: poil против Total_freq", 
       x = "poil", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Elc_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния: GDD_Elc_R_y против Total_freq", 
       x = "GDD_Elc_R_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Trd_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния: GDD_Trd_R_y против Total_freq", 
       x = "GDD_Trd_R_y", y = "Total_freq") +
  theme_minimal()

```

**Обнаружения:** Трудности в подтверждении линейных взаимосвязей между независимыми и зависимой переменными указывают на возможное нарушение предположения линейности. Если связь между макроэкономическими переменными и операционными убытками носит нелинейный характер, использование линейной модели может привести к неточным прогнозам. Это может вызвать вводящие в заблуждение выводы о тяжести и влиянии операционных убытков при различных макроэкономических условиях. Для повышения точности прогнозов может быть полезно исследовать нелинейные модели или рассмотреть возможность трансформации признаков для захвата более сложных взаимодействий между переменными.

#### Предположение независимости

```{r}
# Применение теста Дарбина-Уотсона
dwtest(mf_poiss_model8)

```
**Обнаружения:** Статистика Дарбина-Уотсона (DW) равная 2.4516, близкая к 2, указывает на отсутствие значимой автокорреляции в остатках модели. Значение p 0.6877 дополнительно поддерживает этот вывод, так как оно не предоставляет достаточных оснований для предположения о наличии автокорреляции. Это подтверждает, что остатки не коррелированы во времени, и предположение об отсутствии автокорреляции выполняется. Это важно для обеспечения надежности и достоверности предсказаний модели.

#### Предположение о распределении Пуассона


```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона: 
# График остатков против предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model8$fitted.values, 
                         residuals = residuals(mf_poiss_model8)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки против предсказанных значений", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()

```
**Обнаружения:** Остатки, случайным образом распределенные вокруг горизонтальной линии на уровне 0 на графике остатков, указывают на то, что предположения модели, вероятно, выполнены. Это означает, что модель хорошо аппроксимирует данные, так как в остатках нет очевидной закономерности. Это важный индикатор хорошо подогнанной модели и подтверждает её достоверность, делая её подходящей для стресс-тестирования потерь операционного риска.

#### Предположение об избыточной дисперсии


```{r}
# Проверка на избыточную дисперсию: Сравнение отклонения остатков 
# с количеством степеней свободы
deviance <- mf_poiss_model8$deviance
df <- mf_poiss_model8$df.residual
dispersion <- deviance / df
dispersion

```
**Обнаружения:** Значение дисперсии, близкое к 1, указывает на то, что модель Пуассона является подходящей, так как нет значительной избыточной дисперсии. Это означает, что предположения относительно распределения зависимой переменной (частоты потерь по операционному риску) выполнены, что критично для обеспечения надежности результатов стресс-тестирования. Подходящесть модели поддерживает точное прогнозирование и оценку потерь по операционному риску.

#### Предположение о мультиколлинеарности

```{r}
# Проверка на мультиколлинеарность: Фактор инфляции дисперсии (VIF)
vif(mf_poiss_model8)
```
**Обнаружения:** Значения VIF варьируются от 1 до 8, что указывает на умеренную мультиколлинеарность. Хотя существует некоторая корреляция между независимыми переменными, она не настолько сильная, чтобы существенно повлиять на надежность или интерпретацию регрессионной модели. Тем не менее, важно оставаться осторожным и следить за возможными проблемами мультиколлинеарности в будущих моделях или предсказаниях, так как это все еще может повлиять на точность оценок коэффициентов.

#### Допущение нормальности. Оценка качества подгонки с использованием перссоновских остатков

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление остатков модели
pearson_residuals <- residuals(mf_poiss_model8, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки из 1x2 графиков (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настроенными интервалами и форматированием осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличьте количество интервалов
  main = "Гистограмма остатков",
  xlab = "Значение остатка",
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси x для удаления научной нотации
axis(1, at = pretty(residuals), 
     labels = format(pretty(residuals), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Сбросить настройки графика по умолчанию
par(mfrow = c(1, 1))

```
**Обнаружения:** Гистограмма остатков показывает близость к нормальному распределению, а Q-Q график указывает, что остатки почти следуют прямой линии. Это подтверждает, что предположение о нормальности не полностью выполнено, что свидетельствует о том, что остатки модели отклоняются от нормального распределения. Это не поддерживает достоверность статистических выводов, таких как тестирование гипотез и доверительные интервалы, что подчеркивает надежность модели для стресс-тестирования убытков операционного риска.

#### Модель множественной регрессии Пуассона 9


```{r}
# Построение множественной модели пуассоновской регрессии
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка модели пуассоновской регрессии
mf_poiss_model9 <- glm(y ~ poil + GDD_Trd_R_y + Rexppop_q_y , 
                      data = X, family = poisson())

# Расчет значений псевдо R-квадрат
pseudo_r2_values9 <- pR2(mf_poiss_model9)

# Вывод результатов
summary(mf_poiss_model9)
pseudo_r2_values9


```
**Обнаружения:** McFadden's R^2, равный 0.04256, указывает на то, что модель объясняет около 4,3% дисперсии по сравнению с нулевой моделью, что свидетельствует о некотором улучшении, но также показывает, что модель все еще может быть улучшена. Однако r^2ML (максимально-правдоподобный псевдо R^2) равный 0.301 и r^2CU (псевдо R^2 Cragg-Uhler/Nagelkerke) равный 0.301 указывают на более благоприятную подгонку модели, что предполагает, что примерно 30,1% вариации в частоте потерь от операционного риска объясняется выбранными макроэкономическими переменными. Эти метрики предполагают, что модель лучше соответствует данным и имеет разумную объяснительную силу.

#### Создание корреляционной матрицы


```{r}
kendall_corr13 <- freq_final_df %>% 
  dplyr:: select(poil, GDD_Trd_R_y, Rexppop_q_y, Total_freq)

# Вычисление корреляционной матрицы по методу Кендалла
kendall_corr13 <- cor(kendall_corr13, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr13)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация корреляционной матрицы Кендалла с помощью корреляционного графика
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr13, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45,
         
)

```
**Обнаружения:** Умеренные отрицательные корреляции между независимыми и зависимыми переменными предполагают, что по мере увеличения определённых макроэкономических переменных частота или степень серьёзности убытков от операционного риска имеет тенденцию снижаться и наоборот. Хотя корреляция недостаточно сильна, чтобы установить прямую причинно-следственную связь, эта обратная зависимость требует дальнейшего исследования. Возможно, будет полезно уточнить модель, учитывая дополнительные переменные, взаимодействия или нелинейные зависимости, чтобы повысить предсказательную точность и лучше отразить основные динамики убытков от операционного риска.

#### Допущение линейности


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = poil, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния poil vs. Total_freq", 
       x = "poil", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Trd_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния GDD_Trd_R_y vs. Total_freq", 
       x = "GDD_Trd_R_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = Rexppop_q_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния Rexppop_q_y vs. Total_freq", 
       x = "Rexppop_q_y", y = "Total_freq") +
  theme_minimal()

```

**Обнаружения:** Трудности с подтверждением линейных зависимостей между независимыми и зависимой переменными указывают на потенциальную проблему с предположением о линейности. Если связь между предикторами (макроэкономическими переменными) и зависимой переменной (операционными убытками) не является строго линейной, модель может неадекватно отражать более сложные взаимосвязи, что потенциально приведет к смещенным или неэффективным прогнозам. Учитывая, что макроэкономические факторы могут иметь нелинейные взаимосвязи с убытками, крайне важно рассмотреть нелинейные модели или преобразования признаков. Такие корректировки могут повысить точность прогнозирования и обеспечить более надежные результаты стресс-тестирования, что в конечном итоге позволит получить более точные оценки потенциального воздействия и масштаба операционных убытков.

#### Проверка предположения о независимости

```{r}
# Проведение теста Дарбина-Уотсона
dwtest(mf_poiss_model9)
```
**Обнаружения:** Статистика Дарбина-Уотсона (DW) составляет 2.4276, что близко к идеальному значению 2. Это указывает на отсутствие значимой автокорреляции в остатках модели. P-значение 0.662 дополнительно подтверждает этот вывод, так как не дает достаточных оснований отвергнуть нулевую гипотезу об отсутствии автокорреляции. Эти результаты подтверждают, что остатки не коррелированы во времени, что валидирует предположение об отсутствии автокорреляции. Данный вывод имеет критическое значение для обеспечения надежности и точности прогнозов модели.

#### Проверка предположения о распределении Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона:
# График остатков от предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model9$fitted.values, 
                         residuals = residuals(mf_poiss_model9)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки vs. Предсказанные значения", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()
```
**Обнаружения:** График остатков демонстрирует случайное распределение точек вокруг нулевой горизонтальной линии, что свидетельствует о выполнении предположений модели и ее хорошем соответствии данным. Отсутствие выраженных закономерностей в остатках является положительным признаком адекватности модели, подтверждая ее валидность и пригодность для стресс-тестирования операционных убытков.

#### Проверка предположения о сверхдисперсии

```{r}
# Проверка сверхдисперсии: Сравнение остаточной девиации
# со степенями свободы
deviance <- mf_poiss_model9$deviance
df <- mf_poiss_model9$df.residual
dispersion <- deviance / df
dispersion
```
**Обнаружения:** Значение дисперсии, близкое к 1, указывает на то, что модель Пуассона подходит и нет значительной перегибности. Это подтверждает пригодность модели для данных и подтверждает, что выполнены распределительные предположения для частоты потерь по операционному риску. Это важно для обеспечения надежности результатов стресс-тестирования.

#### Предположение о мультиколлинеарности

```{r}
# Проверка на мультиколлинеарность: Фактор инфляции дисперсии (VIF)
vif(mf_poiss_model9)
```
**Обнаружения:** Факторы инфляции дисперсии (VIF) от 2 до 8 указывают на умеренную мультиколлинеарность. Хотя существует некоторая корреляция между независимыми переменными, её влияние на надежность и интерпретируемость регрессионной модели выглядит приемлемым. Мультиколлинеарность недостаточно сильна, чтобы представлять собой серьезную проблему. Тем не менее, её следует контролировать и учитывать в будущих моделях или предсказаниях.

#### Допущение нормальности. Оценка качества подгонки с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Расчет остатков модели
pearson_residuals <- residuals(mf_poiss_model9, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки 1x2 графиков (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой числа корзин и форматирования осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличение количества корзин
  main = "Гистограмма остатков",
  xlab = "Значение остатка",
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси x для удаления научной нотации
axis(1, at = pretty(residuals), 
     labels = format(pretty(residuals), 
                                                scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Сбросить настройку графика по умолчанию
par(mfrow = c(1, 1))

```
**Обнаружения:** Почти нормальное распределение остатков, как показано на гистограмме, подтверждает допущение нормальности для этой модели. Это также подтверждается Q-Q графиком, где остатки близко расположены вдоль прямой линии. Эти результаты предполагают, что отклонения от нормального распределения незначительны, что укрепляет надежность статистических выводов, сделанных на основе модели, включая тесты гипотез и доверительные интервалы.

#### Модель множественной регрессии Пуассона 10


```{r}
# Построение модели множественной регрессии Пуассона
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка модели регрессии Пуассона
mf_poiss_model10 <- glm(y ~ cpi + GDD_Elc_R_y + GDD_Inf_R_y , 
                      data = X, family = poisson())

# Расчет псевдо R-квадрат значений
pseudo_r2_values10 <- pR2(mf_poiss_model10)

# Вывод результатов
summary(mf_poiss_model10)
pseudo_r2_values10


```
**Обнаружения:** McFadden's R^2 равное 0.0546 указывает на то, что модель объясняет примерно 5,5% вариации по сравнению с нулевой моделью, что предполагает некоторое улучшение, но также подчеркивает возможность дальнейшего усовершенствования. Однако r^2ML (псевдо-R^2 максимального правдоподобия) и r^2CU (псевдо-R^2 Cragg-Uhler/Nagelkerke) равные 0.368 указывают на более значительную объяснительную силу, что означает, что модель объясняет примерно 36,8% вариации частоты потерь от операционного риска, используя выбранные макроэкономические переменные. Эти последние показатели предлагают более оптимистичную оценку общей подгонки модели.

#### Создание матрицы корреляций

```{r}
kendall_corr14 <- freq_final_df %>% 
  dplyr:: select(cpi, GDD_Elc_R_y, GDD_Inf_R_y, Total_freq)

# Вычисление матрицы корреляций Кендалла
kendall_corr14 <- cor(kendall_corr14, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr14)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляций Кендалла с помощью графика корреляции
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr14, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45,
         
)

```
**Обнаружения:** Независимые и зависимые переменные показывают умеренные отрицательные корреляции с GDD_Elc_R_y и GDD_Inf_R_y, а также умеренную положительную корреляцию с CPI. Это предполагает, что частота или тяжесть убытков от операционного риска имеют тенденцию снижаться по мере роста первых двух макроэкономических переменных, и увеличиваться с ростом CPI. Хотя эти корреляции недостаточно сильны, чтобы установить причинно-следственную связь, они выявляют умеренные обратные и положительные ассоциации, соответственно, что требует дальнейшего исследования и возможных улучшений модели для повышения предсказательной точности.


#### Предположение о линейности


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = cpi, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния cpi vs. Total_freq", 
       x = "cpi", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Elc_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния GDD_Elc_R_y vs. Total_freq", 
       x = "GDD_Elc_R_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Inf_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния GDD_Inf_R_y vs. Total_freq", 
       x = "GDD_Inf_R_y", y = "Total_freq") +
  theme_minimal()
```

**Обнаружения:** Установить линейные зависимости между независимыми и зависимыми переменными сложно. Предположение о линейности предполагает прямую пропорциональную зависимость между предсказателями (макроэкономическими переменными) и откликом (убытками от операционного риска). Если это предположение нарушено, модель может не учесть более сложные, нелинейные взаимосвязи, что может привести к смещенным или неэффективным предсказаниям. Для прогнозирования операционного риска, где макроэкономические факторы могут взаимодействовать с убытками от риска сложным образом, игнорирование нелинейных взаимосвязей может привести к неточным оценкам. Стресс-тесты, основанные на линейной модели в таких условиях, могут дать вводящие в заблуждение выводы о потенциальном воздействии и серьезности убытков от операционного риска. Для улучшения предсказательной точности может потребоваться исследование нелинейных моделей или преобразований признаков.

#### Предположение независимости

```{r}
# Применение теста Дарбина-Уотсона
dwtest(mf_poiss_model10)
```
**Обнаружения:** Статистика Дарбина-Уотсона 2.4955, близкая к 2, указывает на отсутствие значимой автокорреляции в остатках модели. Это подтверждается высоким p-значением 0.723, которое не дает достаточных оснований отвергнуть нулевую гипотезу об отсутствии автокорреляции. Полученные результаты свидетельствуют, что остатки не коррелированы во времени, что удовлетворяет предположению об отсутствии автокорреляции и подтверждает надежность прогнозов модели.

#### Проверка предположения о распределении Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона:
# График остатков от предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model10$fitted.values, 
                         residuals = residuals(mf_poiss_model10)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки vs. Прогнозируемые значения", 
       x = "Прогнозируемые значения", y = "Остатки") +
  theme_minimal()
```
**Обнаружения:** Случайное распределение остатков вокруг нулевой линии на графике остатков свидетельствует о том, что предположения модели, вероятно, выполняются, и модель хорошо соответствует данным. Отсутствие discernible закономерностей в остатках является ключевым показателем хорошо подобранной модели, подтверждая ее валидность и пригодность для стресс-тестирования операционных убытков.

#### Проверка предположения о сверхдисперсии

```{r}
# Проверка сверхдисперсии: Сравнение остаточной девиации
# со степенями свободы
deviance <- mf_poiss_model10$deviance
df <- mf_poiss_model10$df.residual
dispersion <- deviance / df
dispersion
```
**Обнаружения:** Значение дисперсии, близкое к 1, указывает, что пуассоновская модель подходит, без значительной сверхдисперсии. Это подтверждает соответствие модели данным и выполнение распределительных предположений для частоты операционных убытков, что важно для надежности результатов стресс-тестирования.

#### Проверка предположения об отсутствии мультиколлинеарности

```{r}
# Проверка мультиколлинеарности: фактор инфляции дисперсии (VIF)
vif(mf_poiss_model10)
```
**Обнаружения:** Значения VIF между 1 и 5 указывают на умеренную мультиколлинеарность. Хотя между независимыми переменными существует некоторая корреляция, ее влияние на надежность и интерпретацию регрессионной модели остается приемлемым. Уровень мультиколлинеарности не является критическим, однако требует внимания при дальнейшем моделировании.

#### Проверка предположения о нормальности. Оценка соответствия модели с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление остатков модели
pearson_residuals <- residuals(mf_poiss_model10, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки графиков 1x2 (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой бинов и осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличение количества бинов
  main = "Гистограмма остатков",
  xlab = "Значение остатка", 
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X без научной нотации
axis(1, at = pretty(residuals), 
     labels = format(pretty(residuals),
     scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Восстановление стандартных настроек графиков
par(mfrow = c(1, 1))
```
**Обнаружения:** Гистограмма остатков предполагает нормальное распределение, что подтверждает предположение о нормальности модели. Однако это не подтверждается Q-Q графиком, где остатки не следуют прямой линии. Эти результаты показывают, что остатки отклоняются от нормального распределения, что ставит под сомнение надежность статистических выводов, таких как тесты гипотез и доверительные интервалы.

#### Модель множественной регрессии Пуассона 11


```{r}
#### Множественная модель Пуассона 11
X <- freq_final_df
y <- freq_final_df$Total_freq

# Подгонка модели Пуассона
mf_poiss_model11 <- glm(y ~ cpi + GDD_Inf_R_y + Rexppop_q_y, 
                        data = X, family = poisson())

# Вычисление псевдо R-квадратов
pseudo_r2_values11 <- pR2(mf_poiss_model11)

# Печать результатов
summary(mf_poiss_model11)
pseudo_r2_values11


```
**Обнаружения:** Значение McFadden's R^2, равное 0.0478, указывает на то, что модель объясняет примерно 4,8% вариации по сравнению с нулевой моделью, что говорит о некотором улучшении, но также подчеркивает значительное пространство для усовершенствования. Однако значения r^2ML (псевдо-R^2 максимального правдоподобия) и r^2CU (псевдо-R^2 Крагга-Улера/Нагелкерке), равные 0.331, предполагают более значительную объясняющую способность, что означает, что модель объясняет примерно 33,1% вариации частоты операционных потерь с использованием выбранных макроэкономических переменных. Эти последние псевдо-R^2 значения предлагают более оптимистичный взгляд на общую подгонку модели.

#### Создание корреляционной матрицы

```{r}
kendall_corr15 <- freq_final_df %>% 
  dplyr::select(cpi, GDD_Inf_R_y, Rexppop_q_y, Total_freq)

# Расчет корреляционной матрицы Кендалла
kendall_corr15 <- cor(kendall_corr15, method = "kendall", 
                      use = "complete.obs")
print(kendall_corr15)

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляции Кендалла с помощью корреляционного графика
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr15, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)

```
**Обнаружения:** Независимые и зависимые переменные показывают умеренные отрицательные корреляции с GDD_Inf_R_y и Rexppop_q_y, а также умеренную положительную корреляцию с CPI. Это предполагает, что по мере увеличения первых двух макроэкономических переменных частота или серьезность убытков от операционного риска имеют тенденцию снижаться, в то время как с CPI они имеют тенденцию увеличиваться. Хотя эти корреляции не устанавливают причинно-следственные связи, они показывают умеренные обратные и положительные ассоциации, которые требуют дальнейшего исследования и возможных улучшений модели для повышения точности прогнозирования.

#### Предположение о линейности


```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = cpi, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Диаграмма рассеяния cpi vs. Total_freq", 
       x = "cpi", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = GDD_Inf_R_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "green") +
  labs(title = "Диаграмма рассеяния GDD_Inf_R_y vs. Total_freq", 
       x = "GDD_Inf_R_y", y = "Total_freq") +
  theme_minimal()

```

```{r fig.align="center", fig.width=6, fig.height=4}
# Создание диаграммы рассеяния для каждой независимой переменной 
# и зависимой переменной
ggplot(data = freq_final_df, aes(x = Rexppop_q_y, y = Total_freq)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "blue") +
  labs(title = "Диаграмма рассеяния Rexppop_q_y vs. Total_freq", 
       x = "Rexppop_q_y", y = "Total_freq") +
  theme_minimal()

```

**Обнаружения:** Установление линейных зависимостей между независимыми и зависимыми переменными представляет собой сложную задачу.  Предположение о линейности требует прямой пропорциональной зависимости между предикторами (макроэкономическими переменными) и ответной переменной (убытками от операционного риска).  Если это предположение нарушено, модель может не справиться с выявлением более сложных, нелинейных зависимостей, что может привести к смещенным или неэффективным прогнозам.  В прогнозировании операционного риска, где макроэкономические факторы могут взаимодействовать с убытками от рисков сложными способами, игнорирование нелинейных зависимостей может привести к неточным оценкам.  Стресс-тесты на основе линейной модели в таких ситуациях могут привести к ложным выводам о потенциальном воздействии и тяжести убытков от операционного риска.  Исследование нелинейных моделей или создание новых признаков может быть необходимо для улучшения точности прогноза.


#### Предположение независимости


```{r}
# Использование теста Дурбина-Уотсона
dwtest(mf_poiss_model11)

```
**Обнаружения:** Статистика Дурбина-Уотсона равная 2.386, что близко к 2, указывает на отсутствие значимой автокорреляции в остатках модели. Это подтверждается p-значением 0.6182, которое не предоставляет достаточных доказательств для утверждения о наличии автокорреляции. Эти результаты означают, что остатки не коррелируют во времени, что удовлетворяет предположению об отсутствии автокорреляции и подтверждает надежность предсказаний модели.

#### Предположение о распределении Пуассона

```{r fig.align="center", fig.width=6, fig.height=4}
# Проверка предположения о распределении Пуассона: 
# График остатков против предсказанных значений
ggplot(data = data.frame(fitted = mf_poiss_model11$fitted.values, 
                         residuals = residuals(mf_poiss_model11)), 
       aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Остатки против предсказанных значений", 
       x = "Предсказанные значения", y = "Остатки") +
  theme_minimal()

```
**Обнаружения:** Случайное распределение остатков вокруг нуля на графике остатков предполагает, что предположения модели, вероятно, выполнены, и модель хорошо подогнана. Отсутствие заметного паттерна является важным индикатором хорошо подобранной модели, подтверждая её правомерность и пригодность для стресс-тестирования убытков от операционного риска.

#### Проверка сверхдисперсии

```{r}
# Проверка сверхдисперсии: Сравнение остаточной девиации
# со степенями свободы
deviance <- mf_poiss_model11$deviance
df <- mf_poiss_model11$df.residual
dispersion <- deviance / df
dispersion
```
**Обнаружения:** Значение дисперсии, близкое к 1, указывает на:
Соответствие пуассоновской модели
Отсутствие существенной сверхдисперсии
Выполнение ключевых распределительных предположений
Это подтверждает надежность:
Статистических выводов модели
Прогнозных оценок частоты убытков
Результатов стресс-тестирования/

####Проверка предположения об отсутствии мультиколлинеарности

```{r}
# Проверка мультиколлинеарности: фактор инфляции дисперсии (VIF)
vif(mf_poiss_model11)
```
**Обнаружения:** Значения VIF между 2 и 5 указывают на умеренную мультиколлинеарность. Хотя между независимыми переменными существует некоторая корреляция, ее влияние на надежность и интерпретацию модели остается приемлемым. Уровень мультиколлинеарности не является критическим, но требует внимания при дальнейшей работе с моделью.

#### Проверка предположения о нормальности. Оценка соответствия модели с использованием остатков Пирсона

```{r fig.align="center", fig.width=6, fig.height=4}
# Вычисление остатков модели
pearson_residuals <- residuals(mf_poiss_model11, type = "pearson")
qqnorm(pearson_residuals)
qqline(pearson_residuals)

# Создание сетки графиков 1x2 (гистограмма и Q-Q график)
par(mfrow = c(1, 2), mar = c(5, 4, 4, 2))

# Гистограмма остатков с настройкой бинов и осей
hist(
  pearson_residuals,
  breaks = 5,  # Увеличение количества бинов
  main = "Гистограмма остатков",
  xlab = "Значение остатка",
  col = "skyblue",
  border = "black",
  xaxt = "n"
)

# Настройка оси X без научной нотации
axis(1, at = pretty(residuals), 
     labels = format(pretty(residuals), 
     scientific = FALSE))

# Q-Q график остатков
qqnorm(pearson_residuals, main = "Q-Q график нормальности")
qqline(pearson_residuals, col = "red")

# Восстановление стандартных настроек графиков
par(mfrow = c(1, 1))
```
**Обнаружения:** Гистограмма остатков предполагает нормальное распределение, что поддерживает предположение о нормальности модели. Это дополнительно подтверждается графиком Q-Q, где остатки тесно выравниваются вдоль прямой линии. Эти обнаружения указывают на то, что остатки не отклоняются существенно от нормального распределения, усиливая надежность статистических выводов, включая тесты гипотез и доверительные интервалы.

### Анализ средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE)

```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 1
options(scipen = 999)
poisson_residuals <- residuals(mf_poiss_model, type = "response")
mse_poisson_model <- mean(poisson_residuals^2)
mse_poisson_model
rmse_poisson_model <- sqrt(mse_poisson_model)
rmse_poisson_model
deviance_explained <- 1 - (mf_poiss_model$deviance / mf_poiss_model$null.deviance)
deviance_explained
pseudo_r2_values
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 2
options(scipen = 999)
poisson_residuals2 <- residuals(mf_poiss_model2, type = "response")
mse_poisson_model2 <- mean(poisson_residuals2^2)
mse_poisson_model2
rmse_poisson_model2 <- sqrt(mse_poisson_model2)
rmse_poisson_model2
deviance_explained2 <- 1 - (mf_poiss_model2$deviance / mf_poiss_model2$null.deviance)
deviance_explained2
pseudo_r2_values2
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE)
# для модели Пуассоновской регрессии 3
options(scipen = 999)
poisson_residuals3 <- residuals(mf_poiss_model3, type = "response")
mse_poisson_model3 <- mean(poisson_residuals3^2)
mse_poisson_model3
rmse_poisson_model3 <- sqrt(mse_poisson_model3)
rmse_poisson_model3
deviance_explained3 <- 1 - (mf_poiss_model3$deviance / mf_poiss_model3$null.deviance)
deviance_explained3
pseudo_r2_values3
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 4
options(scipen = 999)
poisson_residuals4 <- residuals(mf_poiss_model4, type = "response")
mse_poisson_model4 <- mean(poisson_residuals4^2)
mse_poisson_model4
rmse_poisson_model4 <- sqrt(mse_poisson_model4)
rmse_poisson_model4
deviance_explained4 <- 1 - (mf_poiss_model4$deviance / mf_poiss_model4$null.deviance)
deviance_explained4
pseudo_r2_values4
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 5
options(scipen = 999)
poisson_residuals5 <- residuals(mf_poiss_model5, type = "response")
mse_poisson_model5 <- mean(poisson_residuals5^2)
mse_poisson_model5
rmse_poisson_model5 <- sqrt(mse_poisson_model5)
rmse_poisson_model5
deviance_explained5 <- 1 - (mf_poiss_model5$deviance / mf_poiss_model5$null.deviance)
deviance_explained5
pseudo_r2_values5
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 6
options(scipen = 999)
poisson_residuals6 <- residuals(mf_poiss_model6, type = "response")
mse_poisson_model6 <- mean(poisson_residuals6^2)
mse_poisson_model6
rmse_poisson_model6 <- sqrt(mse_poisson_model6)
rmse_poisson_model6
deviance_explained6 <- 1 - (mf_poiss_model6$deviance / mf_poiss_model6$null.deviance)
deviance_explained6
pseudo_r2_values6
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE)
# для модели Пуассоновской регрессии 7
options(scipen = 999)
poisson_residuals7 <- residuals(mf_poiss_model7, type = "response")
mse_poisson_model7 <- mean(poisson_residuals7^2)
mse_poisson_model7
rmse_poisson_model7 <- sqrt(mse_poisson_model7)
rmse_poisson_model7
deviance_explained7 <- 1 - (mf_poiss_model7$deviance / mf_poiss_model7$null.deviance)
deviance_explained7
pseudo_r2_values7
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 8
options(scipen = 999)
poisson_residuals8 <- residuals(mf_poiss_model8, type = "response")
mse_poisson_model8 <- mean(poisson_residuals8^2)
mse_poisson_model8
rmse_poisson_model8 <- sqrt(mse_poisson_model8)
rmse_poisson_model8
deviance_explained8 <- 1 - (mf_poiss_model8$deviance / mf_poiss_model8$null.deviance)
deviance_explained8
pseudo_r2_values8
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 9
options(scipen = 999)
poisson_residuals9 <- residuals(mf_poiss_model9, type = "response")
mse_poisson_model9 <- mean(poisson_residuals9^2)
mse_poisson_model9
rmse_poisson_model9 <- sqrt(mse_poisson_model9)
rmse_poisson_model9
deviance_explained9 <- 1 - (mf_poiss_model9$deviance / mf_poiss_model9$null.deviance)
deviance_explained9
pseudo_r2_values9
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 10
options(scipen = 999)
poisson_residuals10 <- residuals(mf_poiss_model10, type = "response")
mse_poisson_model10 <- mean(poisson_residuals10^2)
mse_poisson_model10
rmse_poisson_model10 <- sqrt(mse_poisson_model10)
rmse_poisson_model10
deviance_explained10 <- 1 - (mf_poiss_model10$deviance / mf_poiss_model10$null.deviance)
deviance_explained10
pseudo_r2_values10
```
```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели Пуассоновской регрессии 11
options(scipen = 999)
poisson_residuals11 <- residuals(mf_poiss_model11, type = "response")
mse_poisson_model11 <- mean(poisson_residuals11^2)
mse_poisson_model11
rmse_poisson_model11 <- sqrt(mse_poisson_model11)
rmse_poisson_model11
deviance_explained11 <- 1 - (mf_poiss_model11$deviance / mf_poiss_model11$null.deviance)
deviance_explained11
pseudo_r2_values11
```


## Конструирование множественной модели отрицательного биномиального распределения
### Применение множественной модели отрицательного биномиального распределения
Множественная модель отрицательной биномиальной регрессии применена для тех же макроэкономических переменных, выбранных для множественной модели Пуассоновской регрессии.

#### Формулировка гипотез:
Нулевая гипотеза (H0): Макроэкономические переменные не имеют связи с потерями от операционного риска.

Альтернативная гипотеза (Ha): Макроэкономические переменные имеют связь с потерями от операционного риска.

Установка уровня альфа = 0.1 (уровень доверия 90%).

Установка приемлемого псевдо R^2 (коэффициент детерминации) = 0.35 (35%).

```{r warning=FALSE}
# Конструкция множественной модели Пуассона
nb_model <- glm.nb(Total_freq ~ rurkzt + Rincpop_q_y + GDD_R_y, 
                 data = freq_final_df) 
summary(nb_model)
pseudo_r2_values_nb <- pR2(nb_model)
pseudo_r2_values_nb
```
**Обнаружения:** R^2 МакФаддена, равный 0.0719, указывает на то, что модель объясняет примерно 7.2% дисперсии по сравнению с нулевой моделью, что свидетельствует о некотором улучшении, но также подчеркивает возможность дальнейшего совершенствования. Однако r^2ML (псевдо-R^2 максимального правдоподобия) и r^2CU (псевдо-R^2 Крэгга-Улера/Нагелькерке), равные 0.4528, указывают на более значительную объяснительную способность, показывая, что модель объясняет примерно 45.3% вариации частоты потерь от операционного риска с использованием выбранных макроэкономических переменных. Эти последние метрики предлагают более оптимистичную оценку общей подгонки модели. Нулевая гипотеза отвергается, а альтернативная гипотеза принимается; результаты указывают на то, что макроэкономические переменные значительно влияют на частоту (количество) потерь от операционного риска.

```{r}
# Проверка средней квадратичной ошибки (MSE) и корня из средней квадратичной ошибки (RMSE) 
# для модели отрицательной биномиальной регрессии
options(scipen = 999)
nb_model_residual <- residuals(nb_model, type = "response")
mse_nb_model <- mean(nb_model_residual^2)
mse_nb_model
rmse_nb_model <- sqrt(mse_nb_model)
rmse_nb_model
deviance_explained <- 1 - (nb_model$deviance / nb_model$null.deviance)
deviance_explained
pseudo_r2_values_nb
```
### Сравнительный анализ производительности моделей

```{r}
# Создание датафрейма с результатами модели
poisson_nb_models <- data.frame(
  Model = c("Множественная модель Пуассона 1", "Множественная модель Пуассона 2", 
            "Множественная модель Пуассона 3", "Множественная модель Пуассона 4", 
            "Множественная модель Пуассона 5", "Множественная модель Пуассона 6", 
            "Множественная модель Пуассона 7", "Множественная модель Пуассона 8",
            "Множественная модель Пуассона 9", "Множественная модель Пуассона 10",
            "Множественная модель Пуассона 11", "Модель отрицательного биномиального распределения"),
  MSE = c(171.996, 171.996, 173.690, 162.550, 173.382, 160.246, 129.036, 
          178.682, 182.303, 162.554, 173.631, 129.0357),
  RMSE = c(13.115, 13.115, 13.179, 12.750, 13.167, 12.659, 11.359, 13.367, 
           13.502, 12.750, 13.177, 11.359),
  Deviance = c(0.3185, 0.3185, 0.3127, 0.3553, 0.3129, 0.3642, 0.4928,
               0.2916, 0.2773, 0.3557, 0.3117, 0.4928),
  Log_Likelihood = c(-96.038, -96.038, -96.128, -95.468, -96.125, 
                     -95.331, -93.337, -96.454, -96.676, -95.462, -96.143, -93.337),
  McFadden_R2 = c(0.04888, 0.04888, 0.04798, 0.05452, 0.04802, 0.05588, 
                  0.07562, 0.04475, 0.04256, 0.05458, 0.04784, 0.07194),
  R2ML = c(0.3372, 0.3372, 0.3322, 0.3679, 0.3324, 0.3751, 0.4708, 
           0.3138, 0.3010, 0.3683, 0.3314, 0.4528),
  R2CU = c(0.3373, 0.3373, 0.3323, 0.3680, 0.3324, 0.3752, 
           0.4709, 0.3138, 0.3011, 0.3683, 0.3314, 0.4529)
)

kable(poisson_nb_models, format = "markdown", digits = 5, 
      caption = "Метрики производительности моделей Пуассона и отрицательного биномиального распределения")
```
### Промежуточный вывод
На основе оценки ключевых метрик (MSE, RMSE, девианса, псевдо R^2 и логарифма правдоподобия) модель Пуассоновской регрессии 7 выделяется как лучшая модель для прогнозирования частоты потерь от операционного риска. Основные моменты, подтверждающие этот выбор, включают:

Наименьшие значения MSE (129.0357) и RMSE (11.35939): Эти значения указывают на наиболее точные прогнозы среди всех протестированных моделей.  
Наименьший девианс (0.4928244): Указывает на то, что модель хорошо соответствует данным.  
Наивысшие значения псевдо R^2:  
McFadden’s R^2 = 0.0756,  
r^2ML = 0.4708,  
r^2CU = 0.4709. Эти значения показывают, что модель объясняет наибольшую дисперсию данных по сравнению с другими моделями.  
Логарифм правдоподобия (-93.3372): Более высокий (менее отрицательный), чем у других моделей, что дополнительно подтверждает хорошую подгонку модели Пуассона 7.  
Модель включает следующие значимые макроэкономические переменные:  

rurkzt (обменный курс RUB KZT),  
GDD_R_y (реальная валовая добавленная стоимость, преобразованная),  
Rincpop_q_y (реальный средний месячный доход населения, преобразованный). Значения p-value для всех переменных ниже альфа = 0.1, что указывает на статистическую значимость.  
Сравнение с моделью отрицательного биномиального распределения:  
Хотя модель отрицательного биномиального распределения имеет наименьшие MSE и RMSE (129.036 и 11.359), ее производительность почти идентична модели Пуассона 7:  

Обе модели имеют одинаковый логарифм правдоподобия (-93.337), что указывает на схожую подгонку с точки зрения правдоподобия.  
Девианс (0.4928) одинаков для обеих моделей.  
Псевдо R^2: Модель отрицательного биномиального распределения имеет немного меньшие значения:  
McFadden’s R^2 = 0.07194 (против 0.0756 для модели Пуассона 7),  
r^2ML = 0.4528 и r^2CU = 0.4529 (против 0.4708 и 0.4709 для модели Пуассона 7).  
Хотя модель отрицательного биномиального распределения более устойчива к обработке сверхдисперсии, модель Пуассона 7 все еще демонстрирует сопоставимую производительность с лишь незначительными различиями в метриках. Важно отметить, что модель Пуассона 7 демонстрирует недо-дисперсию (значение дисперсии 0.7858), что может указывать на потенциальное переобучение или избыток нулей в данных, но не кажется необходимым переход к более сложному подходу отрицательного биномиального распределения.  

**Заключение:**
Учитывая сопоставимую производительность моделей Пуассона и отрицательного биномиального распределения, модель Пуассоновской регрессии 7 выбирается как лучшая модель. Она сбалансированно сочетает точность прогнозирования с объяснительной силой и проще в интерпретации. Она успешно включает ключевые макроэкономические переменные (rurkzt, GDD_R_y и Rincpop_q_y), которые являются статистически значимыми и весьма релевантными для прогнозирования частоты потерь от операционного риска. Рекомендуется дальнейшее исследование недо-дисперсии в модели Пуассона 7, но в целом она является наиболее подходящим выбором для прогнозирования с учетом того, что предположение о линейности не полностью выполнено.  

## Прогнозирование сценариев регрессионной модели (стресс-тестирование операционного риска)  

### Прогнозирование объемов (воздействия/тяжести) потерь от операционного риска  

#### Создание корреляционной матрицы

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация корреляционной матрицы Кендалла с помощью корреляционного графика
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr1, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45,
         
)
```
**Обнаружения:** Анализ корреляций между независимыми переменными и зависимой переменной, потерями от операционного риска (OR_Loss_in_assets), дает следующие выводы:

Отрицательные корреляции с OR_Loss_in_assets:  
Все независимые переменные демонстрируют отрицательную корреляцию с OR_Loss_in_assets. Это предполагает, что по мере увеличения значений независимых переменных (таких как макроэкономические показатели) потери от операционного риска имеют тенденцию к снижению, и наоборот. Это указывает на то, что более сильные макроэкономические условия могут уменьшать потери от операционного риска, возможно, благодаря улучшению финансовой стабильности, управления рисками или общей экономической устойчивости.

Взаимосвязи между независимыми переменными:  
GDD_Trn_R_y (тренд роста ВВП) и GDD_Inf_R_y (инфляция ВВП) имеют умеренную положительную корреляцию (0.512). Это указывает на то, что тренды роста ВВП и инфляция имеют тенденцию двигаться в одном направлении — когда одно увеличивается, другое также склонно расти. Это логично, поскольку сильный экономический рост может привести к более высокой инфляции или наоборот.  
GDD_Inf_R_y и Rincpop_q_y (реальный доход на душу населения) показывают сильную положительную корреляцию (0.664). Это говорит о том, что при росте инфляции реальный доход на душу населения также имеет тенденцию к увеличению. Эта связь может отражать влияние инфляционного давления на распределение доходов или экономическую динамику, что может быть связано с более высокими операционными затратами и факторами риска.  
GDD_Trn_R_y и Rincpop_q_y имеют слабую положительную корреляцию (0.313), что предполагает, что хотя между ростом ВВП и ростом реального дохода есть некоторое соответствие, эта связь не является сильной.

Последствия отрицательных корреляций с потерями от операционного риска:  
Отрицательные корреляции между независимыми переменными и OR_Loss_in_assets предполагают, что лучшие макроэкономические условия — характеризующиеся более высоким ростом ВВП, инфляцией и реальным доходом на душу населения — обычно приводят к меньшим потерям от операционного риска. Это можно объяснить более стабильной деловой средой и улучшенными финансовыми показателями в периоды экономического роста.

#### Определение исторических минимумов и максимумов независимых и зависимых переменных

```{r}
# Анализ исторических минимальных значений переменной "GDD_Trn_R_y"
GDD_Trn_R_y_min <- min(final_df$GDD_Trn_R_y, na.rm = TRUE)
cat("Исторический минимум GDD_Trn_R_y составляет", GDD_Trn_R_y_min)
```
```{r}
# Анализ исторических максимальных значений переменной "GDD_Trn_R_y" 
GDD_Trn_R_y_max <- max(final_df$GDD_Trn_R_y, na.rm = TRUE)
cat("Исторический максимум GDD_Trn_R_y составляет", GDD_Trn_R_y_max, "\n")
```
```{r}
# Анализ исторических минимальных значений переменной "GDD_Inf_R_y"
GDD_Inf_R_y_min <- min(final_df$GDD_Inf_R_y, na.rm = TRUE)
cat("Исторический минимум GDD_Inf_R_y составляет", GDD_Inf_R_y_min)
```
```{r}
# Анализ исторических максимальных значений переменной "GDD_Inf_R_y"
GDD_Inf_R_y_max <- max(final_df$GDD_Inf_R_y, na.rm = TRUE)
cat("Исторический максимум GDD_Inf_R_y составляет", GDD_Inf_R_y_max, "\n")
```
```{r}
# Анализ исторических минимальных значений переменной "Rincpop_q_y"
Rincpop_q_y_min <- min(final_df$Rincpop_q_y, na.rm = TRUE)
cat("Исторический минимум Rincpop_q_y составляет", Rincpop_q_y_min)
```
```{r}
# Анализ исторических максимальных значений переменной "Rincpop_q_y"
Rincpop_q_y_max <- max(final_df$Rincpop_q_y, na.rm = TRUE)
cat("Исторический максимум Rincpop_q_y составляет", Rincpop_q_y_max, "\n")
```

### Определение сценариев

```{r}
banking_stats$Value <- as.numeric(as.character(banking_stats$Value))
mean_bank_stats <- mean(banking_stats$Value, na.rm = TRUE)
stdev_bank_stats <- sd(banking_stats$Value, na.rm = TRUE)
cat("Среднее значение активов:", 
    mean_bank_stats, "\n")
cat("Стандартное отклонение активов:", 
    stdev_bank_stats, "\n")

```


```{r}
# Финансовые данные по общим активам за 4 квартала 2017 года 
# для прогнозирования
# Позитивный сценарий
total_assets_2017_Q1p <- 24255600000
total_assets_2017_Q2p <- 25993960000
total_assets_2017_Q3p <- 27856910000
total_assets_2017_Q4p <- 29853370000

# Негативный сценарий
total_assets_2017_Q1n <- 22356410000
total_assets_2017_Q2n <- 22082730000
total_assets_2017_Q3n <- 21812390000
total_assets_2017_Q4n <- 21545360000

```
**Обнаружения:** Прогнозируемые значения общих активов на следующие 4 квартала были рассчитаны в рамках позитивного и негативного сценариев в абсолютных величинах. Эти значения основаны на простой проекции на основе роста, с учетом исторической волатильности.
Позитивный сценарий: Темп роста = историческое среднее значение + 1 стандартное отклонение.
Негативный сценарий: Темп роста = историческое среднее значение - 1 стандартное отклонение.



```{r}
# Позитивный сценарий
GDD_Trn_R_y_2017_Q1p <- 5.500
GDD_Trn_R_y_2017_Q2p <- 6.500
GDD_Trn_R_y_2017_Q3p <- 7.200
GDD_Trn_R_y_2017_Q4p <- 7.800

GDD_Inf_R_y_2017_Q1p <- 7.100
GDD_Inf_R_y_2017_Q2p <- 10.000
GDD_Inf_R_y_2017_Q3p <- 15.000
GDD_Inf_R_y_2017_Q4p <- 18.000

Rincpop_q_y_2017_Q1p <- 40.000
Rincpop_q_y_2017_Q2p <- 60.000
Rincpop_q_y_2017_Q3p <- 90.000
Rincpop_q_y_2017_Q4p <- 110.000
```

```{r}
# Негативный сценарий
GDD_Trn_R_y_2017_Q1n <- 4.500
GDD_Trn_R_y_2017_Q2n <- 4.000
GDD_Trn_R_y_2017_Q3n <- 3.500
GDD_Trn_R_y_2017_Q4n <- 3.200

GDD_Inf_R_y_2017_Q1n <- 3.000
GDD_Inf_R_y_2017_Q2n <- 1.500
GDD_Inf_R_y_2017_Q3n <- 1.000
GDD_Inf_R_y_2017_Q4n <- -0.500

Rincpop_q_y_2017_Q1n <- -0.000
Rincpop_q_y_2017_Q2n <- -5.000
Rincpop_q_y_2017_Q3n <- -10.000
Rincpop_q_y_2017_Q4n <- -15.000
```


### Прогнозирование сумм (влияния/тяжести) убытков от операционного риска с помощью модели множественной линейной регрессии
```{r}
# Резюме модели множественной линейной регрессии
summary(mfl_model_or)

```

#### Позитивный сценарий

```{r}
# Прогнозирование доли операционных убытков 
# в общих активах (позитивный сценарий)
intercept <- coef(mfl_model_or)["(Intercept)"]
GDD_Trn_R_y_coef <- coef(mfl_model_or)["GDD_Trn_R_y"]
GDD_Inf_R_y_coef <- coef(mfl_model_or)["GDD_Inf_R_y"] 
Rincpop_q_y_coef <- coef(mfl_model_or)["Rincpop_q_y"]

# Позитивный сценарий
GDD_Trn_R_y_2017_Q1p <- 5.500
GDD_Inf_R_y_2017_Q1p <- 7.100  
Rincpop_q_y_2017_Q1p <- 40.000

# Прогнозирование доли операционных убытков
# в общих активах (позитивный сценарий)
y_hat2017_Q1p <- intercept + GDD_Trn_R_y_coef * GDD_Trn_R_y_2017_Q1p +
  GDD_Inf_R_y_coef * GDD_Inf_R_y_2017_Q1p +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q1p

# Вывод прогнозируемого значения  
cat("Доля операционных убытков (позитивный сценарий) на Q1-2017:",
    y_hat2017_Q1p, "\n")

```

```{r}
# Прогнозирование доли операционных убытков
# в общих активах (позитивный сценарий)
intercept <- coef(mfl_model_or)["(Intercept)"]
GDD_Trn_R_y_coef <- coef(mfl_model_or)["GDD_Trn_R_y"]
GDD_Inf_R_y_coef <- coef(mfl_model_or)["GDD_Inf_R_y"] 
Rincpop_q_y_coef <- coef(mfl_model_or)["Rincpop_q_y"]

# Позитивный сценарий
GDD_Trn_R_y_2017_Q2p <- 6.500
GDD_Inf_R_y_2017_Q2p <- 10.000
Rincpop_q_y_2017_Q2p <- 60.000

# Прогнозирование доли операционных убытков
# в общих активах (позитивный сценарий)
y_hat2017_Q2p <- intercept + GDD_Trn_R_y_coef * GDD_Trn_R_y_2017_Q2p +
  GDD_Inf_R_y_coef * GDD_Inf_R_y_2017_Q2p +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q2p

# Вывод прогнозируемого значения
cat("Доля операционных убытков (позитивный сценарий) на Q2-2017:", 
    y_hat2017_Q2p, "\n")

```
```{r}
# Прогнозирование доли операционных убытков 
# в общих активах (позитивный сценарий)
intercept <- coef(mfl_model_or)["(Intercept)"]
GDD_Trn_R_y_coef <- coef(mfl_model_or)["GDD_Trn_R_y"]
GDD_Inf_R_y_coef <- coef(mfl_model_or)["GDD_Inf_R_y"] 
Rincpop_q_y_coef <- coef(mfl_model_or)["Rincpop_q_y"]

# Позитивный сценарий
GDD_Trn_R_y_2017_Q3p <- 7.200
GDD_Inf_R_y_2017_Q3p <- 15.000 
Rincpop_q_y_2017_Q3p <- 90.000

# Прогнозирование доли операционных убытков
y_hat2017_Q3p <- intercept + 
  GDD_Trn_R_y_coef * GDD_Trn_R_y_2017_Q3p +
  GDD_Inf_R_y_coef * GDD_Inf_R_y_2017_Q3p +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q3p

# Вывод результата
cat("Доля операционных убытков (позитивный сценарий) на Q3-2017:", 
    y_hat2017_Q3p, "\n")
```


```{r}
# Прогнозирование доли убытков от операционного риска 
# в общих активах (Положительный сценарий)
intercept <- coef(mfl_model_or)["(Intercept)"]
GDD_Trn_R_y_coef <- coef(mfl_model_or)["GDD_Trn_R_y"]
GDD_Inf_R_y_coef <- coef(mfl_model_or)["GDD_Inf_R_y"]
Rincpop_q_y_coef <- coef(mfl_model_or)["Rincpop_q_y"]

# Положительный сценарий
GDD_Trn_R_y_2017_Q4p <- 7.800
GDD_Inf_R_y_2017_Q4p <- 18.000
Rincpop_q_y_2017_Q4p <- 110.000

# Прогнозирование доли убытков от операционного риска 
# в общих активах (Положительный сценарий)
y_hat2017_Q4p <- intercept + GDD_Trn_R_y_coef * GDD_Trn_R_y_2017_Q4p + 
  GDD_Inf_R_y_coef * GDD_Inf_R_y_2017_Q4p +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q4p

# Вывод прогноза
cat("Доля убытков от операционного риска (позитивный сценарий) для Q4-2017:", 
    y_hat2017_Q4p, "\n")

```

```{r}
# Прогнозирование суммы убытков от операционного риска (позитивный сценарий)

# Финансовые данные по общим активам за следующие 4 квартала 2017 года
# для прогноза
# позитивный сценарий
total_assets_2017_Q1p <- 24255600000
total_assets_2017_Q2p <- 25993960000
total_assets_2017_Q3p <- 27856910000
total_assets_2017_Q4p <- 29853370000

# Прогнозируемая доля убытков от операционного риска 
# в общих активах (позитивный сценарий) для Q1-2017:
y_hat2017_Q1p
y_hat2017_Q2p
y_hat2017_Q3p
y_hat2017_Q4p

# Прогнозирование суммы убытков от операционного риска (позитивный сценарий)
or_losses_2017_Q1p <- total_assets_2017_Q1p * y_hat2017_Q1p
or_losses_2017_Q2p <- total_assets_2017_Q2p * y_hat2017_Q2p
or_losses_2017_Q3p <- total_assets_2017_Q3p * y_hat2017_Q3p
or_losses_2017_Q4p <- total_assets_2017_Q4p * y_hat2017_Q4p

# Вывод прогноза
cat("Сумма убытков от операционного риска (позитивный  сценарий) для Q1-2017:", 
    or_losses_2017_Q1p, "\n")

cat("Сумма убытков от операционного риска (позитивный сценарий) для Q2-2017:", 
    or_losses_2017_Q2p, "\n")

cat("Сумма убытков от операционного риска (позитивный сценарий) для Q3-2017:", 
    or_losses_2017_Q3p, "\n")

cat("Сумма убытков от операционного риска (позитивный сценарий) для Q4-2017:", 
    or_losses_2017_Q4p, "\n")

```

#### Негативный сценарий

```{r}
# Прогнозирование доли убытков от операционного риска 
# в общих активах (негативный сценарий)
intercept <- coef(mfl_model_or)["(Intercept)"]
GDD_Trn_R_y_coef <- coef(mfl_model_or)["GDD_Trn_R_y"]
GDD_Inf_R_y_coef <- coef(mfl_model_or)["GDD_Inf_R_y"]
Rincpop_q_y_coef <- coef(mfl_model_or)["Rincpop_q_y"]

# негативный сценарий
GDD_Trn_R_y_2017_Q1n <- 4.500

GDD_Inf_R_y_2017_Q1n <- 3.000

Rincpop_q_y_2017_Q1n <- -0.000

# Прогнозирование доли убытков от операционного риска 
# в общих активах (негативный сценарий)
y_hat2017_Q1n <- intercept + GDD_Trn_R_y_coef * GDD_Trn_R_y_2017_Q1n + 
  GDD_Inf_R_y_coef * GDD_Inf_R_y_2017_Q1n +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q1n

# Вывод прогноза
cat("Доля убытков от операционного риска (негативный сценарий) для Q1-2017:", 
    y_hat2017_Q1n, "\n")


```
```{r}
# Прогнозирование доли убытков от операционного риска 
# в общих активах (негативный сценарий)
intercept <- coef(mfl_model_or)["(Intercept)"]
GDD_Trn_R_y_coef <- coef(mfl_model_or)["GDD_Trn_R_y"]
GDD_Inf_R_y_coef <- coef(mfl_model_or)["GDD_Inf_R_y"]
Rincpop_q_y_coef <- coef(mfl_model_or)["Rincpop_q_y"]

# негативный сценарий для Q2-2017
GDD_Trn_R_y_2017_Q2n <- 4.000

GDD_Inf_R_y_2017_Q2n <- 1.500

Rincpop_q_y_2017_Q2n <- -5.000

# Прогнозирование доли убытков от операционного риска 
# в общих активах (негативный сценарий для Q2-2017)
y_hat2017_Q2n <- intercept + GDD_Trn_R_y_coef * GDD_Trn_R_y_2017_Q2n + 
  GDD_Inf_R_y_coef * GDD_Inf_R_y_2017_Q2n +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q2n

# Вывод прогноза
cat("Доля убытков от операционного риска (негативный сценарий) для Q2-2017:", 
    y_hat2017_Q2n, "\n")

```
```{r}
# Прогнозирование доли убытков от операционного риска 
# в общих активах (негативный сценарий для Q3-2017)
intercept <- coef(mfl_model_or)["(Intercept)"]
GDD_Trn_R_y_coef <- coef(mfl_model_or)["GDD_Trn_R_y"]
GDD_Inf_R_y_coef <- coef(mfl_model_or)["GDD_Inf_R_y"]
Rincpop_q_y_coef <- coef(mfl_model_or)["Rincpop_q_y"]

# негативный сценарий для Q3-2017
GDD_Trn_R_y_2017_Q3n <- 3.500
GDD_Inf_R_y_2017_Q3n <- 1.000
Rincpop_q_y_2017_Q3n <- -10.000

# Прогнозирование доли убытков от операционного риска 
# в общих активах (негативный сценарий для Q3-2017)
y_hat2017_Q3n <- intercept + GDD_Trn_R_y_coef * GDD_Trn_R_y_2017_Q3n + 
  GDD_Inf_R_y_coef * GDD_Inf_R_y_2017_Q3n +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q3n

# Вывод прогноза для Q3-2017
cat("Доля убытков от операционного риска (негативный сценарий) для Q3-2017:", 
    y_hat2017_Q3n, "\n")


# Прогнозирование доли убытков от операционного риска 
# в общих активах (негативный сценарий для Q4-2017)
intercept <- coef(mfl_model_or)["(Intercept)"]
GDD_Trn_R_y_coef <- coef(mfl_model_or)["GDD_Trn_R_y"]
GDD_Inf_R_y_coef <- coef(mfl_model_or)["GDD_Inf_R_y"]
Rincpop_q_y_coef <- coef(mfl_model_or)["Rincpop_q_y"]

# негативный сценарий для Q4-2017
GDD_Trn_R_y_2017_Q4n <- 3.200
GDD_Inf_R_y_2017_Q4n <- -0.500
Rincpop_q_y_2017_Q4n <- -15.000

# Прогнозирование доли убытков от операционного риска 
# в общих активах (негативный сценарий для Q4-2017)
y_hat2017_Q4n <- intercept + GDD_Trn_R_y_coef * GDD_Trn_R_y_2017_Q4n + 
  GDD_Inf_R_y_coef * GDD_Inf_R_y_2017_Q4n +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q4n

# Вывод прогноза для Q4-2017
cat("Доля убытков от операционного риска (негативный сценарий) для Q4-2017:", 
    y_hat2017_Q4n, "\n")

```
```{r}
# Прогнозирование суммы убытков операционного риска (Негативный сценарий)

# Финансовые данные о общих активах за следующие 4 квартала 2017 года
# для прогнозирования
# Негативный сценарий
total_assets_2017_Q1n <- 22356410000
total_assets_2017_Q2n <- 22082730000
total_assets_2017_Q3n <- 21812390000
total_assets_2017_Q4n <- 21545360000


# Прогнозируемая доля убытков операционного риска (Негативный сценарий) для Q1-2017:
y_hat2017_Q1n
y_hat2017_Q2n
y_hat2017_Q3n
y_hat2017_Q4n

# Прогнозирование суммы убытков операционного риска (Негативный сценарий)
or_losses_2017_Q1n <- total_assets_2017_Q1n * y_hat2017_Q1n
or_losses_2017_Q2n <- total_assets_2017_Q2n * y_hat2017_Q2n
or_losses_2017_Q3n <- total_assets_2017_Q3n * y_hat2017_Q3n
or_losses_2017_Q4n <- total_assets_2017_Q4n * y_hat2017_Q4n

# Вывод прогнозируемого значения
cat("Сумма убытков операционного риска (Негативный сценарий) для Q1-2017:", 
    or_losses_2017_Q1n, "\n")

cat("Сумма убытков операционного риска (Негативный сценарий) для Q2-2017:", 
    or_losses_2017_Q2n, "\n")

cat("Сумма убытков операционного риска (Негативный сценарий) для Q3-2017:", 
    or_losses_2017_Q3n, "\n")

cat("Сумма убытков операционного риска (Негативный сценарий) для Q4-2017:", 
    or_losses_2017_Q4n, "\n")

```

#### Прогнозируемые значения суммы (влияния/тяжести) убытков операционного риска (Множественная линейная регрессия):


```{r}
# Вывод прогнозируемых значений
cat("Сумма убытков операционного риска (Позитивный сценарий) для Q1-2017:", 
    or_losses_2017_Q1p, "\n")

cat("Сумма убытков операционного риска (Позитивный сценарий) для Q2-2017:", 
    or_losses_2017_Q2p, "\n")

cat("Сумма убытков операционного риска (Позитивныйсценарий) для Q3-2017:", 
    or_losses_2017_Q3p, "\n")

cat("Сумма убытков операционного риска (Позитивный сценарий) для Q4-2017:", 
    or_losses_2017_Q4p, "\n")

# Вывод прогнозируемых значений
cat("Сумма убытков операционного риска (Негативный сценарий) для Q1-2017:", 
    or_losses_2017_Q1n, "\n")

cat("Сумма убытков операционного риска (Негативный сценарий) для Q2-2017:", 
    or_losses_2017_Q2n, "\n")

cat("Сумма убытков операционного риска (Негативный сценарий) для Q3-2017:", 
    or_losses_2017_Q3n, "\n")

cat("Сумма убытков операционного риска (Отрицательный сценарий) для Q4-2017:", 
    or_losses_2017_Q4n, "\n")

```
### Прогнозирование сумм (влияние/серьезность) убытков операционного риска с использованием модели обобщенной аддитивной регрессии (GAM)

```{r}
#Резюме модели обобщенной аддитивной регрессии (GAM)
summary(gam_model_or)
```
#### Негативный сценарий

```{r}
# Создание датафрейма для позитивного сценария
new_data_positive <- data.frame(
  GDD_Trn_R_y = c(2.500, 2.800, 3.100, 3.500),
  GDD_Inf_R_y = c(0.500, 0.800, 1.200, 1.500),
  Rincpop_q_y = c(130.200, 130.500, 131.100, 132.600)
)

# Вывод датафрейма 
print(new_data_positive)
```

```{r}
# Создание датафрейма для негативного сценария
new_data_negative <- data.frame(
  GDD_Trn_R_y = c(1.500, 1.200, 1.000, 0.800),
  GDD_Inf_R_y = c(0.100, 0.060, 0.020, -0.100),
  Rincpop_q_y = c(-20.000, -18.500, -16.000, -12.000)
)

# Вывод датафрейма  new_data_negative
print(new_data_negative)
```

```{r}
# Прогнозирование с использованием Множественной Общей Аддитивной Модели (GAM)
# для позитивного сценария
predictions_positive <- predict(gam_model_or, 
                                newdata = new_data_positive)

# Вывод прогнозов
print(predictions_positive)
```
```{r}
# Прогнозирование суммы убытков от операционного риска с использованием 
# Множественной Общей Аддитивной Модели (GAM) (Позитивный сценарий)

# Финансовые данные по общим активам за следующие 
# 4 квартала 2017 года для прогнозирования
# Позитивный сценарий
total_assets_2017_Q1p <- 24255600000
total_assets_2017_Q2p <- 25993960000
total_assets_2017_Q3p <- 27856910000
total_assets_2017_Q4p <- 29853370000

# Прогнозируемая доля убытков от операционного риска
# (Позитивный сценарий) на 2017 год:
y_hat2017_gam_Q1p <- 0.0010611856
y_hat2017_gam_Q2p <- 0.0010288484
y_hat2017_gam_Q3p <- 0.0009969525
y_hat2017_gam_Q4p <- 0.0009378848

# Прогнозирование суммы убытков от операционного риска (Позитивный сценарий)
or_losses_gam_2017_Q1p <- total_assets_2017_Q1p * y_hat2017_gam_Q1p
or_losses_gam_2017_Q2p <- total_assets_2017_Q2p * y_hat2017_gam_Q2p
or_losses_gam_2017_Q3p <- total_assets_2017_Q3p * y_hat2017_gam_Q3p
or_losses_gam_2017_Q4p <- total_assets_2017_Q4p * y_hat2017_gam_Q4p

# Печать прогнозируемых значений
cat("Сумма убытков от операционного риска с использованием Множественной (GAM) (Позитивный сценарий) для Q1-2017:", 
    or_losses_gam_2017_Q1p, "\n")

cat("Сумма убытков от операционного риска с использованием Множественной (GAM) (Позитивный сценарий) для Q2-2017:", 
    or_losses_gam_2017_Q2p, "\n")

cat("Сумма убытков от операционного риска с использованием Множественной (GAM) (Позитивный сценарий) для Q3-2017:", 
    or_losses_gam_2017_Q3p, "\n")
 
cat("Сумма убытков от операционного риска с использованием Множественной (GAM) (Позитивный сценарий) для Q4-2017:", 
    or_losses_gam_2017_Q4p, "\n")

```
```{r}
# Прогнозирование с использованием Множественной Общей Аддитивной Модели (GAM)
# для Негативного сценария
predictions_negative <- predict(gam_model_or, 
                                newdata = new_data_negative)

# Печать прогнозов
print(predictions_negative)

```

```{r}
# Прогнозирование суммы убытков от операционного риска (Негативный сценарий)

# Финансовые данные по общим активам за следующие 4 квартала 2017 года
# для прогнозирования
# Негативный сценарий
total_assets_2017_Q1n <- 22356410000
total_assets_2017_Q2n <- 22082730000
total_assets_2017_Q3n <- 21812390000
total_assets_2017_Q4n <- 21545360000

# Прогнозируемая доля убытков от операционного риска (Негативный сценарий) на 2017 год:
y_hat2017_gam_Q1n <- 0.002844487
y_hat2017_gam_Q2n <- 0.002866672
y_hat2017_gam_Q3n <- 0.002864343
y_hat2017_gam_Q4n <- 0.002842384

# Прогнозирование суммы убытков от операционного риска с использованием 
# Множественной общей аддитивной модели (GAM) (Негативный сценарий)
or_losses_2017_gam_Q1n <- total_assets_2017_Q1n * y_hat2017_gam_Q1n
or_losses_2017_gam_Q2n <- total_assets_2017_Q2n * y_hat2017_gam_Q2n
or_losses_2017_gam_Q3n <- total_assets_2017_Q3n * y_hat2017_gam_Q3n
or_losses_2017_gam_Q4n <- total_assets_2017_Q4n * y_hat2017_gam_Q4n

# Печать прогнозируемых значений
cat("Сумма убытков от операционного риска с использованием Множественной (GAM) (Негативный сценарий) для Q1-2017:", 
    or_losses_2017_gam_Q1n, "\n")

cat("Сумма убытков от операционного риска с использованием Множественной (GAM) (Негативный сценарий) для Q2-2017:", 
    or_losses_2017_gam_Q2n, "\n")

cat("Сумма убытков от операционного риска с использованием Множественной (GAM) (Негативный сценарий) для Q3-2017:", 
    or_losses_2017_gam_Q3n, "\n")

cat("Сумма убытков от операционного риска с использованием Множественной (GAM) (Негативный сценарий) для Q4-2017:", 
    or_losses_2017_gam_Q4n, "\n")

```
#### Суммы (влияние/серьезность) прогнозируемых убытков от операционного риска (Множественная Общая Аддитивная Модель (GAM)):


```{r}
# Печать прогнозируемых значений
cat("Сумма убытков от операционного риска с (GAM) (Позитивный сценарий) для 1 квартала 2017 года:", 
    or_losses_gam_2017_Q1p, "\n")

cat("Сумма убытков от операционного риска с (GAM) (Позитивный сценарий) для 2 квартала 2017 года:", 
    or_losses_gam_2017_Q2p, "\n")

cat("Сумма убытков от операционного риска с (GAM) (Позитивный сценарий) для 3 квартала 2017 года:", 
    or_losses_gam_2017_Q3p, "\n")

cat("Сумма убытков от операционного риска с (GAM) (Позитивный сценарий) для 4 квартала 2017 года:", 
    or_losses_gam_2017_Q4p, "\n")

# Печать прогнозируемых значений
cat("Сумма убытков от операционного риска с (GAM) (Негативный сценарий) для 1 квартала 2017 года:", 
    or_losses_2017_gam_Q1n, "\n")

cat("Сумма убытков от операционного риска с (GAM) (Негативный сценарий) для 2 квартала 2017 года:", 
    or_losses_2017_gam_Q2n, "\n")

cat("Сумма убытков от операционного риска с (GAM) (Негативный сценарий) для 3 квартала 2017 года:", 
    or_losses_2017_gam_Q3n, "\n")

cat("Сумма убытков от операционного риска с (GAM) (Негативный сценарий) для 4 квартала 2017 года:", 
    or_losses_2017_gam_Q4n, "\n")

```

### Прогнозирование частоты (количества) операционных убытков
#### Множественная Регрессия Пуассона
#### Создание корреляционной матрицы

```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляции Кендалла с помощью корреляционного графика
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr11, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)

```
**Обнаружения:** Корреляции между независимыми переменными и зависимой переменной, Total_freq (частота операционных рисков), дают следующие выводы:

Отрицательная корреляция с Total_freq (частота операционных рисков):
Все независимые переменные демонстрируют отрицательные корреляции с Total_freq, что указывает на то, что с улучшением макроэкономических условий (таких как обменные курсы, рост ВВП и реальный доход на душу населения) частота событий операционных рисков, как правило, снижается. Эта обратная зависимость предполагает, что более сильные экономические показатели могут привести к более стабильной деловой среде с меньшим количеством событий операционных рисков. Это открытие поддерживает гипотезу, что улучшение макроэкономических условий может помочь снизить операционные риски.

Взаимосвязи между независимыми переменными:
rurkzt (обменный курс RUB/KZT) и GDD_R_y (темп роста ВВП) имеют слабую положительную корреляцию (0.287). Это означает, что когда обменный курс колеблется, темп роста ВВП слегка увеличивается, хотя связь не является сильной.
rurkzt и Rincpop_q_y (реальный доход на душу населения) имеют слабую положительную корреляцию (0.178), что означает, что обе переменные могут двигаться в одном направлении, но связь не является значимой.
GDD_R_y и Rincpop_q_y имеют сильную положительную корреляцию (0.664), что указывает на то, что с увеличением роста ВВП реальный доход на душу населения также значительно растет. Это ожидаемая экономическая зависимость, поскольку более высокий рост ВВП обычно ведет к увеличению уровня доходов в экономике.

Применение для частоты операционных рисков:
Отрицательные корреляции между независимыми переменными и Total_freq предполагают, что когда макроэкономические факторы, такие как обменные курсы, рост ВВП и уровни доходов, улучшаются, частота событий операционных рисков снижается. Это может отражать стабилизирующий эффект положительного экономического роста на бизнес-операции и управление рисками.
Необходимы дополнительные исследования, чтобы подтвердить, являются ли эти корреляции статистически значимыми, и лучше понять, являются ли эти взаимосвязи причинными или случайными.

```{r}
#Резюме Множественной Обобщенной Модели Пуассона:
summary(mf_poiss_model7)
```
#### Определение исторических минимумов и максимумов независимых и зависимых переменных

```{r}
# Просмотр исторических минимальных значений переменной "rurkzt"
rurkzt_min <- min(final_df$rurkzt, na.rm = TRUE)
cat("Исторический минимум для переменной rurkzt равен", rurkzt_min)

```
```{r}
# Просмотр исторических максимальных значений переменной "rurkzt"
rurkzt_max <- max(final_df$rurkzt, na.rm = TRUE)
cat("Исторический максимум для переменной rurkzt равен", rurkzt_max, "\n")

```
```{r}
# Просмотр исторических минимальных значений переменной "Rincpop_q_y"
Rincpop_q_y_min <- min(final_df$Rincpop_q_y, na.rm = TRUE)
cat("Исторический минимум для переменной Rincpop_q_y равен", Rincpop_q_y_min)

```
```{r}
# Просмотр исторических максимальных значений переменной "Rincpop_q_y"
Rincpop_q_y_max <- max(final_df$Rincpop_q_y, na.rm = TRUE)
cat("Исторический максимум для переменной Rincpop_q_y равен", Rincpop_q_y_max, "\n")

```
```{r}
# Просмотр исторических минимальных значений переменной "GDD_R_y"
GDD_R_y_min <- min(final_df$GDD_R_y, na.rm = TRUE)
cat("Исторический минимум для переменной GDD_R_y равен", GDD_R_y_min)

```
```{r}
# Просмотр исторических максимальных значений переменной "GDD_R_y"
GDD_R_y_max <- max(final_df$GDD_R_y, na.rm = TRUE)
cat("Исторический максимум для переменной GDD_R_y равен", GDD_R_y_max, "\n")

```

### Определение сценариев

```{r}
# Позитивный сценарий
rurkzt_y_2017_Q1p <- 10.000
rurkzt_y_2017_Q2p <- 8.000
rurkzt_y_2017_Q3p <- 6.000
rurkzt_y_2017_Q4p <- 4.000

GDD_R_y_2017_Q1p = 30.000
GDD_R_y_2017_Q2p = 50.000
GDD_R_y_2017_Q3p = 80.000
GDD_R_y_2017_Q4p = 100.000

Rincpop_q_y_2017_Q1p = 5.000
Rincpop_q_y_2017_Q2p = 6.500
Rincpop_q_y_2017_Q3p = 7.000
Rincpop_q_y_2017_Q4p = 7.400

```

```{r}
# Негативный сценарий
rurkzt_y_2017_Q1n <- 12.000
rurkzt_y_2017_Q2n <- 14.000
rurkzt_y_2017_Q3n <- 16.500
rurkzt_y_2017_Q4n <- 18.000

GDD_R_y_2017_Q1n <- -5.000
GDD_R_y_2017_Q2n <- -10.000
GDD_R_y_2017_Q3n <- -13.000
GDD_R_y_2017_Q4n <- -16.000

Rincpop_q_y_2017_Q1n <- 3.000
Rincpop_q_y_2017_Q2n <- 2.000
Rincpop_q_y_2017_Q3n <- 1.000
Rincpop_q_y_2017_Q4n <- 0.800

```

### Прогнозирование частоты (количества) потерь по операционному риску с моделью Пуассона

#### Позитивный сценарий


```{r}
# Прогнозирование частоты (число) потерь по операционному риску 
# (Позитивный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Позитивный сценарий
rurkzt_y_2017_Q1p <- 10.000

GDD_R_y_2017_Q1p = 40.000

Rincpop_q_y_2017_Q1p = 5.000

# Прогнозирование частоты (число) потерь по операционному риску 
# (Позитивный сценарий)
y_hat2017_freq_Q1p <- (intercept + rurkzt_y_2017_Q1p * rurkzt_coef +
  GDD_R_y_2017_Q1p *GDD_R_y_coef +
  Rincpop_q_y_coef * Rincpop_q_y_2017_Q1p)

# Прогнозирование количества (y) с использованием экспоненциальной функции
predicted_count2017_Q1p <- exp(y_hat2017_freq_Q1p)

# Вывод прогноза
cat("Частота потерь по операционному риску (Позитивный сценарий) для Q1-2017:", 
    predicted_count2017_Q1p, "\n")
```
```{r}
# Прогнозирование частоты (число) потерь по операционному риску 
# (Позитивный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Позитивный сценарий
rurkzt_y_2017_Q2p <- 8.000

GDD_R_y_2017_Q2p = 60.000

Rincpop_q_y_2017_Q2p = 6.500

# Прогнозирование частоты (число) потерь по операционному риску 
# (Позитивный сценарий)
y_hat2017_freq_Q2p <- (intercept + rurkzt_y_2017_Q2p * rurkzt_coef + 
                         GDD_R_y_2017_Q2p * GDD_R_y_coef + 
                         Rincpop_q_y_coef * Rincpop_q_y_2017_Q2p)

# Прогнозирование количества (y) с использованием экспоненциальной функции
predicted_count2017_Q2p <- exp(y_hat2017_freq_Q2p)

# Вывод прогноза
cat("Частота потерь по операционному риску (Позитивный сценарий) для Q2-2017:", 
    predicted_count2017_Q2p, "\n")
```
```{r}
# Прогнозирование частоты (число) потерь по операционному риску 
# (Позитивный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Позитивный сценарий
rurkzt_y_2017_Q3p <- 6.000

GDD_R_y_2017_Q3p = 80.000

Rincpop_q_y_2017_Q3p = 7.000

# Прогнозирование частоты (число) потерь по операционному риску 
# (Позитивный сценарий)
y_hat2017_freq_Q3p <- (intercept + rurkzt_y_2017_Q3p * rurkzt_coef + 
                         GDD_R_y_2017_Q3p * GDD_R_y_coef + 
                         Rincpop_q_y_coef * Rincpop_q_y_2017_Q3p)

# Прогнозирование количества (y) с использованием экспоненциальной функции
predicted_count2017_Q3p <- exp(y_hat2017_freq_Q3p)

# Вывод прогноза
cat("Частота потерь по операционному риску (Позитивный сценарий) для Q3-2017:",
    predicted_count2017_Q3p, "\n")
```

```{r}
# Прогнозирование частоты (число) потерь по операционному риску 
# (Позитивный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Позитивный сценарий
rurkzt_y_2017_Q4p <- 4.000

GDD_R_y_2017_Q4p = 100.000

Rincpop_q_y_2017_Q4p = 7.400

# Прогнозирование частоты (число) потерь по операционному риску 
# (Позитивный сценарий)
y_hat2017_freq_Q4p <- (intercept + rurkzt_y_2017_Q4p * rurkzt_coef + 
                         GDD_R_y_2017_Q4p * GDD_R_y_coef + 
                         Rincpop_q_y_coef * Rincpop_q_y_2017_Q4p)

# Прогнозирование количества (y) с использованием экспоненциальной функции
predicted_count2017_Q4p <- exp(y_hat2017_freq_Q4p)

# Вывод прогноза
cat("Частота потерь по операционному риску (Позитивный сценарий) для Q4-2017:", 
    predicted_count2017_Q4p, "\n")
```

#### Негативный сценарий

```{r}
# Прогнозирование частоты (число) потерь по операционному риску 
# (Негативный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Негативный сценарий
rurkzt_y_2017_Q1n <- 12.000

GDD_R_y_2017_Q1n <- -5.000

Rincpop_q_y_2017_Q1n <- 3.000

# Прогнозирование частоты (число) потерь по операционному риску 
# (Негативный сценарий)
y_hat2017_freq_Q1n <- (intercept + rurkzt_y_2017_Q1n * rurkzt_coef + 
                         GDD_R_y_2017_Q1n * GDD_R_y_coef + 
                         Rincpop_q_y_2017_Q1n * Rincpop_q_y_coef)

# Прогнозирование количества (y) с использованием экспоненциальной функции
predicted_count2017_Q1n <- exp(y_hat2017_freq_Q1n)

# Вывод прогноза
cat("Частота потерь по операционному риску (Негативный сценарий) для Q1-2017:", 
    predicted_count2017_Q1n, "\n")
```
```{r}
# Прогнозирование частоты (число) потерь по операционному риску 
# (Негативный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Негативный сценарий
rurkzt_y_2017_Q2n <- 14.000

GDD_R_y_2017_Q2n <- -10.000

Rincpop_q_y_2017_Q2n <- 2.000

# Прогнозирование частоты (число) потерь по операционному риску 
# (Негативный сценарий)
y_hat2017_freq_Q2n <- (intercept + rurkzt_y_2017_Q2n * rurkzt_coef + 
                         GDD_R_y_2017_Q2n * GDD_R_y_coef + 
                         Rincpop_q_y_2017_Q2n * Rincpop_q_y_coef)

# Прогнозирование количества (y) с использованием экспоненциальной функции
predicted_count2017_Q2n <- exp(y_hat2017_freq_Q2n)

# Вывод прогноза
cat("Частота потерь по операционному риску (Негативный сценарий) для Q2-2017:", 
    predicted_count2017_Q2n, "\n")
```
```{r}
# Прогнозирование частоты (число) потерь по операционному риску 
# (Негативный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Негативный сценарий
rurkzt_y_2017_Q2n <- 14.000

GDD_R_y_2017_Q2n <- -10.000

Rincpop_q_y_2017_Q2n <- 2.000

# Прогнозирование частоты (число) потерь по операционному риску 
# (Негативный сценарий)
y_hat2017_freq_Q2n <- (intercept + rurkzt_y_2017_Q2n * rurkzt_coef + 
                         GDD_R_y_2017_Q2n * GDD_R_y_coef + 
                         Rincpop_q_y_2017_Q2n * Rincpop_q_y_coef)

# Прогнозирование количества (y) с использованием экспоненциальной функции
predicted_count2017_Q2n <- exp(y_hat2017_freq_Q2n)

# Вывод прогноза
cat("Частота потерь по операционному риску (Негативный сценарий) для Q2-2017:", 
    predicted_count2017_Q2n, "\n")
```
```{r}
# (Негативный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Негативный сценарий
rurkzt_y_2017_Q3n <- 16.500
GDD_R_y_2017_Q3n <- -13.000
Rincpop_q_y_2017_Q3n <- 1.000

# Прогнозирование частоты (количества) убытков от операционного риска 
# (Негативный сценарий)
y_hat2017_freq_Q3n <- (intercept + rurkzt_y_2017_Q3n * rurkzt_coef + 
                         GDD_R_y_2017_Q3n * GDD_R_y_coef + 
                         Rincpop_q_y_2017_Q3n * Rincpop_q_y_coef)

# Прогноз количества убытков путём применения экспоненты
predicted_count2017_Q3n <- exp(y_hat2017_freq_Q3n)

# Печать прогнозируемого значения
cat("Частота убытков от операционного риска (негативный сценарий) за 3 квартал 2017 года:", 
    predicted_count2017_Q3n, "\n")
```


```{r}
# Прогнозирование частоты (число) потерь по операционному риску 
# (Негативный сценарий)
intercept <- coef(mf_poiss_model7)["(Intercept)"]
rurkzt_coef <- coef(mf_poiss_model7)["rurkzt"]
Rincpop_q_y_coef <- coef(mf_poiss_model7)["Rincpop_q_y"]
GDD_R_y_coef <- coef(mf_poiss_model7)["GDD_R_y"]

# Негативный сценарий
rurkzt_y_2017_Q4n <- 18.000

GDD_R_y_2017_Q4n <- -16.000

Rincpop_q_y_2017_Q4n <- 0.800

# Прогнозирование частоты (число) потерь по операционному риску 
# (Негативный сценарий)
y_hat2017_freq_Q4n <- (intercept + rurkzt_y_2017_Q4n * rurkzt_coef + 
                         GDD_R_y_2017_Q4n * GDD_R_y_coef + 
                         Rincpop_q_y_2017_Q4n * Rincpop_q_y_coef)

# Прогнозирование количества (y) с использованием экспоненциальной функции
predicted_count2017_Q4n <- exp(y_hat2017_freq_Q4n)

# Вывод прогноза
cat("Частота потерь по операционному риску (Негативный сценарий) для Q4-2017:", 
    predicted_count2017_Q4n, "\n")
```

#### Прогнозируемые значения частоты (число) операционных рисков (Множественная модель Пуассона):

```{r}
# Печать прогнозируемых значений
cat("Количество убытков от операционного риска (положительный сценарий) для I квартала 2017 года:", 
    predicted_count2017_Q1p, "\n")

cat("Количество убытков от операционного риска (положительный сценарий) для II квартала 2017 года:", 
    predicted_count2017_Q2p, "\n")

cat("Количество убытков от операционного риска (положительный сценарий) для III квартала 2017 года:", 
    predicted_count2017_Q3p, "\n")

cat("Количество убытков от операционного риска (положительный сценарий) для IV квартала 2017 года:", 
    predicted_count2017_Q4p, "\n")

# Печать прогнозируемых значений
cat("Количество убытков от операционного риска (отрицательный сценарий) для I квартала 2017 года:", 
    predicted_count2017_Q1n, "\n")

cat("Количество убытков от операционного риска (отрицательный сценарий) для II квартала 2017 года:", 
    predicted_count2017_Q2n, "\n")

cat("Количество убытков от операционного риска (отрицательный сценарий) для III квартала 2017 года:", 
    predicted_count2017_Q3n, "\n")

cat("Количество убытков от операционного риска (отрицательный сценарий) для IV квартала 2017 года:", 
    predicted_count2017_Q4n, "\n")
```


### Промежуточные выводы
### Таблица итогов стресс-тестирования модели регрессии

```{r, results='asis'}
# Создание сводной таблицы для результатов стресс-тестирования 
# с иерархическими и уникальными именами строк
stresstest_summary <- data.frame(
  Scenario = c("Позитивный сценарий", "2017 Q1 - Позитивный", 
               "2017 Q2 - Позитивный", "2017 Q3 - Позитивный", 
               "2017 Q4 - Позитивный", "Негативный сценарий", 
               "2017 Q1 - Негативный", "2017 Q2 - Негативный", 
               "2017 Q3 - Негативный", "2017 Q4 - Негативный"),
  `Сумма убытков от ОР модель (Линейная)` = c("KZT", 46228220, 43127346, 
                                                        39583768, 36771242, 
                                                        "KZT", 52068502, 52890742, 
                                                        54506252, 54684134),
  `Сумма убытков от ОР модель (GAM)` = c("KZT", 25739693, 26743844, 
                                                   27772016, 27999022, 
                                                   "KZT", 63592518, 63303944, 
                                                   62478167, 61240187),
  `Частота убытков от ОР модель (Пуассона)` = c("ШТ", 568, 999, 
                                                          1760, 3101, 
                                                          "ШТ", 162, 139, 
                                                          126, 115)
)

kable(stresstest_summary, format = "markdown", digits = 5, 
      caption = "Итоги стресс-тестирования модели регрессии для операционного риска")
```
### Промежуточные выводы
Стресс-тестирование операционного риска было проведено с использованием множественной линейной регрессии (MLR) и обобщенной аддитивной модели (GAM) для прогнозирования степени убытков. Статистический порог для R^2 (коэффициент детерминации) был установлен на уровне 0,35 (35%), а уровень альфа — 0,1 (90% доверие).

Поскольку предположения о линейности и нормальности не были полностью выполнены для MLR, были протестированы нелинейные модели, включая модели полиномиальной регрессии второй, третьей и шестой степени, а также GAM. Хотя модели полиномиальной регрессии показали более высокие значения R^2 — 0,449 (44,9%) для второй степени, 0,562 (56,2%) для третьей степени и 0,867 (86,7%) для шестой степени — все p-значения для независимых переменных превышали порог альфа 0,1, что сделало их статистически незначимыми. Поэтому эти модели не были использованы для стресс-тестирования.

GAM продемонстрировала скорректированный R^2 равный 0,359 (35,9%) и объяснила 44% отклонений, при этом все p-значения оказались ниже порога альфа. В сравнении с этим, MLR показала R^2 равное 0,4426 (44,3%) и скорректированный R^2 равный 0,359 (35,9%), с p-значениями ниже 0,1. В результате нулевая гипотеза (H0) была отклонена в пользу альтернативной гипотезы (Ha), что подтверждает наличие связи между убытками от операционного риска и макроэкономическими переменными.

**Оптимальная модель для прогнозирования степени убытков**

Наиболее эффективной моделью для прогнозирования суммы (степени) убытков от операционного риска была определена с использованием следующих независимых переменных из набора данных пакета "AFR" в R:

GDD_Trn_R_y: Реальный валовой добавленный стоимость для транспорта

GDD_Inf_R_y: Реальный валовой добавленный стоимость для информации

Rincpop_q_y: Реальный средний месячный доход на душу населения

Зависимой переменной была доля совокупных убытков операционного риска в активах банка "X".

**Частота убытков**

Для оценки частоты убытков использовалась множественная регрессия Пуассона. Результаты показали, что множественная  регрессия Пуассона дает разумные прогнозы, причем множественная регрессия с отрицательной биномиальной моделью близка к этим результатам. Статистический порог для R^2 (35%) и уровня альфа (0,1) (90% доверие) был сохранен.

Лучшая модель для прогнозирования частоты убытков была определена с использованием множественной регрессии Пуассона с следующими независимыми переменными:

ruktzt: курс рубль/тенге

Rincpop_q_y: Реальный средний месячный доход на душу населения

GDD_R_y: Реальный валовой добавленный стоимость

Зависимой переменной была общая частота убытков операционного риска для банка "X". Псевдопоказатель R^2 для этой модели составил 0,48 (r2ML, r2CU), при этом все p-значения были ниже порога 0,1. В результате нулевая гипотеза (H0) была отклонена в пользу альтернативной гипотезы (Ha), что укрепляет корреляцию между убытками операционного риска и макроэкономическими переменными.

**Анализ корреляции**

Во всех моделях была наблюдаема отрицательная корреляция между независимыми и зависимыми переменными.

**Прогнозируемые результаты**

**Множественная линейная регрессия (Степень убытков)**

Позитивный сценарий:

Наибольший убыток: KZT 46,228,220

Наименьший убыток: KZT 36,771,242

Негативный сценарий:

Наибольший убыток: KZT 54,684,134

Наименьший убыток: KZT 52,068,502

**Обобщенная аддитивная модель (Степень убытков)**

Позитивный сценарий:

Наибольший убыток: KZT 27,999,022

Наименьший убыток: KZT 25,739,693

Негативный сценарий:

Наибольший убыток: KZT 63,592,518

Наименьший убыток: KZT 61,240,187

**Множественная поассоновская регрессия (Частота убытков)**

Позитивный сценарий:

Наибольшая частота: 3,101

Наименьшая частота: 568

Негативный сценарий:

Наибольшая частота: 162

Наименьшая частота: 115

**Промежуточные соображения**

Результаты этого стресс-тестирования должны интерпретироваться с осторожностью, поскольку некоторые предположения моделей, такие как линейность и нормальность, не были полностью выполнены. Несмотря на это ограничение, результаты предоставляют ценные данные о взаимосвязи между убытками операционного риска и макроэкономическими переменными, что помогает в оценке рисков и разработке стратегий их смягчения.

# Модель исторического моделирования
## Предварительная обработка данных

```{r}
# Исследовательский анализ данных
summary(or_type1)
glimpse(or_type1)
str(or_type1)
```
Обрезка датафрейма в соответствии с временными рамками регрессионной модели.
```{r}
# Обрезка данных для периода с 01.01.2010 по 31.12.2016
or_type1_truncated <- or_type1 %>%
  filter(Date >= as.Date("2010-01-01") & Date <= as.Date("2016-12-31"))

# Просмотр первых и последних строк обрезанного датафрейма
head(or_type1_truncated)
tail(or_type1_truncated)

```

```{r}
# Конвертация значений в USD в KZT
usd_kzt_exchange_rates <- c(
  `2016` = 342.16,
  `2015` = 221.73,
  `2014` = 179.19,
  `2013` = 152.13,
  `2012` = 149.11,
  `2011` = 146.62,
  `2010` = 147.35
)

convert_to_kzt <- function(year, value) {
  exchange_rate <- usd_kzt_exchange_rates[as.character(year)]
  if (!is.na(exchange_rate)) {
    return(value * exchange_rate)
  } else {
    return(NA)
  }
}

or_type1_kzt <- or_type1_truncated %>%
  mutate(Year = as.numeric(format(Date, "%Y")),
         Loss_kzt = mapply(convert_to_kzt, Year, Loss)) %>%
  relocate(Loss_kzt, .after = Loss) %>%
  dplyr::select(-Year)  # Явно используем select из dplyr

# Проверка данных
head(or_type1_kzt)
tail(or_type1_kzt)
```

```{r}
# Исследовательский анализ данных
summary(or_type2)
glimpse(or_type2)
str(or_type2)

```
Обрезка датафрейма в соответствии с временными рамками модели регрессии
```{r}
# Усечение фрейма данных за период с 01.01.2010 по 31.12.2016
or_type2_truncated <- or_type2 %>%
  filter(Date >= as.Date("2010-01-01") & Date <= as.Date("2016-12-31"))
head(or_type2_truncated)
tail(or_type2_truncated)
```
Конвертация значений из USD в KZT
```{r}
# Конвертация значений из USD в KZT
usd_kzt_exchange_rates <- c(
  `2016` = 342.16,
  `2015` = 221.73, 
  `2014` = 179.19,
  `2013` = 152.13,
  `2012` = 149.11,
  `2011` = 146.62,
  `2010` = 147.35
)

convert_to_kzt <- function(year, value) {
  exchange_rate <- usd_kzt_exchange_rates[as.character(year)]
  if (!is.na(exchange_rate)) {
    return(value * exchange_rate)
  } else {
    return(NA)
  }
}

or_type2_kzt <- or_type2_truncated %>%
  mutate(Year = as.numeric(format(Date, "%Y")),
         Loss_kzt = mapply(convert_to_kzt, Year, Loss)) %>%
  relocate(Loss_kzt, .after = Loss) %>%
  dplyr::select(-Year)

# Проверка данных
head(or_type2_kzt)
tail(or_type2_kzt)
```



```{r}
# Исследовательский анализ данных
summary(or_type3)
glimpse(or_type3)
str(or_type3)

```
Обрезка данных в соответствии с временными рамками Регрессионной модели

```{r}
# Обрезка данных для периода с 01.01.2010 по 31.12.2016
or_type3_truncated <- or_type3 %>%
  filter(Date >= as.Date("2010-01-01") & Date <= as.Date("2016-12-31"))
head(or_type3_truncated)
tail(or_type3_truncated)
```
c
```{r}
# Конвертация значений в USD в KZT
usd_kzt_exchange_rates <- c(
  `2016` = 342.16,
  `2015` = 221.73,
  `2014` = 179.19,
  `2013` = 152.13,
  `2012` = 149.11,
  `2011` = 146.62,
  `2010` = 147.35
)

convert_to_kzt <- function(year, value) {
  exchange_rate <- usd_kzt_exchange_rates[as.character(year)]
  if (!is.na(exchange_rate)) {
    return(value * exchange_rate)
  } else {
    return(NA)
  }
}

or_type3_kzt <- or_type3_truncated %>%
  mutate(Year = as.numeric(format(Date, "%Y")),
         Loss_kzt = mapply(convert_to_kzt, Year, Loss)) %>%
  relocate(Loss_kzt, .after = Loss) %>%
  dplyr::select(-Year)

# Проверка данных
head(or_type3_kzt)
tail(or_type3_kzt)
```



```{r}
# Исследовательский анализ данных
summary(or_type4)
glimpse(or_type4)
str(or_type4)
```
Обрезка данных в соответствии с временными рамками Регрессионной модели
```{r}
# Truncating data frame for the period 01.01.2010 - 31.12.2016
or_type4_truncated <- or_type4 %>%
  filter(Date >= as.Date("2010-01-01") & Date <= as.Date("2016-12-31"))
head(or_type4_truncated)
tail(or_type4_truncated)
```
Конвертация значений в USD в KZT
```{r}
# Преобразование значений из USD в KZT
usd_kzt_exchange_rates <- c(
  `2016` = 342.16,
  `2015` = 221.73,
  `2014` = 179.19,
  `2013` = 152.13,
  `2012` = 149.11,
  `2011` = 146.62,
  `2010` = 147.35
)

convert_to_kzt <- function(year, value) {
  exchange_rate <- usd_kzt_exchange_rates[as.character(year)]
  if (!is.na(exchange_rate)) {
    return(value * exchange_rate)
  } else {
    return(NA)
  }
}

or_type4_kzt <- or_type4_truncated %>%
  mutate(Year = as.numeric(format(Date, "%Y")),
         Loss_kzt = mapply(convert_to_kzt, Year, Loss)) %>%
  relocate(Loss_kzt, .after = Loss) %>%
  dplyr::select(-Year) 


# Проверка данных
head(or_type4_kzt)
tail(or_type4_kzt)
```


### Вычисление корреляции между различными типами операционных рисков

```{r}
# Находим минимальное количество строк между каждым типом операционного риска
min_rows <- min(nrow(or_type1_kzt), nrow(or_type2_kzt), 
                nrow(or_type3_kzt), nrow(or_type4_kzt))

# Обрезаем все дата-фреймы до минимального числа строк
or_type1_minrow <- or_type1_kzt[1:min_rows, ]
or_type2_minrow  <- or_type2_kzt[1:min_rows, ]
or_type3_minrow  <- or_type3_kzt[1:min_rows, ]
or_type4_minrow  <- or_type4_kzt[1:min_rows, ]

# Создаем объединенный дата-фрейм
combined_or_loss <- cbind(or_type1_minrow$Loss_kzt, or_type2_minrow$Loss_kzt, 
                          or_type3_minrow$Loss_kzt, or_type4_minrow$Loss_kzt)
str(combined_or_loss)
```
```{r}
# Проверка дата-фрейма
head(combined_or_loss)
tail(combined_or_loss)
```
#### Расчет корреляции Кендалла
```{r fig.align="center", fig.width=6, fig.height=4}
# Расчет корреляционной матрицы Кендалла
kendall_corr <- cor(combined_or_loss, method = "kendall", 
                    use = "complete.obs")
print(kendall_corr)
```
```{r fig.align="center", fig.width=6, fig.height=4}
# Визуализация матрицы корреляции Кендалла с помощью графика корреляции
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", 
                          "#77AADD", "#4477AA"))
corrplot(kendall_corr, method = "color", col = col(200),
         type = "upper", order = "hclust",
         addCoef.col = "black", 
         tl.col = "black", tl.srt = 45)
```
**Обнаружения:** Матрица корреляции Кендалла показывает слабые корреляции между различными типами операционных рисков, что позволяет заключить, что эти переменные в основном независимы или имеют минимальные линейные взаимосвязи. Изменения в одном типе операционного риска оказывают минимальное влияние на другие. Для целей моделирования эта низкая структура корреляции может уменьшить опасения относительно мультиколлинеарности в сценариях регрессии или стресс-тестирования.

### Операционный риск тип 1

Расчет частоты потерь операционного риска по месяцам.

```{r}
# Расчет частоты потерь операционного риска по месяцам
or_type1_bymonths <- or_type1_kzt %>% 
  mutate(YearMonth = format(Date, "%Y-%m")) %>%
  group_by(YearMonth) %>% 
  summarise(Frequency_Monthly = n())
print(or_type1_bymonths)
or_type1_bymonths <- as.data.frame(or_type1_bymonths)
head(or_type1_bymonths)
```


### Операционный риск тип 2

Расчет частоты потерь операционного риска по месяцам.


```{r}
# Расчет частоты потерь операционного риска по месяцам
or_type2_bymonths <- or_type2_kzt %>% 
  mutate(YearMonth = format(Date, "%Y-%m")) %>%
  group_by(YearMonth) %>% 
  summarise(Frequency_Monthly = n())
print(or_type2_bymonths)
or_type2_bymonths <- as.data.frame(or_type2_bymonths)
head(or_type2_bymonths)
```


### Операционный риск тип 3

Расчет частоты потерь операционного риска по месяцам.


```{r}
# Расчет частоты потерь операционного риска по месяцам
or_type3_bymonths <- or_type3_kzt %>% 
  mutate(YearMonth = format(Date, "%Y-%m")) %>%
  group_by(YearMonth) %>% 
  summarise(Frequency_Monthly = n())
print(or_type3_bymonths)
or_type3_bymonths <- as.data.frame(or_type3_bymonths)
head(or_type3_bymonths)
```


### Операционный риск тип 4

Расчет частоты потерь операционного риска по месяцам.


```{r}
# Расчет частоты потерь операционного риска по месяцам
or_type4_bymonths <- or_type4_kzt %>% 
  mutate(YearMonth = format(Date, "%Y-%m")) %>%
  group_by(YearMonth) %>% 
  summarise(Frequency_Monthly = n())
print(or_type4_bymonths)
or_type4_bymonths <- as.data.frame(or_type4_bymonths)
head(or_type4_bymonths)
```


## Статистические тесты для различных распределений
Для выбора подходящего распределения для генерации операционных убытков (размер/тяжесть) к историческим данным были применены статистические тесты для выбора между (логнормальным, нормальным и распределением Вейбулла) и подтверждения соответствия данных выбранным распределениям.

### Операционный риск тип 1
#### Применение различных распределений


```{r warning=FALSE}
# Подгонка исторических данных к логнормальному распределению
fit_lnorm_type1 <- fitdist(or_type1_kzt$Loss_kzt, "lnorm")
summary(fit_lnorm_type1)

```


```{r warning=FALSE}
# Подгонка исторических данных к нормальному распределению
fit_norm_type1 <- fitdist(or_type1_kzt$Loss_kzt, "norm")
summary(fit_norm_type1)

```


```{r warning=FALSE}
# Подгонка исторических данных к распределению Вейбулла
fit_weibull_type1 <- fitdist(or_type1_kzt$Loss_kzt, "weibull")
summary(fit_weibull_type1)

```


```{r}
# Построение графика подогнанного логнормального распределения
par(mfrow = c(2, 2)) 
plot(fit_lnorm_type1)

```


```{r}
# Построение графика подогнанного нормального распределения
par(mfrow = c(2, 2)) 
plot(fit_norm_type1)

```


```{r}
# Построение графика подогнанного распределения Вейбулла
par(mfrow = c(2, 2)) 
plot(fit_weibull_type1)
```
```


#### Статистические тесты

**Формулировка гипотезы:**
Нулевая гипотеза (H0) заключается в том, что выборка происходит
из эталонного распределения (Логнормальное/Нормальное/Вейбуллово
распределение). Альтернативная гипотеза (HA) состоит в том, что выборка
не происходит из эталонного распределения (Логнормальное/Нормальное/Вейбуллово
распределение).



```{r}
# Удаление дубликатов из данных
or_type1_unique <- unique(or_type1_kzt$Loss_kzt)
# Тест Колмогорова-Смирнова для логнормального распределения с уникальными значениями
ks_lnorm_type1 <- ks.test(or_type1_unique, "plnorm", 
                          meanlog = fit_lnorm_type1$estimate["meanlog"], 
                          sdlog = fit_lnorm_type1$estimate["sdlog"])
print(ks_lnorm_type1)
```


**Обнаружения:** p-значение очень маленькое 0.00003716 < 0.05. Очень маленькое p-значение
свидетельствует в пользу сильных доказательств против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не соответствуют логнормальному распределению.


```{r}
# Колмогоров-Смирнов тест для нормального распределения
ks_norm_type1 <- ks.test(or_type1_unique, "pnorm", 
                         mean = fit_norm_type1$estimate["mean"], 
                         sd = fit_norm_type1$estimate["sd"])
print(ks_norm_type1)
```


**Обнаружения:** Значение p-уровня очень маленькое 0.00000000000000022 < 0.05. Очень маленькое значение p-уровня указывает на сильные доказательства против нулевой гипотезы. Нулевая гипотеза отклонена. Данные не следуют нормальному распределению.


```{r}
# Колмогоров-Смирнов тест для распределения Вейбулла с уникальными значениями
ks_weibull_type1 <- ks.test(or_type1_unique, "pweibull", 
                            shape = fit_weibull_type1$estimate["shape"], 
                            scale = fit_weibull_type1$estimate["scale"])
print(ks_weibull_type1)

```


**Обнаружения:** Значение p-value маленькое = 0.5356 > 0.05. Это значение p-value указывает на то, что нет значительных доказательств того, что данные отклоняются от теоретического (Вейбуллового) распределения. Мы не отвергаем нулевую гипотезу. Данные соответствуют распределению Вейбулла.


```{r}
# Тест Андерсона-Дарлинга для распределения Log-Normal
gof_lnorm_type1 <- gofstat(fit_lnorm_type1)
print(gof_lnorm_type1)
```


**Обнаружения:** 0.0505 — это статистика Колмогорова-Смирнова для подгона распределения Log-Normal. Чем ближе это значение к 0, тем лучше подгонка. Значение 0.0505 указывает на разумную подгонку.
1.3405 — это статистика Крамера-Фон Мизеса, еще одна мера качества подгоночности. Как и статистика Колмогорова-Смирнова, меньшее значение указывает на лучшую подгонку.
8.6006 — это статистика Андерсона-Дарлинга, которая более чувствительна к отклонениям в хвостах распределения. Более высокое значение обычно указывает на плохую подгонку, особенно в хвостах. Поскольку 8.6006 довольно высоко, это указывает на то, что распределение Log-Normal может не идеально подходить к данным, особенно в хвостах.
Критерий информации Акаике (AIC): 36,638.32
Критерий информации Байеса (BIC): 36,648.79
Эти значения будут сравнены с результатами для других распределений, чтобы определить наилучшую модель.


```{r}
# Тест Андерсона-Дарлинга для нормального распределения
ad_norm_type1 <- ad.test(or_type1_kzt$Loss_kzt)
print(ad_norm_type1)
```

**Обнаружения:** p-значение очень мало < 2.2e-16. Очень маленькое p-значение
свидетельствует о сильных доказательствах против нулевой гипотезы. Нулевая
гипотеза отклоняется. Данные не соответствуют нормальному распределению.


```{r}
# Тест Андерсона-Дарлинга для распределения Вейбулла
gof_weibull_type1 <- gofstat(fit_weibull_type1)
print(gof_weibull_type1)
```

**Обнаружения:** 0.0234 — это статистика Колмогорова-Смирнова для подбора распределения Вейбулла. Чем ближе это значение к 0, тем лучше подгонка. Значение 0.0234 указывает на разумную подгонку.
0.1902 — это статистика Крамера фон Мизеса, еще одна мера качества подгонки. Как и статистика Колмогорова-Смирнова, меньшее значение указывает на лучшую подгонку.
1.3191 — это статистика Андерсона-Дарлинга, которая более чувствительно измеряет подгонку распределения в хвостах. Меньшее значение указывает на лучшую подгонку в хвостах. Поскольку 1.3191 относительно низкое, это говорит о том, что распределение Вейбулла хорошо подходит для данных, включая хвосты.
Критерий информации Акаике (AIC): 36,519.45
Критерий информации Бейса (BIC): 36,529.92
Эти значения будут сравниваться с результатами других распределений для определения наилучшей модели подгонки.

### Операционный риск тип 2

#### Применение различных распределений



```{r warning=FALSE}
# Подгонка исторических данных к лог-нормальному распределению
fit_lnorm_type2 <- fitdist(or_type2_kzt$Loss_kzt, "lnorm")
summary(fit_lnorm_type2)
```


```{r warning=FALSE}
# Подгонка исторических данных к нормальному распределению
fit_norm_type2 <- fitdist(or_type2_kzt$Loss_kzt, "norm")
summary(fit_norm_type2)
```


```{r warning=FALSE}
# Подгонка исторических данных к распределению Вейбулла
fit_weibull_type2 <- fitdist(or_type2_kzt$Loss_kzt, "weibull")
summary(fit_weibull_type2)

```


```{r}
# Построение графиков подогнанного лог-нормального распределения 
par(mfrow = c(2, 2)) 
plot(fit_lnorm_type2)

```


```{r}
# Построение графиков подогнанного нормального распределения
par(mfrow = c(2, 2)) 
plot(fit_norm_type2)

```


```{r}
# Построение графиков подогнанного распределения Вейбулла
par(mfrow = c(2, 2)) 
plot(fit_weibull_type2)

```


#### Статистические тесты

**Формулировка гипотезы:** 
Нулевая гипотеза (H0) — выборка приходит
из опорного распределения (Log-Normal/Normal/Weibull
распределение). Альтернативная гипотеза (HA) — выборка не приходит
из опорного распределения (Log-Normal/Normal/Weibull
распределение).



```{r}
# Удаление дубликатов из данных
or_type2_unique <- unique(or_type2_kzt$Loss_kzt)
# Тест Колмогорова-Смирнова для Log-Normal распределения с уникальными значениями
ks_lnorm_type2 <- ks.test(or_type2_unique, "plnorm", 
                          meanlog = fit_lnorm_type2$estimate["meanlog"], 
                          sdlog = fit_lnorm_type2$estimate["sdlog"])
print(ks_lnorm_type2)
```


**Обнаружения:** p-значение очень мало \< 0.00001325. Очень малое p-значение
свидетельствует о сильных доказательствах против нулевой гипотезы. Нулевая гипотеза отклоняется. Данные не следуют лог-нормальному распределению.


```{r}
# Колмогоров-Смирнов тест для нормального распределения
ks_norm_type2 <- ks.test(or_type2_unique, "pnorm", mean = fit_norm_type2$estimate["mean"], 
                         sd = fit_norm_type2$estimate["sd"])
print(ks_norm_type2)

```


**Обнаружения:** p-значение очень маленькое < 0.00000000000000022. Очень маленькое p-значение предполагает сильное свидетельство против нулевой гипотезы. Нулевая гипотеза отклоняется. Данные не следуют нормальному распределению.


```{r}
# Тест Колмогорова-Смирнова для распределения Вейбулла с уникальными значениями
ks_weibull_type2 <- ks.test(or_type2_unique, "pweibull", 
                           shape = fit_weibull_type2$estimate["shape"],
                           scale = fit_weibull_type2$estimate["scale"])
print(ks_weibull_type2)
```


**Обнаружения:** P-значение = 0.2813 > 0.05. Относительно высокое значение p-значения (0.2813) не дает достаточных оснований отвергнуть нулевую гипотезу, предполагающую соответствие данных распределению Вейбулла. Мы не отвергаем нулевую гипотезу. Данные могут соответствовать распределению Вейбулла.


```{r}
# Тест Андерсона-Дарлинга для логнормального распределения
gof_lnorm_type2 <- gofstat(fit_lnorm_type2)
print(gof_lnorm_type2)
```


**Обнаружения:** Статистика Колмогорова-Смирнова для соответствия логнормальному распределению составляет 0.0613. Чем ближе это значение к 0, тем лучше соответствие. Значение 0.0613 указывает на приемлемое соответствие.
Статистика Крамера-фон Мизеса равна 1.8016. Как и статистика Колмогорова-Смирнова, меньшее значение свидетельствует о лучшем соответствии. Статистика Андерсона-Дарлинга составляет 12.0650 и более чувствительно оценивает соответствие распределения, особенно в хвостах. Более высокое значение обычно указывает на худшее соответствие. Значение 12.0650 относительно велико, что позволяет предположить, что логнормальное распределение может не идеально соответствовать данным, особенно в хвостах.
Информационный критерий Акаике (AIC) = 37,961.13
Байесовский информационный критерий (BIC) = 37,971.64
Эти значения будут сравниваться с аналогичными результатами для других распределений для определения наилучшего соответствия.


```{r}
# Тест Андерсона-Дарлинга для нормального распределения
ad_norm_type2 <- ad.test(or_type2_kzt$Loss_kzt)
print(ad_norm_type2)
```


**Обнаружения:** P-значение чрезвычайно мало (< 2.2e-16). Столь малое p-значение указывает на весомые доказательства против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не следуют нормальному распределению.Обнаружения: P-значение чрезвычайно мало (< 2.2e-16). Столь малое p-значение указывает на весомые доказательства против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не следуют нормальному распределению.


```{r}
# Тест Андерсона-Дарлинга для распределения Вейбулла
gof_weibull_type2 <- gofstat(fit_weibull_type2)
print(gof_weibull_type2)
```

**Обнаружения:** Статистика Колмогорова-Смирнова составляет 0.0280. Поскольку это значение близко к 0, это указывает на разумное соответствие распределению Вейбулла.
Статистика Крамера-Вон Мизеса составляет 0.2808. Как и статистика Колмогорова-Смирнова, меньшее значение указывает на лучшее соответствие.
Статистика Андерсона-Дарлинга составляет 1.7831, что более чувствительно измеряет соответствие распределения в хвостах. Меньшее значение указывает на лучшее соответствие, и 1.7831 является относительно небольшим, что указывает на хорошее соответствие распределения Вейбулла данным.
Критерий информации Акаике (AIC): 37,753.40
Критерий Байесовской информации (BIC): 37,763.91
Эти значения будут сравниваться с другими распределениями, чтобы определить лучшее соответствие данным.

### Операционный риск тип 3
#### Применение различных распределений


```{r warning=FALSE}
# Подбор исторических данных к распределению Логнормального
fit_lnorm_type3 <- fitdist(or_type3_kzt$Loss_kzt, "lnorm")
summary(fit_lnorm_type3)

```


```{r warning=FALSE}
# Подбор исторических данных к Нормальному распределению
fit_norm_type3 <- fitdist(or_type3_kzt$Loss_kzt, "norm")
summary(fit_norm_type3)
```


```{r warning=FALSE}
# Подбор исторических данных к распределению Вейбулла
fit_weibull_type3 <- fitdist(or_type3_kzt$Loss_kzt, "weibull")
summary(fit_weibull_type3)
```


```{r}
# Построение графика подогнанного Логнормального распределения
par(mfrow = c(2, 2)) 
plot(fit_lnorm_type3)
```


```{r}
# Построение графика подогнанного Нормального распределения
par(mfrow = c(2, 2)) 
plot(fit_norm_type3)
```


```{r}
# Построение графика подогнанного распределения Вейбулла
par(mfrow = c(2, 2)) 
plot(fit_weibull_type3)
```


#### Статистические тесты

**Формулировка гипотезы:**  
Нулевая гипотеза (H0) заключается в том, что выборка происходит из эталонного распределения (Логнормальное/Нормальное/Распределение Вейбулла).  
Альтернативная гипотеза (HA) заключается в том, что выборка не происходит из эталонного распределения (Логнормальное/Нормальное/Распределение Вейбулла).


```{r}
# Удаление дубликатов из данных
or_type3_unique <- unique(or_type3_kzt$Loss_kzt)
# Тест Колмогорова-Смирнова для Логнормального распределения с уникальными значениями
ks_lnorm_type3 <- ks.test(or_type3_unique, "plnorm", 
                          meanlog = fit_lnorm_type3$estimate["meanlog"], 
                          sdlog = fit_lnorm_type3$estimate["sdlog"])
print(ks_lnorm_type3)
```


**Обнаружения:** p-значение составляет 0.6867, что является большим. Большое p-значение не предоставляет сильных доказательств против нулевой гипотезы.
Поскольку нулевая гипотеза предполагает, что данные следуют Логнормальному распределению, мы не отвергаем её.
Это указывает на то, что Логнормальное распределение хорошо подходит для данных.


```{r}
# Тест Колмогорова-Смирнова для Нормального распределения
ks_norm_type3 <- ks.test(or_type3_unique, "pnorm", 
                         mean = fit_norm_type3$estimate["mean"], 
                         sd = fit_norm_type3$estimate["sd"])
print(ks_norm_type3)
```

**Обнаружения:** p-значение очень маленькое \< 2.2e-16. Очень маленькое p-значение указывает на сильные доказательства против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не следуют Нормальному распределению.


```{r}
# Тест Колмогорова-Смирнова для распределения Вейбулла с уникальными значениями
ks_weibull_type3 <- ks.test(or_type3_unique, "pweibull", 
                            shape = fit_weibull_type3$estimate["shape"], 
                            scale = fit_weibull_type3$estimate["scale"])
print(ks_weibull_type3)
```


**Обнаружения:** p-значение очень маленькое (0.000005129), что предоставляет сильные доказательства против нулевой гипотезы.
Нулевая гипотеза предполагает, что данные следуют распределению Вейбулла.
Поскольку мы отвергаем нулевую гипотезу, мы заключаем, что данные не следуют распределению Вейбулла.


```{r}
# Тест Андерсона-Дарлинга для Логнормального распределения
gof_lnorm_type3 <- gofstat(fit_lnorm_type3)
print(gof_lnorm_type3)
```


**Обнаружения:** 0.0185 — это статистика Колмогорова-Смирнова для подгона Логнормального распределения. Чем ближе это значение к 0, тем лучше подгонка. Значение 0.0185 указывает на разумное соответствие.  
0.0960 — это статистика Крамера-Вон Мизеса. Как и статистика Колмогорова-Смирнова, меньшее значение указывает на лучшее соответствие.  
0.6089 — это статистика Андерсона-Дарлинга, которая более чувствительно измеряет соответствие распределения в хвостах. Меньшее значение указывает на лучшее соответствие, и 0.6089 является относительно небольшим, что указывает на то, что Логнормальное распределение может хорошо соответствовать данным.  
Критерий информации Акаике (AIC): 36,272.99  
Критерий Байесовской информации (BIC): 36,283.44  
Эти значения будут сравниваться с теми же результатами для других распределений, чтобы определить лучшее соответствие.

```{r}
# Тест Андерсона-Дарлинга для Нормального распределения
ad_norm_type3 <- ad.test(or_type3_kzt$Loss_kzt)
print(ad_norm_type3)
```


**Обнаружения:** p-значение очень маленькое \< 2.2e-16. Очень маленькое p-значение указывает на сильные доказательства против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не следуют Нормальному распределению.


```{r}
# Тест Андерсона-Дарлинга для распределения Вейбулла
gof_weibull_type3 <- gofstat(fit_weibull_type3)
print(gof_weibull_type3)
```


**Обнаружения:** 0.0726 — это статистика Колмогорова-Смирнова для подгона распределения Вейбулла. Чем ближе это значение к 0, тем лучше подгонка. Значение 0.0726 указывает на умеренное соответствие.  
2.6130 — это статистика Крамера-Вон Мизеса. Как и статистика Колмогорова-Смирнова, меньшее значение указывает на лучшее соответствие.  
18.6506 — это статистика Андерсона-Дарлинга, которая более чувствительно измеряет соответствие распределения в хвостах. Большие значения указывают на худшее соответствие, особенно в хвостах. 18.6506 является относительно большим, что указывает на то, что распределение Вейбулла может не идеально соответствовать данным, особенно в хвостах.  
Критерий информации Акаике (AIC): 36,540.56  
Критерий Байесовской информации (BIC): 36,551.02  
Эти значения будут сравниваться с теми же результатами для других распределений, чтобы определить лучшее соответствие.

### Операционный риск тип 4

#### Применение различных распределений


```{r warning=FALSE}
# Подбор исторических данных к Логнормальному распределению
fit_lnorm_type4 <- fitdist(or_type4_kzt$Loss_kzt, "lnorm")
summary(fit_lnorm_type4)
```


```{r warning=FALSE}
# Подбор исторических данных к Нормальному распределению
fit_norm_type4 <- fitdist(or_type4_kzt$Loss_kzt, "norm")
summary(fit_norm_type4)
```


```{r warning=FALSE}
# Подбор исторических данных к распределению Вейбулла
fit_weibull_type4 <- fitdist(or_type4_kzt$Loss_kzt, "weibull")
summary(fit_weibull_type4)
```


```{r}
# Построение графика подогнанного Логнормального распределения
par(mfrow = c(2, 2)) 
plot(fit_lnorm_type4)
```


```{r}
# Построение графика подогнанного Нормального распределения
par(mfrow = c(2, 2)) 
plot(fit_norm_type4)
```


```{r}
# Построение графика подогнанного распределения Вейбулла
par(mfrow = c(2, 2)) 
plot(fit_weibull_type4)
```



#### Статистические тесты

**Формулировка гипотезы:**  
Нулевая гипотеза (H0) заключается в том, что выборка происходит из эталонного распределения (Логнормальное/Нормальное/Распределение Вейбулла).  
Альтернативная гипотеза (HA) заключается в том, что выборка не происходит из эталонного распределения (Логнормальное/Нормальное/Распределение Вейбулла).


```{r}
# Удаление дубликатов из данных
or_type4_unique <- unique(or_type4_kzt$Loss_kzt)
# Тест Колмогорова-Смирнова для Логнормального распределения с уникальными значениями
ks_lnorm_type4 <- ks.test(or_type4_unique, "plnorm", 
                          meanlog = fit_lnorm_type4$estimate["meanlog"], 
                          sdlog = fit_lnorm_type4$estimate["sdlog"])
print(ks_lnorm_type4)
```

**Обнаружения:** p-значение маленькое 0.03535 < 0.05. Маленькое p-значение указывает на доказательства против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не следуют Логнормальному распределению.


```{r}
# Тест Колмогорова-Смирнова для Нормального распределения
ks_norm_type4 <- ks.test(or_type4_unique, "pnorm", 
                         mean = fit_norm_type4$estimate["mean"], 
                         sd = fit_norm_type4$estimate["sd"])
print(ks_norm_type4)
```


**Обнаружения:** p-значение очень маленькое \< 2.2e-16. Очень маленькое p-значение указывает на сильные доказательства против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не следуют Нормальному распределению.

```{r}
# Тест Колмогорова-Смирнова для распределения Вейбулла с уникальными значениями
ks_weibull_type4 <- ks.test(or_type4_unique, "pweibull", 
                            shape = fit_weibull_type4$estimate["shape"], 
                            scale = fit_weibull_type4$estimate["scale"])
print(ks_weibull_type4)
```


**Обнаружения:** p-значение очень маленькое = 0.0000004787. Очень маленькое p-значение указывает на сильные доказательства против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не следуют распределению Вейбулла.


```{r}
# Тест Андерсона-Дарлинга для Логнормального распределения
gof_lnorm_type4 <- gofstat(fit_lnorm_type4)
print(gof_lnorm_type4)
```


**Обнаружения:** Статистика Колмогорова-Смирнова: 0.0453 → Меньшее значение указывает на лучшее соответствие, и 0.0453 указывает на разумное соответствие.  
Статистика Крамера-Вон Мизеса: 1.0102 → Меньшее значение указывает на лучшее соответствие; однако 1.0102 достаточно высоко, что означает, что соответствие может быть не идеальным.  
Статистика Андерсона-Дарлинга: 7.6099 → Эта статистика более чувствительна к хвостам распределения. Значение 7.61 является относительно большим, что указывает на то, что Логнормальное распределение может быть не лучшим подогоном, особенно в хвостах.  
AIC (Критерий информации Акаике): 29,924.04  
BIC (Критерий Байесовской информации): 29,935.18.  
Эти значения следует сравнить с AIC/BIC других распределений, чтобы определить лучшее соответствие.

```{r}
# Тест Андерсона-Дарлинга для Нормального распределения
ad_norm_type4 <- ad.test(or_type4_kzt$Loss_kzt)
print(ad_norm_type4)
```


**Обнаружения:** p-значение очень маленькое \< 2.2e-16. Очень маленькое p-значение указывает на сильные доказательства против нулевой гипотезы. Нулевая гипотеза отвергается. Данные не следуют Нормальному распределению.

```{r}
# Тест Андерсона-Дарлинга для распределения Вейбулла
gof_weibull_type4 <- gofstat(fit_weibull_type4)
print(gof_weibull_type4)
```


**Обнаружения:** Статистика Колмогорова-Смирнова: 0.0774 → Меньшее значение указывает на лучшее соответствие, но 0.0774 является относительно высоким, что указывает на умеренное соответствие в лучшем случае.
Статистика Крамера-Вон Мизеса: 1.8786 → Меньшее значение является лучшим, но 1.8786 достаточно высоко, что означает, что соответствие не идеальное.
Статистика Андерсона-Дарлинга: 14.5589 → Эта статистика более чувствительна к хвостам распределения. Значение 14.56 достаточно большое, что предполагает, что распределение Вейбулла может не подходить хорошо для данных, особенно в хвостах.
AIC (Критерий информации Акаике): 35,467.93
BIC (Критерий Байесовской информации): 35,478.35.
Эти значения следует сравнить с аналогичными значениями для других распределений, чтобы определить лучшее соответствие.

### Выбор лучшего подбора для различных типов Операционного Риска
**Резюме:**
Нормальное: Нормальное распределение не будет рассматриваться для статистического моделирования, поскольку данные для всех типов операционных рисков показывают асимметричное распределение, и также подгонка данных под Нормальное распределение не прошла статистические тесты для всех типов операционных рисков.

#### Операционный риск тип 1:

**Логнормальное распределение:**
- Колмогоров-Смирнов: 0.05046176
- Крамер-вон Мисес: 1.34054128
- Андрессон-Дарлинг: 8.60063520
- Критерий информации Акаике (AIC): 36638.32
- Критерий Байесовской информации (BIC): 36648.79.

**Вейбулл:**
- Колмогоров-Смирнов: 0.0234092
- Крамер-вон Мисес: 0.1902371
- Андрессон-Дарлинг: 1.3191119
- Критерий информации Акаике (AIC): 36519.45
- Критерий Байесовской информации (BIC): 36529.92  
**Лучшее распределение:** Вейбулл, так как оно имеет более низкие значения по всем статистикам тестов (KS, CvM, AD, AIC и BIC).

---

#### Операционный риск тип 2:

**Логнормальное распределение:**
- Колмогоров-Смирнов: 0.06131419
- Крамер-вон Мисес: 0.1902371
- Андрессон-Дарлинг: 1.3191119
- Критерий информации Акаике (AIC): 37961.13
- Критерий Байесовской информации (BIC): 37971.64.

**Вейбулл:**
- Колмогоров-Смирнов: 0.02803716
- Крамер-вон Мисес: 0.28084810
- Андрессон-Дарлинг: 1.78313270
- Критерий информации Акаике (AIC): 37753.40
- Критерий Байесовской информации (BIC): 37763.91  
**Лучшее распределение:** Вейбулл, так как оно имеет более низкие значения статистик тестов (KS, CvM, AD, AIC и BIC).

---

#### Операционный риск тип 3:

**Логнормальное распределение:**
- Колмогоров-Смирнов: 0.01847924
- Крамер-вон Мисес: 0.09596050
- Андрессон-Дарлинг: 0.60888939
- Критерий информации Акаике (AIC): 36272.99
- Критерий Байесовской информации (BIC): 36283.44.

**Вейбулл:**
- Колмогоров-Смирнов: 0.07255944
- Крамер-вон Мисес: 2.61295261
- Андрессон-Дарлинг: 18.65059489
- Критерий информации Акаике (AIC): 36540.56
- Критерий Байесовской информации (BIC): 36551.02  
**Лучшее распределение:** Логнормальное, так как оно имеет более низкие значения для Колмогоров-Смирнова, Крамер-вон Мисеса, Андрессона-Дарлинга, AIC и BIC.

---

#### Операционный риск тип 4:

**Логнормальное распределение:**
- Колмогоров-Смирнов: 0.0394907
- Крамер-вон Мисес: 0.5633883
- Андрессон-Дарлинг: 4.0527426
- Критерий информации Акаике (AIC): 35258.06
- Критерий Байесовской информации (BIC): 35268.48.

**Вейбулл:**
- Колмогоров-Смирнов: 0.07744793
- Крамер-вон Мисес: 1.87862934
- Андрессон-Дарлинг: 14.55892202
- Критерий информации Акаике (AIC): 35467.93
- Критерий Байесовской информации (BIC): 35478.35  
**Лучшее распределение:** Логнормальное, так как оно имеет более низкие значения для всех статистик тестов (KS, CvM, AD, AIC и BIC).
```v
```{r}
# Создание сводной таблицы для наилучших распределений
best_fit_summary <- data.frame(
  `Тип OR` = c("Тип 1", "Лучшее распределение: Вейбулл", 
               "Тип 2", "Лучшее распределение: Вейбулл", 
               "Тип 3", "Лучшее распределение: Логнормальное", 
               "Тип 4", "Лучшее распределение: Логнормальное"),
  
  `K-S` = c("", "0.0234 (Вейбулл) < 0.0505 (Логнормальное)", 
            "", "0.0280 (Вейбулл) < 0.0613 (Логнормальное)", 
            "", "0.0185 (Логнормальное) < 0.0726 (Вейбулл)", 
            "", "0.0395 (Логнормальное) < 0.0774 (Вейбулл)"),
  
  `C-M` = c("", "0.190 (Вейбулл) < 1.340 (Логнормальное)", 
            "", "0.2808 (Вейбулл) < 1.8016 (Логнормальное)", 
            "", "0.0960 (Логнормальное) < 2.6129 (Вейбулл)", 
            "", "0.5634 (Логнормальное) < 1.8786 (Вейбулл)"),
  
  `A-D` = c("", "1.319 (Вейбулл) < 8.601 (Логнормальное)", 
            "", "1.783 (Вейбулл) < 12.065 (Логнормальное)", 
            "", "0.609 (Логнормальное) < 18.6506 (Вейбулл)", 
            "", "4.0527 (Логнормальное) < 14.5589 (Вейбулл)"),
  
  `AIC` = c("", "36519.45 (Вейбулл) < 36638.32 (Логнормальное)", 
            "", "37753.40 (Вейбулл) < 37961.13 (Логнормальное)", 
            "", "36272.99 (Логнормальное) < 36540.56 (Вейбулл)", 
            "", "35258.06 (Логнормальное) < 35467.93 (Вейбулл)"),
  
  `BIC` = c("", "36529.92 (Вейбулл) < 36648.79 (Логнормальное)", 
            "", "37763.91 (Вейбулл) < 37971.64 (Логнормальное)", 
            "", "36283.44 (Логнормальное) < 36551.02 (Вейбулл)", 
            "", "35268.48 (Логнормальное) < 35478.35 (Вейбулл)")
)

# Создание таблицы kable
kable(best_fit_summary, format = "markdown", digits = 5, 
      caption = "Лучшее распределение для каждого типа операционного риска")
```

```r
**Обнаружения:**
Операционный риск тип 1
Вейбулл имеет более низкие значения для K-S (0.0234 против 0.0505), CvM (0.190 против 1.340) и AD (1.319 против 8.601).
Вейбулл имеет более низкие значения для AIC (36519.45 против 36638.32) и BIC (36529.92 против 36648.79).
Лучшее распределение: Распределение Вейбулл

Операционный риск тип 2
Вейбулл имеет более низкие значения для K-S (0.0280 против 0.0613), CvM (0.2808 против 1.8016) и AD (1.783 против 12.065).
Вейбулл имеет более низкие значения для AIC (37753.40 против 37961.13) и BIC (37763.91 против 37971.64).
Лучшее распределение: Распределение Вейбулл

Операционный риск тип 3
Логнормальное распределение имеет значительно более низкие значения для K-S (0.0185 против 0.0726), CvM (0.0960 против 2.6129) и AD (0.609 против 18.6506).
Логнормальное распределение имеет более низкие значения для AIC (36272.99 против 36540.56) и BIC (36283.44 против 36551.02).
Лучшее распределение: Логнормальное распределение

Операционный риск тип 4
Логнормальное распределение имеет более низкие значения для K-S (0.0395 против 0.0774), CvM (0.5634 против 1.8786) и AD (4.0527 против 14.5589).
Логнормальное распределение имеет более низкие значения для AIC (35258.06 против 35467.93) и BIC (35268.48 против 35478.35).
Лучшее распределение: Логнормальное распределение

**Заключение:**
На основе вышеизложенного распределение Вейбулл выбрано для операционного риска типов 1 и 2, а распределение Логнормальное выбрано для операционного риска типов 3 и 4.
```

## Моделирование распределений

### Моделирование распределения Пуассона

Распределение Пуассона будет использовано для генерации частоты (количества)
событий операционного риска для всех 4 типов операционного риска.

#### Операционный риск тип 1


```{r}
# Расчет lambda или среднего значения операционных рисков в месяц
head(or_type1_bymonths)
lambda_or_type1_bymonths <- mean(or_type1_bymonths$Frequency_Monthly)
print(lambda_or_type1_bymonths)
```


```{r}
# Генерация распределения Пуассона для операционного риска типа 1
set.seed(123)
poisson_or_type1 <- rpois(n = 100000, 
                          lambda = lambda_or_type1_bymonths)
head(poisson_or_type1)
tail(poisson_or_type1)
```



#### Операционный риск тип 2



```{r}
# Вычисление лямбда или среднего значения операционных рисков в месяц
head(or_type2_bymonths)
lambda_or_type2_bymonths <- mean(or_type2_bymonths$Frequency_Monthly)
print(lambda_or_type2_bymonths)
```


```{r}
# Генерация распределения Пуассона для операционного риска типа 2
set.seed(456)
poisson_or_type2 <- rpois(n = 100000, 
                          lambda = lambda_or_type2_bymonths)
head(poisson_or_type2)
tail(poisson_or_type2)
```



#### Операционный риск тип 3



```{r}
# Расчет lambda или среднего значения операционных рисков в месяц
head(or_type3_bymonths)
lambda_or_type3_bymonths <- mean(or_type3_bymonths$Frequency_Monthly)
print(lambda_or_type3_bymonths)
```


```{r}
# Генерация распределения Пуассона для операционного риска типа 3
set.seed(789)
poisson_or_type3 <- rpois(n = 100000, 
                          lambda = lambda_or_type3_bymonths)
head(poisson_or_type3)
tail(poisson_or_type3)
```



#### Операционный риск тип 4



```{r}
# Расчет лямбда или среднего значения операционных рисков в месяц для типа 4
head(or_type4_bymonths)
lambda_or_type4_bymonths <- mean(or_type4_bymonths$Frequency_Monthly)
print(lambda_or_type4_bymonths)
```


```{r}
# Генерация распределения Пуассона для операционного риска типа 4
set.seed(012)
poisson_or_type4 <- rpois(n = 100000, 
                          lambda = lambda_or_type4_bymonths)
head(poisson_or_type4)
tail(poisson_or_type4)

```


### Моделирование распределения Вейбулла

Распределение Вейбулла будет использоваться для генерации величин (воздействие/серьезность) событий операционного риска для типов операционных рисков 1 и 2.

#### Операционный риск тип 1




```{r warning=FALSE}
# Оценка параметров формы и масштаба (подгонка распределения Вейбулла) для операционного риска Тип 1
fit_weibull_type1 <- fitdist(or_type1_kzt$Loss_kzt, "weibull")
# Получение оцененных параметров
shape_or_type1 <- fit_weibull_type1$estimate["shape"]
scale_or_type1 <- fit_weibull_type1$estimate["scale"]
```


```{r}
# Генерация распределения Вейбулла с оцененными параметрами для операционного риска Тип 1
set.seed(123)
weibull_or_type1 <- rweibull(n = 100000, 
                             shape = shape_or_type1, 
                             scale = scale_or_type1)
# Просмотр первых сгенерированных значений
head(weibull_or_type1)
```




#### Операционный риск тип 2




```{r warning=FALSE}
# Оценка параметров формы и масштаба (подгонка распределения Вейбулла) для операционного риска Тип 2
fit_weibull_type2 <- fitdist(or_type2_kzt$Loss_kzt, "weibull")
# Получение оцененных параметров
shape_or_type2 <- fit_weibull_type2$estimate["shape"]
scale_or_type2 <- fit_weibull_type2$estimate["scale"]
```



```{r}
# Генерация распределения Вейбулла с оцененными параметрами для операционного риска Тип 2
set.seed(456)
weibull_or_type2 <- rweibull(n = 100000, 
                             shape = shape_or_type2, 
                             scale = scale_or_type2)
# Просмотр первых нескольких сгенерированных значений
head(weibull_or_type2)
```



### Моделирование распределения Логнормальное

Лог-Нормальное распределение будет использоваться для генерации величин (воздействие/тяжесть) операционных рисков для Типов 3 и 4 операционных рисков.

#### Операционный риск тип 3




```{r warning=FALSE}
# Оценка параметров meanlog и sdlog (подгонка Лог-Нормального распределения) для Операционного Риска Тип 3
fit_lnorm_type3 <- fitdist(or_type3_kzt$Loss_kzt, "lnorm")
# Получение оцененных параметров
meanlog_type3 <- fit_lnorm_type3$estimate["meanlog"]
sdlog_type3 <- fit_lnorm_type3$estimate["sdlog"]
```



```{r}
# Генерация Лог-Нормального распределения с оцененными параметрами для Операционного Риска Тип 3
set.seed(789)
lnorm_or_type3 <- rlnorm(n = 100000, 
                         meanlog = meanlog_type3, 
                         sdlog = sdlog_type3)
# Просмотр первых нескольких сгенерированных значений
head(lnorm_or_type3)
```




#### Операционный риск тип 4




```{r warning=FALSE}
# Оценка параметров meanlog и sdlog (подгонка Лог-Нормального распределения) для Операционного Риска Тип 4
fit_lnorm_type4 <- fitdist(or_type4_kzt$Loss_kzt, "lnorm")
# Получение оцененных параметров
meanlog_type4 <- fit_lnorm_type4$estimate["meanlog"]
sdlog_type4 <- fit_lnorm_type4$estimate["sdlog"]
```


```{r}
# Генерация Лог-Нормального распределения с оцененными параметрами для Операционного Риска Тип 4
set.seed(012)
lnorm_or_type4 <- rlnorm(n = 100000, 
                         meanlog = meanlog_type4, 
                         sdlog = sdlog_type4)
# Просмотр первых сгенерированных значений
head(lnorm_or_type4)
```



## Операционный риск: Вычисление стоимости под риском (Value-at-Risk)

### Предварительная обработка данных

Создание объединенной таблицы для всех сгенерированных распределений (Пуассона, Вейбулла и Логнормального) для всех типов операционных рисков.




```{r}
# Создание объединенной таблицы
generated_data <- data.frame(Poisson_OR_Type1 = poisson_or_type1, 
                             Poisson_OR_Type2 = poisson_or_type2,
                             Poisson_OR_Type3 = poisson_or_type3, 
                             Poisson_OR_Type4 = poisson_or_type4,
                             Weibull_OR_Type1 = weibull_or_type1, 
                             Weibull_OR_Type2 = weibull_or_type2,
                             Lognorm_OR_Type3 = lnorm_or_type3, 
                             Lognorm_OR_Type4 = lnorm_or_type4)
```


```{r}
# Проверка данных в таблице
head(generated_data)
tail(generated_data)
```


**Обнаружения:** Все переменные имеют 100000 наблюдений с правильными типами данных.

Умножение (произведение) частоты (количества) потерь операционного риска и величин (влияния/тяжести) потерь операционного риска для каждого типа операционного риска и расчет общих потерь операционного риска.


```{r}
generated_data$OR_Loss_Type1 <- generated_data$Poisson_OR_Type1 * generated_data$Weibull_OR_Type1
generated_data$OR_Loss_Type2 <- generated_data$Poisson_OR_Type2 * generated_data$Weibull_OR_Type2
generated_data$OR_Loss_Type3 <- generated_data$Poisson_OR_Type3 * generated_data$Lognorm_OR_Type3
generated_data$OR_Loss_Type4 <- generated_data$Poisson_OR_Type4 * generated_data$Lognorm_OR_Type4
generated_data$Total_OR_Losses <- generated_data$OR_Loss_Type1 + generated_data$OR_Loss_Type2 +
  generated_data$OR_Loss_Type3 + generated_data$OR_Loss_Type4
```


```{r}
# Проверка созданного дата-фрейма
summary(generated_data)
str(generated_data)
glimpse(generated_data)

```


### Визуализация сгенерированных распределений



#### Операционный риск тип 1


```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения убытков операционного риска Тип 1
ggplot(data = generated_data, aes(x = OR_Loss_Type1 / 1000)) +
  geom_histogram(binwidth = 1000, fill = "blue", 
                 color = "grey", alpha = 0.7) +
  labs(title = "Гистограмма убытков операционного риска Тип 1", 
       x = "Убытки операционного риска (тысячи KZT)", 
       y = "Частота") +
  theme_minimal()

```


```{r fig.align="center", fig.width=6, fig.height=4}
# Ящик с усами (boxplot) распределения убытков операционного риска Тип 1
ggplot(data = generated_data, aes(x = OR_Loss_Type1/1000)) +
  geom_boxplot(fill = "blue", 
               color = "black", alpha = 0.7) +
  labs(title = "Ящик с усами (boxplot) убытков операционного риска Тип 1", 
       x = "Убытки операционного риска (тысячи KZT)") +
  theme_minimal()
```
**Обнаружения:** Гистограмма и ящик с усами показывают наличие выбросов, что также подтверждается значительным различием между средним и медианой.


#### Операционный риск тип 2




```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения Операционного Риска Тип 2
ggplot(data = generated_data, aes(x = OR_Loss_Type2/1000)) +
  geom_histogram(binwidth = 1000, fill = "green", 
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма Операционного Риска Тип 2", 
       x = "Убытки от Операционного Риска (Тысячи KZT)", y = "Частота") +
  theme_minimal()
```


```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения Операционного Риска Тип 2
ggplot(data = generated_data, aes(x = OR_Loss_Type2/1000)) +
  geom_boxplot(fill = "green", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот Операционного Риска Тип 2", 
       x = "Убытки от Операционного Риска (Тысячи KZT)") +
  theme_minimal()
```
**Обнаружения:** Гистограмма и боксплот показывают наличие выбросов, что также подтверждается значительным различием между средним и медианой.

#### Операционный риск тип 3




```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения Операционного Риска Тип 3
ggplot(data = generated_data, aes(x = OR_Loss_Type3/1000)) +
  geom_histogram(binwidth = 1000, 
                 fill = "red", color = "black", alpha = 0.7) +
  labs(title = "Гистограмма Операционного Риска Тип 3", 
       x = "Убытки от Операционного Риска (Тысячи KZT)", y = "Частота") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_minimal()
```


```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения убытков от Операционного Риска Тип 3
ggplot(data = generated_data, aes(x = OR_Loss_Type3/1000)) +
  geom_boxplot(fill = "blue", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот убытков от Операционного Риска Тип 3", 
       x = "Убытки от Операционного Риска (Тысячи KZT)") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_minimal()
```
**Обнаружения:** Гистограмма и боксплот показывают наличие выбросов, что также подтверждается значительной разницей между средним и медианой.

#### Операционный риск тип 4


```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения убытков по операционному риску Тип 4
ggplot(data = generated_data, aes(x = OR_Loss_Type4/1000)) +
  geom_histogram(binwidth = 1000, fill = "skyblue", 
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма убытков операционного риска Тип 4", 
       x = "Убытки от операционного риска (KZT)", y = "Частота") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_minimal()
```


```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения убытков операционного риска Тип 4
ggplot(data = generated_data, aes(x = OR_Loss_Type4/1000)) +
  geom_boxplot(fill = "skyblue", 
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот убытков операционного риска Тип 4", 
       x = "Убытки от операционного риска (Тысячи KZT)") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_minimal()
```
**Обнаружения:** Гистограмма и боксплот показывают наличие выбросов, что также подтверждается значительным различием между средним и медианой.

### Общие убытки от операционного риска



```{r fig.align="center", fig.width=6, fig.height=4}
# Гистограмма распределения совокупных операционных убытков
ggplot(data = generated_data, aes(x = Total_OR_Losses/1000)) +
  geom_histogram(binwidth = 4000, fill = "yellow",
                 color = "black", alpha = 0.7) +
  labs(title = "Гистограмма совокупных операционных убытков",
       x = "Операционные убытки (тысячи KZT)", y = "Частота") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_minimal()
```


```{r fig.align="center", fig.width=6, fig.height=4}
# Боксплот распределения совокупных операционных убытков
ggplot(data = generated_data, aes(x = Total_OR_Losses/1000)) +
  geom_boxplot(fill = "yellow",
               color = "black", alpha = 0.7) +
  labs(title = "Боксплот совокупных операционных убытков", 
       x = "Операционные убытки (тысячи KZT)") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_minimal()
```
**Обнаружения:** Гистограмма и боксплот показывают наличие выбросов, что также подтверждается значительной разницей между средним и медианным значениями.

## Расчет стоимости под риском (Value-at-Risk (VaR)) для операционных рисков

Стоимость под риском (Value-at-Risk (VaR)) для операционных рисков рассчитывается для уровней доверия: 75%, 95%, 99% и 99.9%.




```{r}
# Вычисление Value-at-Risk для операционных рисков
probs <- c(0.75, 0.95, 0.99, 0.999)
or_var <- quantile(generated_data$Total_OR_Losses, probs)
print(or_var)
```


```{r}
# Преобразование данных в data frame и изменение названия столбца
or_var <- as.data.frame(or_var)
colnames(or_var) <- "var_monthly"
head(or_var)
```


Расчет месячного Ожидаемого Убытка (среднее), Ожидаемого Убытка (медиана), Неожиданного Убытка (среднее) и Неожиданного Убытка (медиана), а также расчет годового Значение-риска путем умножения месячного Значение-риска (VaR) на квадратный корень из 12. Кроме того, расчет годового Ожидаемого Убытка (среднее), Ожидаемого Убытка (медиана), Неожиданного Убытка (среднее) и Неожиданного Убытка (медиана).


```{r}
# Выполнение расчета
or_var$EL_mean_monthly <- mean(generated_data$Total_OR_Losses)
or_var$EL_median_monthly <- median(generated_data$Total_OR_Losses)
or_var$UL_mean_monthly <- or_var$var_monthly - or_var$EL_mean_monthly
or_var$UL_median_monthly <- or_var$var_monthly - or_var$EL_median_monthly
or_var$var_quarterly <- or_var$var_monthly * sqrt(3)
or_var$EL_mean_quarterly <- or_var$EL_mean_monthly * 3
or_var$EL_median_quarterly <- or_var$EL_median_monthly * 3
or_var$UL_mean_quarterly <- or_var$var_quarterly - or_var$EL_mean_quarterly
or_var$UL_median_quarterly <- or_var$var_quarterly - or_var$EL_median_quarterly
or_var$var_yearly <- or_var$var_monthly * sqrt(12)
or_var$EL_mean_yearly <- or_var$EL_mean_monthly * 12
or_var$EL_median_yearly <- or_var$EL_median_monthly * 12
or_var$UL_mean_yearly <- or_var$var_yearly - or_var$EL_mean_yearly
or_var$UL_median_yearly <- or_var$var_yearly - or_var$EL_median_yearly
```


```{r}
# Проверка вычисления стоимости под риском (VaR) операционного риска в датафрейме
print(or_var)
or_var <- t(or_var)
print(or_var)
```
# Прогнозирование сценариев (стресс-тестирование операционного риска)
Прогнозирование сценариев будет проведено для 2 сценариев: положительного и отрицательного. Прогноз убытков от операционного риска будет взят как среднее значение прогнозов двух подходов моделирования: регрессионной модели и модели исторического моделирования. Эта методология описана и используется в методологии стресс-тестирования надзорного органа Федеральной резервной системы (стресс-тест по Закону Додда-Франка). Согласно этой методологии, регрессионная модель отражает чувствительность убытков от операционного риска к изменениям в макроэкономической среде, а модель исторического моделирования отражает вариации убытков от операционного риска по типам событий операционного риска.

### Таблица сводки стресс-тестирования операционного риска
```{r}
# Создание сводного датафрейма для результатов стресс-тестирования 
# с иерархическими и уникальными названиями строк
stresstest_summary <- data.frame(
  Сценарий = c("Позитивный сценарий", "2017 Q1 - Позитивный ", 
               "2017 Q2 - Позитивный", "2017 Q3 - Позитивный", 
               "2017 Q4 - Позитивный", "Негативный сценарий", 
               "2017 Q1 - Негативный", "2017 Q2 - Негативный", 
               "2017 Q3 - Негативный", "2017 Q4 - Негативный"),
  `Линейная` = c("KZT", 46228220, 43127346, 
                 39583768, 36771242, 
                 "KZT", 52068502, 52890742, 
                 54506252, 54684134),
  `GAM` = c("KZT", 25739693, 26743844, 
            27772016, 27999022, 
            "KZT", 63592518, 63303944, 
            62478167, 61240187),
  `LDA` = c("KZT", 45657995, 45657995, 
            45657995, 45657995, 
            "KZT", 91139796, 91139796, 
            91139796, 91139796),
  `Среднее (Линейная & LDA)` = c("KZT", 
                                 round(rowMeans(cbind(46228220, 45657995))), 
                                 round(rowMeans(cbind(43127346, 45657995))), 
                                 round(rowMeans(cbind(39583768, 45657995))), 
                                 round(rowMeans(cbind(36771242, 45657995))), 
                                 "KZT", 
                                 round(rowMeans(cbind(52068502, 91139796))), 
                                 round(rowMeans(cbind(52890742, 91139796))), 
                                 round(rowMeans(cbind(54506252, 91139796))), 
                                 round(rowMeans(cbind(54684134, 91139796)))),
  `Среднее (GAM & LDA)` = c("KZT", 
                            round(rowMeans(cbind(25739693, 45657995))), 
                            round(rowMeans(cbind(26743844, 45657995))), 
                            round(rowMeans(cbind(27772016, 45657995))), 
                            round(rowMeans(cbind(27999022, 45657995))), 
                            "KZT", 
                            round(rowMeans(cbind(63592518, 91139796))), 
                            round(rowMeans(cbind(63303944, 91139796))), 
                            round(rowMeans(cbind(62478167, 91139796))), 
                            round(rowMeans(cbind(61240187, 91139796)))),
  `Пуассона` = c("QTY", 568, 999, 
                1760, 3101, 
                "QTY", 162, 139, 
                126, 115)
)

kable(stresstest_summary, format = "markdown", digits = 0, 
      caption = "Сводка стресс-тестирования для операционного риска")

```

### Итоговый вывод
Стресс-тестирование операционного риска проводилось с использованием следующих подходов:

Прогнозирование серьезности убытков (Severity): для прогнозирования величины потерь использовались множественная линейная регрессия (MLR) и обобщённая аддитивная модель (GAM).

Прогнозирование частоты событий (Frequency): для оценки частоты (количества) событий операционного риска применялась множественная регрессия Пуассона. 
В качестве критериев оценки использовались статистический порог R^2 = 0.35 (35%) и уровень значимости альфа = 0.1 (доверие 90%).

Оценка Value-at-Risk (VaR): для оценки Value-at-Risk по операционному риску использовалась симуляция Монте-Карло на уровнях доверия 95%, 99% и 99.9%.

**Оптимальная модель для прогнозирования серьезности убытков**

Оптимальная модель была выбрана из 1,330 возможных комбинаций независимых макроэкономических переменных на основе наивысшего значения R^2 (коэффициента детерминации) и статистических тестов. Наиболее эффективная модель для прогнозирования величины (серьезности) убытков от операционного риска была определена с использованием следующих независимых переменных из набора данных пакета "AFR":

GDD_Trn_R_y: Реальный валовой добавленный продукт для транспорта

GDD_Inf_R_y: Реальный валовой добавленный продукт для информации

Rincpop_q_y: Реальный средний месячный доход на душу населения

Зависимой переменной являлась доля общих убытков от операционного риска в активах банка "X", которые принимались за общие активы банковской системы.

**Частота потерь**

Для оценки частоты потерь была использована множественная регрессия Пуассона. Результаты показали, что множественная регрессия Пуассона обеспечила разумные предсказания, при этом множественная регрессия с отрицательным биномиальным распределением показала схожие результаты. В качестве статистического порога был установлен уровень R^2 на 0.35 (35%) и уровень значимости альфа на 0.1 (90% доверие).

Лучшая модель для прогнозирования частоты потерь была определена с использованием множественной регрессии Пуассона с следующими независимыми переменными:

- ruktzt: курс обмена RUB/KZT
- Rincpop_q_y: реальный средний месячный доход на душу населения
- GDD_R_y: реальный валовый добавленный продукт

Зависимой переменной была общая частота потерь операционного риска для банка "X". Псевдозначение R^2 для этой модели составило 0.48 (r2ML, r2CU), при этом все p-значения были ниже порога 0.1. Таким образом, нулевая гипотеза (H0) была отвергнута в пользу альтернативной гипотезы (Ha), что подтверждает корреляцию между частотой потерь операционного риска и макроэкономическими переменными.


**Анализ корреляции**

Во всех моделях была зафиксирована отрицательная корреляция между независимыми и зависимыми переменными.

**Прогнозируемые результаты**

**Множественная линейная регрессия (Тяжесть потерь)**

**Позитивный сценарий:**

- Наибольший убыток: KZT 46,228,220
- Наименьший убыток: KZT 36,771,242

**Негативный сценарий:**

- Наибольший убыток: KZT 54,684,134
- Наименьший убыток: KZT 52,068,502

**Обобщенная аддитивная модель (Тяжесть потерь)**

**Позитивный сценарий:**

- Наибольший убыток: KZT 27,999,022
- Наименьший убыток: KZT 25,739,693

**Негативный сценарий:**

- Наибольший убыток: KZT 63,592,518
- Наименьший убыток: KZT 61,240,187

**Множественная регрессия Пуассона (Частота потерь)**

**Позитивный сценарий:**

- Наибольшая частота: 3,101
- Наименьшая частота: 568

**Негативный сценарий:**

- Наибольшая частота: 162
- Наименьшая частота: 115

**Модель исторической симуляции**

**Вычисление стоимости под риском (VaR) операционного риска**
Стоимость под риском операционного риска (VaR) была вычислена с использованием распределения Пуассона для моделирования частоты (количества) событий операционного риска и распределений Вейбулла и логнормального распределения для моделирования тяжести (влияния) событий операционного риска. Эти распределения были выбраны на основе результатов статистической оценки.

**Ежемесячные ожидаемые потери (EL)**
Ожидаемые потери (EL), представляющие математическое ожидание, составили KZT 13,512,161 для среднего значения и KZT 12,173,884 для медианного значения. Эти значения оставались постоянными на всех уровнях доверия (75%, 95%, 99% и 99.9%).

**Ежемесячная стоимость под риском операционного риска (VaR)**
- На уровне доверия 95% ежемесячный VaR составил KZT 26,360,656, с непредвиденными потерями (UL) KZT 12,848,494 для среднего значения и KZT 14,186,771 для медианного значения.
- На уровне доверия 99% ежемесячный VaR увеличился до KZT 35,823,119, с непредвиденными потерями (UL) KZT 22,310,958 для среднего значения и KZT 23,649,235 для медианного значения.
- На уровне доверия 99.9% ежемесячный VaR составил KZT 52,619,586, с непредвиденными потерями (UL) KZT 39,107,424 для среднего значения и KZT 40,445,701 для медианного значения.

**Ежеквартальные ожидаемые потери (EL)**
Ожидаемые потери (EL) были масштабированы линейно во времени путем умножения ежемесячных EL на 3. В результате ежеквартальные EL составили KZT 40,536,484 для среднего значения и KZT 36,521,653 для медианного значения, оставаясь одинаковыми на всех уровнях доверия.

**Ежеквартальная стоимость под риском операционного риска (VaR)**
Ежеквартальный VaR был вычислен путем умножения ежемесячного VaR на квадратный корень из 3.

- На уровне доверия 95% ежеквартальный VaR составил KZT 45,657,995, с непредвиденными потерями (UL) KZT 5,121,511 для среднего значения и KZT 9,136,341 для медианного значения.
- На уровне доверия 99% ежеквартальный VaR увеличился до KZT 62,047,463, с непредвиденными потерями (UL) KZT 21,510,979 для среднего значения и KZT 25,525,810 для медианного значения.
- На уровне доверия 99.9% ежеквартальный VaR составил KZT 91,139,796, с непредвиденными потерями (UL) KZT 50,603,312 для среднего значения и KZT 54,618,143 для медианного значения.

**Оценки потерь операционного риска**
Окончательные оценки потерь операционного риска были получены как среднее значение прогнозов двух подходов моделирования: 1) Регрессионная модель и 2) Модель исторической симуляции, и следующие:


#### Среднее значение Множественной линейной регрессии (Тяжесть потерь) и Монте-Карло симуляции (уровни доверия 95% и 99.9%)

**Позитивный сценарий:**

- Наибольший убыток: KZT 45,943,965
- Наименьший убыток: KZT 41,214,107

**Негативный сценарий:**

- Наибольший убыток: KZT 72,911,965
- Наименьший убыток: KZT 71,604,149

#### Среднее значение Обобщенной аддитивной модели (Тяжесть потерь) и Монте-Карло симуляции (уровни доверия 95% и 99.9%)

**Позитивный сценарий:**

- Наибольший убыток: KZT 36,828,508
- Наименьший убыток: KZT 35,698,844

**Негативный сценарий:**

- Наибольший убыток: KZT 77,366,157
- Наименьший убыток: KZT 76,189,991

## Заключительные выводы

Результаты данного стресс-тестирования следует интерпретировать с осторожностью, так как некоторые предположения моделирования, такие как линейность и нормальность в регрессионных моделях, не были полностью выполнены. Тем не менее, несмотря на эти ограничения, результаты предоставляют значимые выводы о взаимосвязи между потерями операционного риска и макроэкономическими переменными, что способствует усилиям по оценке рисков и их смягчению.
